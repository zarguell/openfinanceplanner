# Milestone v1.0: Maintainability Overhaul

**Status:** ✅ SHIPPED 2026-01-19
**Phases:** 1-6
**Total Plans:** 24

## Overview

Transform the codebase from monolithic files and manual processes into a maintainable, well-structured codebase with modern tooling. The journey starts by establishing quality tooling (ESLint, Prettier, Vitest), then systematically breaks down monolithic files (tax.js, AppController.js), centralizes configuration, and migrates tests. Each phase preserves backward compatibility and architectural strengths.

## Phases

### Phase 1: Quality Tooling Foundation

**Goal**: Establish modern development tooling for code quality and testing

**Depends on**: Nothing (first phase)

**Research**: Unlikely (standard tooling setup with established patterns)

**Plans**: 3 plans

Plans:

- [x] 01-01: Install and configure ESLint ✅
- [x] 01-02: Install and configure Prettier ✅
- [x] 01-03: Install and configure Vitest ✅

**Details:**

Added ESLint 9.x with flat config (not legacy .eslintrc.js), added separate Node.js globals for test files, deferred fixing all 343 ESLint issues to later phases (fix during refactoring), kept existing custom test runner until Phase 5 migration. Added Prettier for code formatting and Vitest as test framework.

---

### Phase 2: Tax Module Refactor

**Goal**: Split 2,296-line tax.js into focused modules by domain

**Depends on**: Phase 1 (quality tooling in place)

**Research**: Unlikely (internal refactoring, patterns exist in codebase)

**Plans**: 4 plans

Plans:

- [x] 02-01: Extract federal tax calculations to separate module ✅
- [x] 02-02: Extract state tax calculations by region ✅
- [x] 02-03: Extract tax bracket data to JSON config ✅
- [x] 02-04: Final validation and test verification ✅

**Details:**

Split 2,296-line tax.js into federal.js, states.js, and tax/config/ directory. Extracted state tax data to states-2024.js and states-2025.js. Maintained statutory rates in calculation files, user defaults in Plan model.

---

### Phase 3: UI Controller Refactor

**Goal**: Split 1,347-line AppController.js into focused components

**Depends on**: Phase 2 (tax refactor complete, patterns established)

**Research**: Unlikely (internal refactoring following established conventions)

**Plans**: 4 plans

Plans:

- [x] 03-01: Extract plan management logic to PlanController ✅
- [x] 03-02: Extract account management to AccountController ✅
- [x] 03-03: Extract expense and income management to ExpenseIncomeController ✅
- [x] 03-04: Refactor main AppController as coordinator (final coordinator pattern) ✅

**Details:**

Split 1,444-line AppController into PlanController, AccountController, ExpenseIncomeController, and ProjectionController. AppController reduced to 314 lines (78% reduction). Fixed duplicate method definitions bug. Kept AppController delegator methods for backward compatibility with window.app calls.

---

### Phase 4: Configuration Centralization

**Goal**: Extract 1,018+ hardcoded magic numbers to centralized config

**Depends on**: Phase 2 & 3 (refactored modules make extraction easier)

**Research**: Unlikely (config extraction is straightforward refactoring)

**Plans**: 4 plans

Plans:

- [x] 04-01: Extract tax bracket constants to config/tax-brackets.json ✅
- [x] 04-02: Extract contribution limits to config/limits.json ✅
- [x] 04-03: Extract default rates to config/defaults.json ✅
- [x] 04-04: Create config loader module and update imports ✅

**Details:**

Extracted 1,018+ magic numbers to limits.json, ages.json, and defaults.json. Created accessor functions (getContributionLimit, getRMDStartAge, getDefaultTaxRate, etc.). Used embedded data objects in loader.js for ES6 compatibility (no build process). Strategy-specific defaults kept in Plan model.

---

### Phase 5: Test Migration

**Goal**: Migrate custom test runner to Vitest framework

**Depends on**: Phase 1 (Vitest installed), Phase 2-4 (refactored code easier to test)

**Research**: Likely (Vitest migration patterns, ES6 module testing)

**Research topics**: Vitest configuration for ES6 modules without bundler, migration patterns from custom assertions

**Plans**: 3 plans

Plans:

- [x] 05-01: Migrate unit tests to Vitest format ✅
- [x] 05-02: Migrate integration tests to Vitest ✅
- [x] 05-03: Add coverage reporting and CI hooks ✅

**Details:**

Migrated 27 test files, 308 tests successfully to Vitest. Added coverage reporting with @vitest/coverage-v8. Configured 4 reporters: text, json, html, lcov. Set coverage thresholds at 50% (below current 57% to prevent regression). Created GitHub Actions CI workflow for automated testing. ESLint errors in UI files deferred (193 errors - browser globals not configured).

---

### Phase 6: Validation & Polish

**Goal**: Verify all functionality works and fix issues

**Depends on**: Phase 5 (all refactoring and migration complete)

**Research**: Unlikely (verification and bug fixes using established patterns)

**Plans**: 6 plans (3 original + 3 gap closure)

**Status**: Complete (2026-01-19)

Plans:

- [x] 06-01: Run full test suite and fix failures ✅
- [x] 06-02: Manual testing of UI workflows ✅
- [x] 06-03: Update documentation and clean up ✅
- [x] 06-04: Fix ESLint browser globals for all source files (gap closure) ✅
- [x] 06-05: Fix no-case-declarations errors (gap closure) ✅
- [x] 06-06: Execute manual testing and correct documentation (gap closure) ✅

**Details:**

Resolved 193 ESLint browser globals errors for UI files (Phase 6-01). Fixed 31 no-undef errors for console/localStorage in storage/rules/calculations/core files (gap closure plans 06-04, 06-05). Fixed 5 no-case-declarations errors in roth-conversions.js (06-05). All 224 ESLint errors resolved (zero errors remaining). Created comprehensive CLAUDE.md for future AI assistant sessions. All functionality verified working via manual testing.

---

## Milestone Summary

**Decimal Phases:**

None

**Key Decisions:**

- Use ESLint 9.x flat config (not legacy .eslintrc.js) - Standard modern approach
- Add separate Node.js globals for test files - Clean separation of environments
- Defer fixing ESLint issues to Phase 2-4 (fix during refactoring) - Efficiency: fix as we touch code
- Keep existing custom test runner until Phase 5 migration - Incremental migration
- Keep AppController delegator methods for backward compatibility with window.app calls - No breaking changes
- Use embedded data objects in loader.js for ES6 compatibility (no build process) - Zero-build constraint
- Strategy-specific defaults (Roth conversion %, QCD %, employer match rate) kept in Plan model - Domain-specific values in domain layer
- Statutory tax rates (long-term capital gains 0.15, Medicare rates) kept in calculation files, not in config - Regulatory data in calculations
- Use @vitest/coverage-v8 (v8 provider) for faster coverage reports - Performance choice
- Set coverage thresholds at 50% (below current 57% to prevent regression) - Realistic baseline
- Use globals npm package for browser environment configuration - ESLint 9.x best practice
- Create comprehensive CLAUDE.md for future AI assistant sessions - Long-term maintainability

**Issues Resolved:**

- Monolithic files (tax.js 2,296 lines, AppController.js 1,444 lines) - Split into focused modules
- Hardcoded values (1,018+ magic numbers) - Centralized in configuration system
- No linting/formatting tooling - Added ESLint 9, Prettier
- No testing framework - Migrated to Vitest with 308 tests passing
- ESLint errors (224 total) - All resolved through Phase 6-01 and gap closure plans
- Test quality (no CI/coverage) - Added GitHub Actions CI with 57.93% coverage

**Issues Deferred:**

- Increase test coverage in storage and UI modules - Optional future enhancement
- Add tests for monte-carlo.js (currently 0% coverage) - Optional future enhancement
- Raise coverage thresholds as baseline improves - Incremental improvement path

**Technical Debt Incurred:**

- Duplicate method escapeHtml() in both AppController and PlanController - Acceptable for convenience
- Deferred ESLint fixes until refactoring phases - Paid off in Phase 6
- No TypeScript migration yet - Deferred to future milestone

**Stats:**

- 266 files created/modified
- 14,258 lines of JavaScript (src directory)
- 27 test files, 308 tests passing
- 57.93% test coverage (statements)
- 0 ESLint errors (224 resolved)
- 6 phases, 24 plans, ~2 hours execution time
- 8 days (2026-01-12 → 2026-01-19)

---

_For current project status, see .planning/ROADMAP.md_
