---
phase: 13-architecture-testing-foundation
plan: 03
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - vitest.config.ts
  - package.json
  - src/test/setup.ts
  - src/core/utils/example.test.ts
autonomous: true

must_haves:
  truths:
    - "npm run test runs Vitest with global test APIs available"
    - "npm run test:coverage generates coverage report with v8 provider"
    - "Test utilities are available via src/test/setup.ts"
    - "Example test demonstrates TDD workflow foundation"
    - "Vitest uses jsdom environment for future React component testing"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration with globals and coverage"
      contains: ["globals: true", "environment: 'jsdom'", "provider: 'v8'"]
    - path: "src/test/setup.ts"
      provides: "Test setup file with global cleanup and utilities"
      exports: ["testUtils"]
    - path: "package.json"
      provides: "Test scripts and Vitest dependencies"
      contains: ["\"vitest\"", "\"test\"", "\"test:coverage\""]
  key_links:
    - from: "vitest.config.ts"
      to: "vite.config.ts"
      via: "shared Vite configuration"
      pattern: "defineConfig.*test"
    - from: "*.test.ts"
      to: "src/test/setup.ts"
      via: "setupFiles configuration"
      pattern: "setupFiles.*setup.ts"
---

<objective>
Set up Vitest with coverage reporting, test utilities, and TDD workflow foundation for Phase 14 business logic testing.

Purpose: Establishes the test infrastructure required for TDD development of the Core Financial Engine in Phase 14. Vitest provides fast, Vite-native testing with TypeScript support out of the box.

Output: Working test command, coverage reporting, test setup file, and example test demonstrating the infrastructure is ready.
</objective>

<execution_context>
@/Users/zach/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zach/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/13-architecture-testing-foundation/13-RESEARCH.md
@.planning/phases/13-architecture-testing-foundation/13-01-SUMMARY.md

Research reference: Pattern 4 (Vitest configuration), Pattern 6 (Test utilities), Common Pitfalls (Vitest not finding tests).
</context>

<tasks>

<task type="auto">
  <name>Install Vitest and coverage dependencies</name>
  <files>
    package.json
    pnpm-lock.yaml
  </files>
  <action>
    Install Vitest with coverage provider and test utilities:

    ```bash
    npm install -D vitest @vitest/coverage-v8 @vitest/ui jsdom
    ```

    Package breakdown:
    - vitest - Test framework (Vite-native, Jest-compatible)
    - @vitest/coverage-v8 - Fast coverage provider using V8 (alternative: istanbul)
    - @vitest/ui - Optional visual test runner UI (better debugging)
    - jsdom - DOM environment for React component testing (future phases)

    DO NOT install Jest (research indicates Vitest is superior for Vite projects).
  </action>
  <verify>
    ```bash
    grep -E '"vitest"|"@vitest' package.json
    ```
    All Vitest packages should be in devDependencies.
  </verify>
  <done>
    vitest, @vitest/coverage-v8, @vitest/ui, and jsdom installed in devDependencies.
  </done>
</task>

<task type="auto">
  <name>Create Vitest configuration</name>
  <files>
    vitest.config.ts
  </files>
  <action>
    Create vitest.config.ts in project root:

    ```typescript
    import { defineConfig } from 'vitest/config'
    import react from '@vitejs/plugin-react'

    export default defineConfig({
      plugins: [react()],

      test: {
        globals: true,
        environment: 'jsdom',
        include: ['**/*.{test,spec}.{js,ts,jsx,tsx}'],
        exclude: ['node_modules', 'dist', 'build'],

        coverage: {
          provider: 'v8',
          reporter: ['text', 'json', 'html'],
          exclude: [
            'node_modules/',
            'src/test/',
            '**/*.test.{ts,tsx}',
            '**/*.spec.{ts,tsx}',
            '**/index.ts',
          ],
        },

        setupFiles: ['./src/test/setup.ts'],

        testTimeout: 5000,
        hookTimeout: 10000,
      },
    })
    ```

    Configuration details:
    - globals: true - Enable describe, it, expect without imports (Jest-compatible)
    - environment: 'jsdom' - DOM environment for future React testing
    - include - Match both .test. and .spec. file patterns
    - coverage.provider: 'v8' - Fast coverage provider
    - setupFiles - Global test setup (created in next task)

    DO NOT use 'istanbul' provider (v8 is faster and better integrated).
  </action>
  <verify>
    ```bash
    npx vitest run
    ```
    Should run successfully (with "No test files found" - that's expected at this point).
  </verify>
  <done>
    vitest.config.ts exists with globals, jsdom environment, v8 coverage provider, and setupFiles configured.
  </done>
</task>

<task type="auto">
  <name>Create test setup file with utilities</name>
  <files>
    src/test/setup.ts
  </files>
  <action>
    Create src/test directory and setup.ts file:

    ```bash
    mkdir -p src/test
    ```

    src/test/setup.ts:
    ```typescript
    import { afterEach, vi } from 'vitest'

    /**
     * Test setup file for Vitest.
     *
     * This file runs before each test file and provides:
     * - Global cleanup after each test
     * - Reusable test utilities
     *
     * Configure via setupFiles in vitest.config.ts
     */

    // Clear all mocks after each test to prevent state leakage
    afterEach(() => {
      vi.clearAllMocks()
    })

    // Reusable test utilities
    export const testUtils = {
      /**
       * Mock console.error to prevent test output pollution
       * Usage: testUtils.mockConsole()
       */
      mockConsole: () => {
        vi.spyOn(console, 'error').mockImplementation(() => {})
      },

      /**
       * Restore console.error after mocking
       */
      restoreConsole: () => {
        vi.restoreAllMocks()
      },
    }
    ```

    This setup file:
    - Prevents test state pollution with afterEach cleanup
    - Provides reusable utilities via testUtils export
    - Documents the setup file purpose for future developers

    DO NOT add React Testing Library here (that's Phase 16).
  </action>
  <verify>
    ```bash
    cat src/test/setup.ts
    ```
    File should exist with afterEach and testUtils defined.
  </verify>
  <done>
    src/test/setup.ts exists with global cleanup and testUtils object containing mockConsole/restoreConsole utilities.
  </done>
</task>

<task type="auto">
  <name>Add test scripts to package.json</name>
  <files>
    package.json
  </files>
  <action>
    Add test scripts to package.json scripts section:

    ```json
    "scripts": {
      "dev": "vite",
      "build": "tsc && vite build",
      "preview": "vite preview",
      "test": "vitest",
      "test:ui": "vitest --ui",
      "test:coverage": "vitest --coverage",
      "lint": "eslint .",
      "lint:fix": "eslint . --fix",
      "format": "prettier --write .",
      "format:check": "prettier --check .",
      "type-check": "tsc --noEmit"
    }
    ```

    Add test, test:ui, and test:coverage scripts.
    Keep existing scripts from previous plans (dev, build, preview, lint, format, type-check).

    DO NOT modify existing scripts.
  </action>
  <verify>
    ```bash
    npm run test -- --run
    ```
    Should run Vitest in single-run mode (watch mode disabled by --run flag).
  </verify>
  <done>
    package.json has test, test:ui, and test:coverage scripts. All test commands execute successfully.
  </done>
</task>

<task type="auto">
  <name>Create example test to verify infrastructure</name>
  <files>
    src/core/utils/example.test.ts
  </files>
  <action>
    Create src/core/utils/example.ts and example.test.ts:

    src/core/utils/example.ts:
    ```typescript
    /**
     * Example utility function to demonstrate test infrastructure.
     *
     * This file can be deleted after verifying tests work.
     * Phase 14 will replace this with actual financial calculation utilities.
     */

    export function add(a: number, b: number): number {
      return a + b
    }
    ```

    src/core/utils/example.test.ts:
    ```typescript
    import { describe, it, expect } from 'vitest'
    import { add } from './example'

    describe('add', () => {
      it('should add two positive numbers correctly', () => {
        expect(add(1, 2)).toBe(3)
      })

      it('should handle zero', () => {
        expect(add(0, 0)).toBe(0)
      })

      it('should handle negative numbers', () => {
        expect(add(-1, -2)).toBe(-3)
      })

      it('should handle mixed positive and negative', () => {
        expect(add(5, -3)).toBe(2)
      })
    })
    ```

    This example test:
    - Demonstrates global test APIs work (no imports needed for describe/it/expect)
    - Shows TDD workflow foundation (can write tests before implementation)
    - Validates Vitest configuration is correct
    - Uses pure TypeScript function (no React dependencies)

    Run the tests to verify everything works:
    ```bash
    npm run test -- --run
    ```
  </action>
  <verify>
    ```bash
    npm run test -- --run
    ```
    Should show 4 passing tests for the add function.
  </verify>
  <done>
    Example test file created and all tests pass. Test infrastructure verified working.
  </done>
</task>

<task type="auto">
  <name>Verify coverage reporting works</name>
  <files>
    coverage/index.html
    coverage/coverage-final.json
  </files>
  <action>
    Run coverage to verify the v8 provider works:

    ```bash
    npm run test:coverage
    ```

    This should:
    1. Run all tests
    2. Generate coverage report using v8 provider
    3. Create coverage/ directory with:
       - coverage/index.html - HTML coverage report
       - coverage/coverage-final.json - JSON coverage data
       - coverage/ - Text summary in terminal

    Verify the coverage directory was created and check the summary.
  </action>
  <verify>
    ```bash
    ls -la coverage/
    cat coverage/index.html | head -20
    ```
    coverage/ directory should exist with index.html and coverage-final.json.
  </verify>
  <done>
    npm run test:coverage completes successfully, coverage/ directory created with HTML and JSON reports.
  </done>
</task>

</tasks>

<verification>
Overall Phase 13 Verification (after all plans complete):

1. Run `npm run test` - verify Vitest runs in watch mode
2. Run `npm run test:coverage` - verify coverage report generates
3. Run `npm run test:ui` - verify UI mode works (opens browser)
4. Verify example tests pass (4 tests in src/core/utils/example.test.ts)
</verification>

<success_criteria>
1. `npm run test` runs Vitest with global test APIs (describe, it, expect available without imports)
2. `npm run test:ui` opens Vitest UI in browser
3. `npm run test:coverage` generates coverage report with v8 provider (not istanbul)
4. src/test/setup.ts exists and is configured via setupFiles in vitest.config.ts
5. Example test (src/core/utils/example.test.ts) passes all 4 tests
6. Test files use .test.ts or .spec.ts naming convention and are discovered by Vitest
7. jsdom environment is configured (for future React component testing)
</success_criteria>

<output>
After completion, create `.planning/phases/13-architecture-testing-foundation/13-03-SUMMARY.md` with:
- Vitest configuration details (globals, coverage provider, environment)
- Test utilities available in src/test/setup.ts
- Confirmation that example tests pass
- Coverage report configuration
</output>
