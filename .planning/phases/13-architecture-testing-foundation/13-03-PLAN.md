---
phase: 13-architecture-testing-foundation
plan: 03
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - vitest.config.ts
  - package.json
  - src/test/setup.ts
autonomous: true

must_haves:
  truths:
    - 'npm run test runs Vitest with global test APIs available'
    - 'Test utilities are available via src/test/setup.ts'
    - 'Vitest uses jsdom environment for future React component testing'
  artifacts:
    - path: 'vitest.config.ts'
      provides: 'Vitest configuration with globals and coverage'
      contains: ['globals: true', "environment: 'jsdom'", "provider: 'v8'"]
    - path: 'src/test/setup.ts'
      provides: 'Test setup file with global cleanup and utilities'
      exports: ['testUtils']
    - path: 'package.json'
      provides: 'Vitest dependencies'
      contains: ['"vitest"', '"@vitest/coverage-v8"', '"jsdom"']
  key_links:
    - from: 'vitest.config.ts'
      to: 'vite.config.ts'
      via: 'shared Vite configuration'
      pattern: 'defineConfig.*test'
    - from: '*.test.ts'
      to: 'src/test/setup.ts'
      via: 'setupFiles configuration'
      pattern: 'setupFiles.*setup.ts'
---

<objective>
Set up Vitest with jsdom environment, test utilities, and global test APIs for TDD workflow.

Purpose: Establishes the test infrastructure required for TDD development of the Core Financial Engine in Phase 14. Vitest provides fast, Vite-native testing with TypeScript support out of the box.

Output: Working test command with global APIs, test setup file with utilities, jsdom environment configured.
</objective>

<execution_context>
@/Users/zach/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zach/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/13-architecture-testing-foundation/13-RESEARCH.md
@.planning/phases/13-architecture-testing-foundation/13-01-SUMMARY.md

Research reference: Pattern 4 (Vitest configuration), Pattern 6 (Test utilities), Common Pitfalls (Vitest not finding tests).
</context>

<tasks>

<task type="auto">
  <name>Install Vitest and jsdom dependencies</name>
  <files>
    package.json
    pnpm-lock.yaml
  </files>
  <action>
    Install Vitest with coverage provider and jsdom environment:

    ```bash
    npm install -D vitest @vitest/coverage-v8 @vitest/ui jsdom
    ```

    Package breakdown:
    - vitest - Test framework (Vite-native, Jest-compatible)
    - @vitest/coverage-v8 - Fast coverage provider using V8 (alternative: istanbul)
    - @vitest/ui - Optional visual test runner UI (better debugging)
    - jsdom - DOM environment for React component testing (future phases)

    DO NOT install Jest (research indicates Vitest is superior for Vite projects).

  </action>
  <verify>
    ```bash
    grep -E '"vitest"|"@vitest' package.json
    ```
    All Vitest packages should be in devDependencies.
  </verify>
  <done>
    vitest, @vitest/coverage-v8, @vitest/ui, and jsdom installed in devDependencies.
  </done>
</task>

<task type="auto">
  <name>Create Vitest configuration</name>
  <files>
    vitest.config.ts
  </files>
  <action>
    Create vitest.config.ts in project root:

    ```typescript
    import { defineConfig } from 'vitest/config'
    import react from '@vitejs/plugin-react'

    export default defineConfig({
      plugins: [react()],

      test: {
        globals: true,
        environment: 'jsdom',
        include: ['**/*.{test,spec}.{js,ts,jsx,tsx}'],
        exclude: ['node_modules', 'dist', 'build'],

        coverage: {
          provider: 'v8',
          reporter: ['text', 'json', 'html'],
          exclude: [
            'node_modules/',
            'src/test/',
            '**/*.test.{ts,tsx}',
            '**/*.spec.{ts,tsx}',
            '**/index.ts',
          ],
        },

        setupFiles: ['./src/test/setup.ts'],

        testTimeout: 5000,
        hookTimeout: 10000,
      },
    })
    ```

    Configuration details:
    - globals: true - Enable describe, it, expect without imports (Jest-compatible)
    - environment: 'jsdom' - DOM environment for future React testing
    - include - Match both .test. and .spec. file patterns
    - coverage.provider: 'v8' - Fast coverage provider
    - setupFiles - Global test setup (created in next task)

    DO NOT use 'istanbul' provider (v8 is faster and better integrated).

  </action>
  <verify>
    ```bash
    npx vitest run
    ```
    Should run successfully (with "No test files found" - that's expected at this point).
  </verify>
  <done>
    vitest.config.ts exists with globals, jsdom environment, v8 coverage provider, and setupFiles configured.
  </done>
</task>

<task type="auto">
  <name>Create test setup file with utilities</name>
  <files>
    src/test/setup.ts
  </files>
  <action>
    Create src/test directory and setup.ts file:

    ```bash
    mkdir -p src/test
    ```

    src/test/setup.ts:
    ```typescript
    import { afterEach, vi } from 'vitest'

    /**
     * Test setup file for Vitest.
     *
     * This file runs before each test file and provides:
     * - Global cleanup after each test
     * - Reusable test utilities
     *
     * Configure via setupFiles in vitest.config.ts
     */

    // Clear all mocks after each test to prevent state leakage
    afterEach(() => {
      vi.clearAllMocks()
    })

    // Reusable test utilities
    export const testUtils = {
      /**
       * Mock console.error to prevent test output pollution
       * Usage: testUtils.mockConsole()
       */
      mockConsole: () => {
        vi.spyOn(console, 'error').mockImplementation(() => {})
      },

      /**
       * Restore console.error after mocking
       */
      restoreConsole: () => {
        vi.restoreAllMocks()
      },
    }
    ```

    This setup file:
    - Prevents test state pollution with afterEach cleanup
    - Provides reusable utilities via testUtils export
    - Documents the setup file purpose for future developers

    DO NOT add React Testing Library here (that's Phase 16).

  </action>
  <verify>
    ```bash
    cat src/test/setup.ts
    ```
    File should exist with afterEach and testUtils defined.
  </verify>
  <done>
    src/test/setup.ts exists with global cleanup and testUtils object containing mockConsole/restoreConsole utilities.
  </done>
</task>

</tasks>

<verification>
Overall Phase 13 Verification (after all plans complete):

1. Run `npm run test` - verify Vitest runs in watch mode
2. Verify global test APIs work (describe, it, expect available without imports)
3. Confirm jsdom environment is configured
   </verification>

<success_criteria>

1. `npm run test` runs Vitest with global test APIs (describe, it, expect available without imports)
2. vitest.config.ts exists with globals: true and environment: 'jsdom'
3. src/test/setup.ts exists and is configured via setupFiles in vitest.config.ts
4. Test files will use .test.ts or .spec.ts naming convention and be discovered by Vitest
   </success_criteria>

<output>
After completion, create `.planning/phases/13-architecture-testing-foundation/13-03-SUMMARY.md` with:
- Vitest configuration details (globals, coverage provider, environment)
- Test utilities available in src/test/setup.ts
- Confirmation that test infrastructure is ready for Phase 14
</output>
