---
phase: 04-config-centralization
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - config/
  - src/calculations/roth-conversions.js
  - src/ui/AppController.js
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "All configuration is centralized in config/ directory"
    - "All source files import from config, not hardcoded values"
    - "Config files are valid JSON and documented"
    - "Documentation updated to reflect config structure"
  artifacts:
    - path: "config/"
      provides: "Centralized configuration for all hardcoded values"
      contains: "limits.json, ages.json, defaults.json, loader.js"
    - path: "CLAUDE.md"
      provides: "Updated project documentation"
      contains: "Config directory structure and usage"
  key_links:
    - from: "src/ui/AppController.js"
      to: "config/loader.js"
      via: "import statements for config accessors"
      pattern: "import.*from.*config/loader"
---

<objective>
Complete configuration centralization by verifying all hardcoded values are extracted, updating any remaining files to use config, validating the config system, and updating documentation.

Purpose: Finalize Phase 4 by ensuring all magic numbers are centralized, the config system is complete and validated, and documentation reflects the new structure.

Output: Fully centralized configuration system with all hardcoded values extracted to config files, updated documentation, and validation that everything works correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-config-centralization/04-01-SUMMARY.md
@.planning/phases/04-config-centralization/04-02-SUMMARY.md
@.planning/phases/04-config-centralization/04-03-SUMMARY.md
@config/limits.json
@config/ages.json
@config/defaults.json
@config/loader.js
@src/ui/AppController.js
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scan for remaining hardcoded magic numbers</name>
  <files>src/calculations/</files>
  <action>
    Scan src/calculations/ directory for any remaining hardcoded values that should be in config:

    1. Check for hardcoded monetary values (multiplied by 100):
       ```bash
       grep -rn "const.*=.*\*[[:space:]]*100" src/calculations/ | grep -v "getConfig\|getContribution\|getQCD\|getLimit"
       ```

    2. Check for hardcoded decimal rates:
       ```bash
       grep -rn "const.*Rate.*=.*0\.[0-9]" src/calculations/ | grep -v "getConfig\|getDefault"
       ```

    3. Review each found value and determine:
       - Is it a tax code constant? (Leave in source code, add comment)
       - Is it a user default? (Should be in config/defaults.json)
       - Is it an example value? (Add comment noting it's an example)
       - Is it already in config? (Update file to use config accessor)

    4. For src/calculations/roth-conversions.js:
       - Find: `const bracketTop = 89450 * 100;`
       - Find: `const taxableIncome = 100000 * 100;`
       - These are example values for conversion optimization (as noted in 04-01 summary)
       - Action: Add prominent comments that these are EXAMPLE values only

    5. For any other hardcoded values found:
       - Document why they're hardcoded (tax code constant, example value, etc.)
       - Add explanatory comments
       - Only move to config if it's a true user-configurable default

    Expect to find mostly example values and tax code constants that should remain in source code with better documentation.
  </action>
  <verify>
    # Count remaining hardcoded monetary values (should be mostly examples)
    grep -rn "const.*=.*\*[[:space:]]*100" src/calculations/ | grep -v "getConfig\|getContribution\|getQCD\|getLimit\|//.*example\|//.*Example" | wc -l
  </verify>
  <done>All remaining hardcoded values documented or moved to config as appropriate</done>
</task>

<task type="auto">
  <name>Task 2: Verify config system completeness</name>
  <files>config/</files>
  <action>
    Validate that the config system is complete and functional:

    1. Verify all config files exist and are valid JSON:
       ```bash
       for file in config/*.json; do
         echo "Validating $file..."
         jq . "$file" > /dev/null && echo "✓ Valid" || echo "✗ Invalid"
       done
       ```

    2. Verify config/loader.js exports all expected functions:
       ```bash
       echo "Checking loader exports..."
       grep "^export function" config/loader.js | sort
       ```

       Expected exports:
       - getContributionLimit
       - getTotalContributionLimit
       - getQCDLimit
       - getRMDStartAge
       - getFullRetirementAge
       - getLifeExpectancyFactor
       - getDefaultInflationRate
       - getDefaultEquityGrowthRate
       - getDefaultBondGrowthRate
       - getDefaultVolatility
       - getDefaultTaxRate
       - getMedicareRates

    3. Verify config data consistency between JSON files and embedded data:
       - config/limits.json content matches limitsData in loader.js
       - config/ages.json content matches agesData in loader.js
       - config/defaults.json content matches defaultsData in loader.js

       Use diff to check:
       ```bash
       # Compare structure (not exact match due to formatting)
       jq -S . config/limits.json > /tmp/limits.json.sorted
       # (Manual check that structure matches loader.js limitsData)
       ```

    4. Create config/README.md documenting the config system:
       ```markdown
       # Configuration Files

       This directory contains centralized configuration for the Open Finance Planner.

       ## Files

       - `limits.json` - Retirement account contribution limits (401k, IRA, catch-up, QCD)
       - `ages.json` - Age-related thresholds (RMD age, Full Retirement Age table, life expectancy)
       - `defaults.json` - Default rates for growth, inflation, tax, and strategies
       - `loader.js` - ES6 module with accessor functions for all config data

       ## Usage

       Import from loader.js to access config values:

       \`\`\`javascript
       import { getContributionLimit, getDefaultInflationRate } from './config/loader.js';

       const limit = getContributionLimit('401k', 2025);
       const inflation = getDefaultInflationRate();
       \`\`\`

       ## Design Notes

       - Config data is embedded in loader.js for ES6 module compatibility
       - JSON files serve as documentation and can be used with a build system
       - Values in JSON are in readable format (dollars, decimals)
       - Loader functions convert to cents for monetary values
       - Pattern follows Phase 2 tax bracket extraction approach

       ## Updates

       When updating config values:
       1. Update the JSON file (documentation)
       2. Update the embedded data in loader.js (runtime)
       3. Keep both in sync
       ```
  </action>
  <verify>
    test -f config/README.md
    jq . config/limits.json > /dev/null
    jq . config/ages.json > /dev/null
    jq . config/defaults.json > /dev/null
    grep -q "export function getContributionLimit" config/loader.js
    grep -q "export function getDefaultInflationRate" config/loader.js
  </verify>
  <done>Config system validated, documented, and verified complete</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify no regressions</name>
  <files>tests/</files>
  <action>
    Verify that all configuration changes work correctly and no tests have regressed:

    1. Run all unit tests:
       ```bash
       echo "Running all unit tests..."
       for test in tests/unit/**/*.test.js; do
         echo "Testing: $test"
         node "$test"
       done
       ```

    2. Check for any failures:
       - If tests fail, investigate whether the failure is related to config changes
       - Common issues: missing exports from loader.js, incorrect value conversion (dollars vs cents)

    3. Run linter on all modified files:
       ```bash
       npx eslint src/core/models/Plan.js
       npx eslint config/loader.js
       npx eslint src/calculations/qcd.js
       npx eslint src/calculations/rmd.js
       npx eslint src/calculations/social-security.js
       ```

    4. Verify no ESLint errors related to config imports or usage

    Expected: All tests pass, no new ESLint errors (only pre-existing errors from Phase 1).
  </action>
  <verify>
    # Run a subset of critical tests
    node tests/unit/models/Plan.test.js && echo "✓ Plan tests pass"
    node tests/unit/calculations/qcd.test.js && echo "✓ QCD tests pass"
    node tests/unit/rules/MegaBackdoorRothRule.test.js && echo "✓ MegaBackdoorRothRule tests pass"
    node tests/unit/calculations/rmd.test.js && echo "✓ RMD tests pass"
    node tests/unit/calculations/social-security.test.js && echo "✓ Social Security tests pass"
  </verify>
  <done>All tests pass, no regressions from config changes</done>
</task>

<task type="auto">
  <name>Task 4: Update project documentation</name>
  <files>CLAUDE.md</files>
  <action>
    Update CLAUDE.md to document the new config system:

    1. Find the "Data Storage Schema" section
    2. Add a new "Configuration" section after "Directory Structure" and before "Layered Architecture":

    ```markdown
    ## Configuration

    All hardcoded magic numbers are centralized in the `config/` directory for easy maintenance and updates.

    **Config Files:**

    - `config/limits.json` - Retirement account contribution limits
      - 401k limits (employee deferral, total contribution, catch-up)
      - IRA limits (contribution, catch-up)
      - QCD annual limit
      - Values for 2024 and 2025

    - `config/ages.json` - Age-related thresholds
      - RMD start age (73, or 72 for those born in 1951)
      - Full Retirement Age table (birth years 1937-1959, default for 1960+)
      - IRS Uniform Lifetime Table (life expectancy factors ages 72-120)

    - `config/defaults.json` - Default assumption rates
      - Growth rates (equity, bond, inflation)
      - Volatility rates (equity, bond)
      - Default tax rates (federal, estimated)
      - Strategy defaults (Roth conversion, QCD, tax-loss harvesting)

    - `config/loader.js` - ES6 module with accessor functions
      - Imports all config data
      - Provides accessor functions for type-safe access
      - Converts values to appropriate units (dollars to cents)
      - Functions: getContributionLimit, getQCDLimit, getRMDStartAge, getDefaultInflationRate, etc.

    **Usage Pattern:**

    \`\`\`javascript
    // Import config accessor functions
    import { getContributionLimit, getDefaultInflationRate } from '../../config/loader.js';

    // Use in code
    const limit = getContributionLimit('401k', 2025, true); // 401k limit with catch-up
    const inflation = getDefaultInflationRate();
    \`\`\`

    **Design Decisions:**

    - Config data embedded in loader.js for ES6 compatibility (no JSON import assertions needed)
    - JSON files serve as documentation and can be used with build system
    - Values stored in readable format (dollars, decimals) in config
    - Conversion to cents happens in accessor functions
    - Pattern follows Phase 2 tax bracket extraction for consistency
    ```

    3. Update the "Design Principles" section to add principle #6:
       ```markdown
       ### 6. Configuration Centralization

       All hardcoded values (limits, ages, rates) are centralized in `config/` directory.
       - Easy to update when tax laws change
       - Single source of truth across the codebase
       - Type-safe accessor functions via loader.js
       ```
  </action>
  <verify>
    grep -q "## Configuration" CLAUDE.md
    grep -q "config/limits.json" CLAUDE.md
    grep -q "config/loader.js" CLAUDE.md
  </verify>
  <done>Documentation updated to reflect config system structure and usage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All config files exist and are valid JSON
- [ ] config/README.md documents the config system
- [ ] All unit tests pass (no regressions)
- [ ] CLAUDE.md updated with config documentation
- [ ] No hardcoded magic numbers remain undocumented
- [ ] Config system is complete and functional
</verification>

<success_criteria>
- Configuration centralization complete
- All hardcoded values in config/ with loader accessors
- Documentation updated
- All tests passing
- Phase 4 goals achieved
</success_criteria>

<output>
After completion, create `.planning/phases/04-config-centralization/04-04-SUMMARY.md`
</output>
