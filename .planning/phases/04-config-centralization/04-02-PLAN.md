---
phase: 04-config-centralization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - config/ages.json
  - config/loader.js
  - src/calculations/rmd.js
  - src/calculations/social-security.js
autonomous: true
must_haves:
  truths:
    - "Age-related thresholds are centralized in config/ages.json"
    - "RMD age constants (72, 73) are in config/ages.json"
    - "Social Security FRA table is in config/ages.json"
    - "Source files import age thresholds from config"
  artifacts:
    - path: "config/ages.json"
      provides: "Age-related thresholds and tables"
      contains: "RMD ages, FRA table, retirement ages"
    - path: "config/loader.js"
      provides: "Centralized config loader"
      exports: ["getRMDStartAge", "getFullRetirementAge", "getLifeExpectancyFactor"]
    - path: "src/calculations/rmd.js"
      provides: "RMD calculations"
      contains: "import from config/loader.js"
  key_links:
    - from: "src/calculations/rmd.js"
      to: "config/ages.json"
      via: "getRMDStartAge and getLifeExpectancyFactor from loader.js"
    - from: "src/calculations/social-security.js"
      to: "config/ages.json"
      via: "getFullRetirementAge from loader.js"
---

<objective>
Extract age-related constants (RMD thresholds, Social Security Full Retirement Age) to centralized configuration.

Purpose: Centralize hardcoded age values to make them easy to update as tax laws change and ensure consistency across RMD and Social Security calculations.

Output: config/ages.json with all age thresholds and tables, updated config/loader.js with age accessors, and updated source files importing from config.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 04-01 created config/limits.json and established the loader pattern
# This plan extends that pattern to age-related constants

@src/calculations/rmd.js
@src/calculations/social-security.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config/ages.json with age thresholds and tables</name>
  <files>config/ages.json</files>
  <action>
    Create config/ages.json with structure:

    ```json
    {
      "rmd": {
        "startAge": 73,
        "secureActTransitionAge": 72,
        "secureActTransitionBirthYear": 1951
      },
      "fullRetirementAge": {
        "1937": { "years": 65, "months": 0 },
        "1938": { "years": 65, "months": 2 },
        "1939": { "years": 65, "months": 4 },
        "1940": { "years": 65, "months": 6 },
        "1941": { "years": 65, "months": 8 },
        "1942": { "years": 65, "months": 10 },
        "1943": { "years": 66, "months": 0 },
        "1944": { "years": 66, "months": 0 },
        "1945": { "years": 66, "months": 0 },
        "1946": { "years": 66, "months": 0 },
        "1947": { "years": 66, "months": 0 },
        "1948": { "years": 66, "months": 0 },
        "1949": { "years": 66, "months": 0 },
        "1950": { "years": 66, "months": 0 },
        "1951": { "years": 66, "months": 0 },
        "1952": { "years": 66, "months": 2 },
        "1953": { "years": 66, "months": 4 },
        "1954": { "years": 66, "months": 6 },
        "1955": { "years": 66, "months": 8 },
        "1956": { "years": 66, "months": 10 },
        "1957": { "years": 67, "months": 0 },
        "1958": { "years": 67, "months": 0 },
        "default": { "years": 67, "months": 0 }
      },
      "lifeExpectancy": {
        "72": 27.4,
        "73": 26.5,
        "74": 25.5,
        "75": 24.6,
        "76": 23.7,
        "77": 22.9,
        "78": 22.0,
        "79": 21.1,
        "80": 20.2,
        "81": 19.4,
        "82": 18.5,
        "83": 17.7,
        "84": 16.8,
        "85": 16.0,
        "86": 15.2,
        "87": 14.4,
        "88": 13.7,
        "89": 12.9,
        "90": 12.2,
        "91": 11.5,
        "92": 10.8,
        "93": 10.1,
        "94": 9.5,
        "95": 8.9,
        "96": 8.4,
        "97": 7.8,
        "98": 7.3,
        "99": 6.8,
        "100": 6.4,
        "101": 6.0,
        "102": 5.6,
        "103": 5.2,
        "104": 4.9,
        "105": 4.6,
        "106": 4.3,
        "107": 4.0,
        "108": 3.7,
        "109": 3.5,
        "110": 3.4,
        "111": 3.3,
        "112": 3.1,
        "113": 3.0,
        "114": 2.9,
        "115": 2.8,
        "116": 2.7,
        "117": 2.5,
        "118": 2.3,
        "119": 2.1,
        "120": 1.9
      }
    }
    ```

    Extract the UNIFORM_LIFETIME_TABLE from rmd.js into lifeExpectancy section.
    Extract FRA logic from social-security.js into fullRetirementAge section.
  </action>
  <verify>File exists with valid JSON, contains all age thresholds and tables</verify>
  <done>config/ages.json created with RMD ages, FRA table, and life expectancy table</done>
</task>

<task type="auto">
  <name>Task 2: Extend config/loader.js with age accessor functions</name>
  <files>config/loader.js</files>
  <action>
    Add the following functions to config/loader.js:

    ```javascript
    import agesData from './ages.json';

    export function getRMDStartAge(birthYear) {
      if (!birthYear) {
        return agesData.rmd.startAge;
      }

      if (birthYear === agesData.rmd.secureActTransitionBirthYear) {
        return agesData.rmd.secureActTransitionAge;
      }

      return agesData.rmd.startAge;
    }

    export function getFullRetirementAge(birthYear) {
      if (!birthYear || birthYear >= 1960) {
        return agesData.fullRetirementAge.default;
      }

      return agesData.fullRetirementAge[birthYear] || agesData.fullRetirementAge.default;
    }

    export function getLifeExpectancyFactor(age) {
      if (age < 72) {
        return null;
      }

      if (age > 120) {
        age = 120;
      }

      return agesData.lifeExpectancy[age] || null;
    }
    ```

    Import agesData at the top alongside limitsData import.
  </action>
  <verify>loader.js exports new age accessor functions, imports agesData</verify>
  <done>config/loader.js extended with age accessors</done>
</task>

<task type="auto">
  <name>Task 3: Update rmd.js to use config ages</name>
  <files>src/calculations/rmd.js</files>
  <action>
    1. Add import at top: `import { getLifeExpectancyFactor, getRMDStartAge } from '../../config/loader.js';`

    2. Remove UNIFORM_LIFETIME_TABLE constant (lines 6-56)

    3. Replace getLifeExpectancyFactor function (lines 58-68):
       - Remove entire function implementation
       - Replace with: `export { getLifeExpectancyFactor } from '../../config/loader.js';`

    4. Replace mustTakeRMD function (lines 80-99):
       - Update line 83: `if (age < getRMDStartAge()) {`
       - Update line 88: `const age73Year = birthYear + getRMDStartAge(birthYear);`
       - Update line 89: `const turned72In2023 = birthYear === 1951;` â†’ Keep
       - Update line 92: `return age >= getRMDStartAge(1951);`
       - Update line 95: `return currentYear >= age73Year;`
       - Update line 98: `return age >= getRMDStartAge();`

    5. Replace getRMDStartAge function (lines 101-111):
       - Remove entire function implementation
       - Replace with: `export { getRMDStartAge } from '../../config/loader.js';`

    Keep calculateRMD and calculateRMDForAccount functions unchanged (they use getLifeExpectancyFactor).
  </action>
  <verify>rmd.js imports age functions from config, UNIFORM_LIFETIME_TABLE removed</verify>
  <done>rmd.js imports age thresholds from config</done>
</task>

<task type="auto">
  <name>Task 4: Update social-security.js to use config FRA table</name>
  <files>src/calculations/social-security.js</files>
  <action>
    1. Add import at top: `import { getFullRetirementAge } from '../../config/loader.js';`

    2. Replace calculateFullRetirementAge function (lines 11-34):
       - Remove entire function implementation
       - Replace with: `export { getFullRetirementAge } from '../../config/loader.js';`

    Keep calculateSocialSecurityBenefit function unchanged (it uses calculateFullRetirementAge).
  </action>
  <verify>social-security.js imports getFullRetirementAge from config</verify>
  <done>social-security.js imports FRA from config</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] config/ages.json exists with valid JSON
- [ ] config/loader.js imports agesData and exports age accessors
- [ ] rmd.js imports from config/loader.js
- [ ] social-security.js imports from config/loader.js
- [ ] UNIFORM_LIFETIME_TABLE removed from rmd.js
- [ ] calculateFullRetirementAge implementation removed from social-security.js
- [ ] npm test passes (or custom test runner succeeds)
</verification>

<success_criteria>

- All age thresholds centralized in config/ages.json
- Centralized loader module provides access to all age-related data
- Source files import ages from config (no hardcoded age values)
- UNIFORM_LIFETIME_TABLE removed from source code
- FRA calculation logic removed from source code (now in config)
- All tests passing
  </success_criteria>

<output>
After completion, create `.planning/phases/04-config-centralization/04-02-SUMMARY.md`
</output>
