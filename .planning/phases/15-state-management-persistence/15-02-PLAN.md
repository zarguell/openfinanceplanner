---
phase: 15-state-management-persistence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/middleware/indexeddb.ts
  - src/store/index.ts
autonomous: true

must_haves:
  truths:
    - "IndexedDB storage adapter implements StateStorage interface"
    - "Storage adapter uses idb-keyval for async operations"
    - "Store persists to IndexedDB via persist middleware"
    - "Store hydrates automatically on app load"
    - "Hydration state tracked via _hasHydrated flag"
    - "Store name 'open-finance-planner' used for storage key"
  artifacts:
    - path: "src/store/middleware/indexeddb.ts"
      provides: "Custom IndexedDB storage adapter"
      exports: ["indexedDBStorage"]
      min_lines: 15
    - path: "src/store/index.ts"
      provides: "Store with persist middleware configured"
      contains: "persist("
      min_lines: 40
  key_links:
    - from: "src/store/middleware/indexeddb.ts"
      to: "idb-keyval"
      via: "import get, set, del"
      pattern: "from 'idb-keyval'"
    - from: "src/store/index.ts"
      to: "src/store/middleware/indexeddb.ts"
      via: "import indexedDBStorage for persist storage"
      pattern: "indexedDBStorage"
    - from: "src/store/index.ts"
      to: "zustand/middleware"
      via: "persist and createJSONStorage"
      pattern: "from 'zustand/middleware'"
---

<objective>
Create custom IndexedDB storage adapter using idb-keyval and configure Zustand persist middleware with automatic hydration tracking.

Purpose: Phase 15 requires IndexedDB persistence (STATE-02) and automatic hydration (STATE-03). This plan implements the storage adapter following Zustand's custom storage pattern and configures persist middleware with hydration tracking.

Output: IndexedDB storage adapter, persist middleware configured, store hydrates from IndexedDB on app load
</objective>

<execution_context>
@/Users/zach/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zach/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-state-management-persistence/15-RESEARCH.md
@src/store/index.ts
@src/store/types.ts
</context>

<tasks>

<task type="auto">
  <name>Create IndexedDB storage adapter</name>
  <files>src/store/middleware/indexeddb.ts</files>
  <action>
    Create src/store/middleware/indexeddb.ts with custom IndexedDB storage adapter:

    1. Import StateStorage, createJSONStorage from 'zustand/middleware'
    2. Import get, set, del from 'idb-keyval'
    3. Create indexedDBStorage constant implementing StateStorage interface:
       - getItem: async (name: string) => (await get(name)) || null
       - setItem: async (name: string, value: string) => await set(name, value)
       - removeItem: async (name: string) => await del(name)
    4. Export indexedDBStorage

    Follow the exact pattern from Zustand official documentation (see RESEARCH.md Pattern 1).
    Use proper TypeScript types for all async functions (Promise<string | null>, Promise<void>).
    Do NOT add any additional methods beyond StateStorage requirements.
  </action>
  <verify>test -f src/store/middleware/indexeddb.ts && grep -q "StateStorage" src/store/middleware/indexeddb.ts && npm run type-check</verify>
  <done>IndexedDB storage adapter exists with getItem, setItem, removeItem methods using idb-keyval</done>
</task>

<task type="auto">
  <name>Configure persist middleware with hydration</name>
  <files>src/store/index.ts</files>
  <action>
    Modify src/store/index.ts to configure persist middleware:

    1. Import persist, createJSONStorage from 'zustand/middleware'
    2. Import indexedDBStorage from './middleware/indexeddb'
    3. Wrap the store creation with persist() middleware
    4. Configure persist with:
       - name: 'open-finance-planner'
       - storage: createJSONStorage(() => indexedDBStorage)
       - onRehydrateStorage: () => (state) => state?.setHasHydrated(true)
    5. Export the persisted store

    The persist middleware wraps the entire store creation. The onRehydrateStorage callback sets _hasHydrated to true after hydration completes.
    Follow Pattern 3 from RESEARCH.md exactly.
  </action>
  <verify>grep -q "persist(" src/store/index.ts && grep -q "onRehydrateStorage" src/store/index.ts && grep -q "open-finance-planner" src/store/index.ts && npm run type-check</verify>
  <done>Store wrapped with persist middleware, IndexedDB storage configured, hydration tracking implemented</done>
</task>

</tasks>

<verification>
Run npm run type-check to verify TypeScript types are correct. Verify that the storage adapter implements StateStorage interface correctly by checking import resolution.
</verification>

<success_criteria>
1. src/store/middleware/ directory created with indexeddb.ts
2. indexedDBStorage exports with getItem, setItem, removeItem
3. Store wrapped with persist middleware
4. Storage configured with 'open-finance-planner' name
5. onRehydrateStorage callback sets _hasHydrated to true
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-state-management-persistence/15-02-SUMMARY.md`
</output>
