---
phase: 05-test-migration
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01-PLAN.md
files_modified:
  - tests/integration/full-flow.test.js
  - tests/integration/roth-conversions-integration.test.js
  - tests/integration/roth-conversions-ui.test.js
  - tests/integration/qcd-integration.test.js
  - tests/integration/rmd-integration.test.js
  - tests/integration/social-security-integration.test.js
  - tests/integration/tax-loss-harvesting-integration.test.js
  - tests/integration/withdrawal-strategies-integration.test.js
autonomous: true
must_haves:
  truths:
    - 'All integration tests use Vitest describe/it/expect format'
    - 'Integration tests verify cross-module workflows'
    - 'All integration tests pass with vitest run'
  artifacts:
    - path: 'tests/integration/full-flow.test.js'
      provides: 'Full application flow integration test'
      contains: 'describe() blocks, it() specs, expect() assertions'
    - path: 'tests/integration/*.test.js'
      provides: 'All integration tests migrated'
      contains: '8 integration test files converted from custom runner'
  key_links:
    - from: 'tests/integration/**/*.test.js'
      to: 'src/**/*.js'
      via: 'Integration tests import and exercise multiple modules together'
---

<objective>
Migrate all integration tests from custom test runner format to Vitest describe/it/expect format.

Purpose: Integration tests verify cross-module workflows and real user scenarios. Converting them to Vitest provides better organization, parallel execution, and integration with coverage reporting.

Output: All 8 integration test files converted to Vitest format, all tests passing with `npm test`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-migration/05-RESEARCH.md
@.planning/phases/05-test-migration/05-01-SUMMARY.md

# Phase context:

# - 05-01 completed: All unit tests migrated to Vitest format

# - This plan: Migrate integration tests (builds on unit test work)

@tests/integration/full-flow.test.js (example of current format)

**Integration test characteristics:**

- Test cross-module workflows (e.g., Plan + Accounts + Projections)
- May involve async operations (file I/O, calculations)
- Often test complete user scenarios
- May require more complex setup/teardown

**Key difference from unit tests:**

- Integration tests may need beforeEach/afterEach for shared state
- May need module-level setup for test data
- Often test async flows requiring async/await in tests
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze integration test patterns</name>
  <files>tests/integration/full-flow.test.js</files>
  <action>
    Read and analyze tests/integration/full-flow.test.js to understand:

    1. Current test structure (export functions, import.meta.url guards)
    2. What modules are being tested together
    3. Any async patterns used
    4. Setup/teardown requirements
    5. Test data patterns

    Document any patterns that need special handling for Vitest migration.

  </action>
  <verify>Full understanding of integration test structure and migration requirements</verify>
  <done>Integration test analysis complete, migration approach defined</done>
</task>

<task type="auto">
  <name>Task 2: Migrate full-flow integration test</name>
  <files>tests/integration/full-flow.test.js</files>
  <action>
    Migrate tests/integration/full-flow.test.js:

    This is likely the most comprehensive integration test, testing:
    - Plan creation workflow
    - Account additions
    - Projection calculations
    - Full financial planning flow

    Pattern for full-flow tests:
    ```javascript
    import { describe, it, expect, beforeEach } from 'vitest';
    import { Plan } from '../../src/core/models/Plan.js';
    import { StorageManager } from '../../src/storage/StorageManager.js';
    import { calculateProjection } from '../../src/calculations/projection.js';

    describe('Full Application Flow', () => {
      let testPlan;

      beforeEach(() => {
        testPlan = new Plan('Integration Test Plan', 35, 65);
      });

      describe('Plan Creation Workflow', () => {
        it('should create plan and initialize state', async () => {
          expect(testPlan.name).toBe('Integration Test Plan');
          expect(testPlan.age).toBe(35);
          expect(testPlan.retirementAge).toBe(65);
        });

        it('should add accounts and reflect in projections', async () => {
          const account = { id: 'acc_401k', type: '401k', balance: 100000, annualContribution: 19500 };
          testPlan.addAccount(account);
          expect(testPlan.accounts).toHaveLength(1);

          const projection = await calculateProjection(testPlan, 30);
          expect(projection).toBeDefined();
        });
      });
    });
    ```

    Remove import.meta.url guard. Convert all assertions.

  </action>
  <verify>full-flow.test.js uses Vitest format, npm test passes for this file</verify>
  <done>Full-flow integration test migrated to Vitest format</done>
</task>

<task type="auto">
  <name>Task 3: Migrate Roth conversions integration tests (2 files)</name>
  <files>tests/integration/roth-conversions-integration.test.js, tests/integration/roth-conversions-ui.test.js</files>
  <action>
    Migrate both Roth conversion integration tests:

    - tests/integration/roth-conversions-integration.test.js
    - tests/integration/roth-conversions-ui.test.js

    These tests likely verify:
    - Roth conversion calculations across modules
    - UI workflow for Roth conversions
    - Edge cases (income limits, contribution limits)

    Use describe() blocks to organize by feature:
    - describe('Calculation Flow')
    - describe('UI Workflow')
    - describe('Edge Cases')

  </action>
  <verify>Both Roth conversion tests use Vitest format, npm test passes</verify>
  <done>Roth conversions integration tests migrated to Vitest format</done>
</task>

<task type="auto">
  <name>Task 4: Migrate remaining integration tests (5 files)</name>
  <files>tests/integration/qcd-integration.test.js, tests/integration/rmd-integration.test.js, tests/integration/social-security-integration.test.js, tests/integration/tax-loss-harvesting-integration.test.js, tests/integration/withdrawal-strategies-integration.test.js</files>
  <action>
    Migrate remaining 5 integration test files:

    - tests/integration/qcd-integration.test.js (Qualified Charitable Distribution)
    - tests/integration/rmd-integration.test.js (Required Minimum Distributions)
    - tests/integration/social-security-integration.test.js
    - tests/integration/tax-loss-harvesting-integration.test.js
    - tests/integration/withdrawal-strategies-integration.test.js

    For each file:
    1. Add imports: `import { describe, it, expect, beforeEach, afterEach } from 'vitest';`
    2. Add module imports as needed
    3. Convert export function testX() to it('should x', () => { })
    4. Convert throw Error to expect() assertions
    5. Group related tests with describe() blocks
    6. Add beforeEach/afterEach for shared state if needed
    7. Remove import.meta.url guard

    Handle async operations with async/await in it() blocks.

  </action>
  <verify>All 5 integration test files use Vitest format, npm test passes for all</verify>
  <done>All remaining integration tests migrated to Vitest format</done>
</task>

<task type="auto">
  <name>Task 5: Run full integration test suite</name>
  <files>vitest.config.js</files>
  <action>
    Run full integration test suite:

    ```bash
    npm test
    ```

    Or run integration tests specifically:
    ```bash
    npx vitest run tests/integration/**/*.test.js
    ```

    Expected output:
    - All 8 integration test files discovered and executed
    - All tests passing
    - Integration tests run alongside unit tests (no conflicts)

    Verify integration tests can access modules correctly (import paths work).

  </action>
  <verify>npm test shows all integration tests passing (8 test files)</verify>
  <done>Full integration test suite passes with Vitest, all 8 files migrated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 8 integration test files use describe/it/expect format
- [ ] No import.meta.url execution guards remain
- [ ] `npm test` runs both unit and integration tests successfully
- [ ] All integration tests passing
- [ ] Cross-module workflows tested correctly
</verification>

<success_criteria>

- All integration tests migrated from custom runner to Vitest format
- Integration tests verify cross-module workflows correctly
- All 8 integration test files passing
- npm test runs all tests (unit + integration) successfully
- Ready for 05-03-PLAN.md (coverage and CI hooks)
  </success_criteria>

<output>
After completion, create `.planning/phases/05-test-migration/05-02-SUMMARY.md`
</output>
