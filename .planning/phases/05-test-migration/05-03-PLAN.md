---
phase: 05-test-migration
plan: 03
type: execute
wave: 3
depends_on:
  - 05-02-PLAN.md
files_modified:
  - vitest.config.js
  - package.json
  - .github/workflows/ci.yml (or .github/workflows/tests.yml)
autonomous: true
must_haves:
  truths:
    - 'Coverage reports generated with vitest run --coverage'
    - 'CI pipeline runs tests and enforces coverage thresholds'
    - 'Coverage thresholds prevent regression below current coverage'
  artifacts:
    - path: 'coverage/'
      provides: 'Code coverage reports'
      contains: 'HTML, JSON, LCOV coverage reports'
    - path: 'vitest.config.js'
      provides: 'Updated Vitest configuration with coverage'
      contains: 'coverage provider, reporter, threshold settings'
    - path: '.github/workflows/ci.yml'
      provides: 'CI workflow for tests and coverage'
      contains: 'test command, coverage enforcement, pass/fail criteria'
  key_links:
    - from: '.github/workflows/ci.yml'
      to: 'npm test'
      via: 'CI runs tests on every push/PR'
    - from: 'vitest.config.js'
      to: 'coverage/'
      via: 'Coverage reports generated in coverage/ directory'
---

<objective>
Configure Vitest coverage reporting and set up CI integration.

Purpose: Add automated code coverage reporting to track test effectiveness, enforce minimum coverage thresholds, and ensure tests run automatically in CI pipeline.

Output: Coverage reporting configured with v8 provider, coverage thresholds set, CI workflow runs tests with coverage enforcement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-migration/05-RESEARCH.md
@.planning/phases/05-test-migration/05-02-SUMMARY.md

# Phase context:

# - 05-01 & 05-02 completed: All tests migrated to Vitest format

# - This plan: Add coverage reporting and CI integration

@vitest.config.js (current basic config)
@package.json (test script: "vitest run")

**Coverage configuration from research:**

- Use @vitest/coverage-v8 (already installed, V8-based faster coverage)
- Configure reporters: ['text', 'json', 'html', 'lcov']
- Set coverage thresholds: lines 80, functions 80, branches 75, statements 80
- Exclude patterns: node_modules, dist, .planning, docs, \*_/_.test.js

**CI considerations:**

- Run tests on every push to main
- Run tests on every PR
- Upload coverage reports to GitHub Actions
- Fail build if coverage thresholds not met
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Update vitest.config.js with coverage configuration</name>
  <files>vitest.config.js</files>
  <action>
    Update vitest.config.js to add comprehensive coverage configuration:

    ```javascript
    /// <reference types="vitest" />
    import { defineConfig } from 'vitest/config';

    export default defineConfig({
      test: {
        environment: 'node',
        globals: true,
        include: ['tests/**/*.test.js'],
        exclude: ['node_modules', 'dist', '.planning', 'docs'],
        coverage: {
          provider: 'v8',
          reporter: ['text', 'json', 'html', 'lcov'],
          reportsDirectory: './coverage',
          exclude: [
            'node_modules/',
            'dist/',
            '.planning/',
            'docs/',
            '**/*.test.js',
            '**/test-helper.js',
            '**/vitest.config.js',
            '**/vitest.setup.js',
          ],
          thresholds: {
            lines: 80,
            functions: 80,
            branches: 75,
            statements: 80,
          },
        },
      },
    });
    ```

    Key settings from research:
    - provider: 'v8' (faster than Istanbul, built-in)
    - reporters: text (terminal), json (data), html (browseable), lcov (codecov)
    - thresholds: enforce minimum coverage (adjust based on current coverage)

  </action>
  <verify>vitest.config.js has coverage config, npx vitest run --coverage generates reports</verify>
  <done>vitest.config.js updated with comprehensive coverage configuration</done>
</task>

<task type="auto">
  <name>Task 2: Verify coverage works and check current coverage</name>
  <files>coverage/</files>
  <action>
    Run coverage and check current state:

    ```bash
    npm run test -- --coverage
    ```

    Check output:
    - Coverage percentage for lines, functions, branches, statements
    - Which files have lowest coverage
    - Whether thresholds are met or need adjustment

    If coverage < 80%:
    - Reduce thresholds to current coverage level + buffer
    - OR add more tests to reach 80%
    - Decision: Set realistic thresholds that can be improved over time

    Check coverage directory:
    - coverage/index.html (open in browser to review)
    - coverage/coverage-final.json (machine-readable)
    - coverage/lcov.info (for codecov/coveralls)

  </action>
  <verify>Coverage runs successfully, reports generated, current coverage measured</verify>
  <done>Coverage working and current coverage baseline established</done>
</task>

<task type="auto">
  <name>Task 3: Update package.json scripts</name>
  <files>package.json</files>
  <action>
    Update package.json to add coverage-specific scripts:

    ```json
    {
      "scripts": {
        "serve": "python3 -m http.server 3030",
        "test": "vitest run",
        "test:coverage": "vitest run --coverage",
        "test:ui": "vitest --ui",
        "lint": "eslint .",
        "format": "prettier --write ."
      }
    }
    ```

    Keep "test" as default (runs tests without coverage for speed).
    Add "test:coverage" for full coverage report generation.
    Add "test:ui" for interactive test debugging (Vitest built-in UI).

  </action>
  <verify>package.json has new scripts, npm run test:coverage works</verify>
  <done>package.json updated with coverage and UI test scripts</done>
</task>

<task type="auto">
  <name>Task 4: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
    Create .github/workflows/ci.yml:

    ```yaml
    name: CI

    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      test:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '20'
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Run linter
            run: npm run lint

          - name: Run tests with coverage
            run: npm run test:coverage

          - name: Upload coverage to Codecov
            if: success()
            uses: codecov/codecov-action@v4
            with:
              files: ./coverage/lcov.info
              fail_ci_if_error: false

          - name: Check coverage thresholds
            run: |
              # Extract coverage percentages and check against thresholds
              # This is optional - vitest will fail if thresholds not met
              echo "Coverage thresholds enforced by Vitest"
    ```

    Key features:
    - Runs on push to main and all PRs
    - Installs dependencies with npm ci (faster, more secure)
    - Runs linter first (fail fast)
    - Runs tests with coverage
    - Uploads coverage to Codecov (optional, but good practice)
    - Vitest enforces thresholds (build fails if coverage drops)

    Adjust Node version as needed (check package.json engines or .nvmrc).

  </action>
  <verify>.github/workflows/ci.yml created, GitHub Actions runs on push/PR</verify>
  <done>GitHub Actions CI workflow configured with test and coverage</done>
</task>

<task type="auto">
  <name>Task 5: Verify CI workflow works</name>
  <files>.github/workflows/ci.yml
