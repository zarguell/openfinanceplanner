---
phase: 03-ui-refactor
plan: 03-02
type: execute
subsystem: ui-controllers
tags: [refactoring, account-management, modularization, extraction]
requires:
  - 03-01-SUMMARY.md
provides:
  - AccountController module
  - Extracted account CRUD logic
affects:
  - src/ui/AppController.js
  - src/ui/AccountController.js (new)
tech-stack:
  - Pure Vanilla JavaScript (ES2020+) ES6 Modules
  - No runtime dependencies
  - ESLint 9.x flat config
  - Prettier 3.x
key-files:
  - src/ui/AccountController.js (new)
  - src/ui/AppController.js (modified)
key-decisions:
  - Extract account management (list, add, edit, delete) to AccountController
  - Keep AppController methods as delegators to maintain window.app compatibility
  - AccountController needs reference to currentPlan for CRUD operations
metrics:
  duration: ~8 min
  files_created: 1
  files_modified: 1
  lines_extracted: ~150
---

<objective>
Extract account management logic from AppController to dedicated AccountController module.

Purpose: Reduce AppController.js complexity by isolating account CRUD operations (list, add, edit, delete) into focused module. Follows PlanController pattern from 03-01.

Output: AccountController.js (~150 lines) with account management methods, AppController updated to delegate.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ui-refactor/03-01-SUMMARY.md
@src/ui/AppController.js

**Tech stack available:**

- Pure Vanilla JavaScript (ES2020+) ES6 Modules
- ESLint 9.x flat config
- Prettier 3.x

**Established patterns:**

- From 03-01: Extract to dedicated controller class, delegate from AppController
- From 03-01: Keep delegator methods in AppController for window.app compatibility
- From Phase 2: Modular extraction pattern with ES6 import/export

**Constraining decisions:**

- Maintain backward compatibility with onclick="app.addAccount()" etc.
- Modal helpers (openModal, closeModal) remain in AppController
- Account model remains in src/core/models/Account.js

**Issues being addressed:** None (refactoring goal)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AccountController module with account CRUD methods</name>
  <files>src/ui/AccountController.js</files>
  <action>Create src/ui/AccountController.js class with:

1. Constructor taking (currentPlan, StorageManager)
2. Render method:
   - renderAccountsList() - renders account cards to DOM (each card: name, type badge, balance, contribution, withdrawal rate, Edit button, Delete button)

3. Modal creation:
   - showAddAccountModal() - creates dynamic modal with account form (name, type select, balance, contribution)

4. CRUD operations:
   - addAccount() - validates inputs, creates Account instance, adds to currentPlan.accounts, saves plan, re-renders list, removes modal
   - deleteAccount(accountId) - confirms deletion, removes from currentPlan.accounts, saves plan, re-renders list
   - editAccount(accountId) - finds account, creates modal with pre-filled values (name, balance, contribution)
   - saveEditAccount(accountId) - finds account, updates fields, saves plan, re-renders list, removes modal

5. Helper method:
   - escapeHtml(text) - prevents XSS (for rendering account names)

Import dependencies: { Account } from '../core/models/Account.js', { StorageManager } from '../storage/StorageManager.js'

Use this.currentPlan reference for all CRUD operations. Follow existing AppController code structure for these methods (lines 243-279, 721-834).
</action>
<verify>src/ui/AccountController.js exists, exports AccountController class, has all required methods (check with: grep -E "^\s+(renderAccountsList|showAddAccountModal|addAccount|deleteAccount|editAccount|saveEditAccount)" src/ui/AccountController.js)</verify>
<done>AccountController class created with all account management methods extracted from AppController</done>
</task>

<task type="auto">
  <name>Task 2: Update AppController to delegate to AccountController</name>
  <files>src/ui/AppController.js</files>
  <action>Update src/ui/AppController.js:

1. Add import: import { AccountController } from './AccountController.js'

2. In constructor, after this.planController initialization:
   - Create: this.accountController = new AccountController(this.currentPlan, StorageManager)

3. Remove these methods from AppController (now in AccountController):
   - renderAccountsList() - DELETE this method
   - showAddAccountModal() - DELETE this method
   - addAccount() - DELETE this method
   - deleteAccount(accountId) - DELETE this method
   - editAccount(accountId) - DELETE this method
   - saveEditAccount(accountId) - DELETE this method

4. Add delegator methods to AppController (for window.app compatibility):
   - renderAccountsList() { return this.accountController.renderAccountsList(); }
   - showAddAccountModal() { return this.accountController.showAddAccountModal(); }
   - addAccount() { return this.accountController.addAccount(); }
   - deleteAccount(accountId) { return this.accountController.deleteAccount(accountId); }
   - editAccount(accountId) { return this.accountController.editAccount(accountId); }
   - saveEditAccount(accountId) {
     const result = this.accountController.saveEditAccount(accountId);
     this.currentPlan = this.accountController.currentPlan; // Sync reference
     return result;
     }

5. Update renderPlanUI() method (still in AppController from 03-01):
   - Find the line: this.renderAccountsList();
   - Change to: this.accountController.renderAccountsList();
   - This ensures PlanController's renderPlanUI calls AccountController's render method

6. Keep modal helpers in AppController:
   - openModal(id) - keep
   - closeModal(id) - keep
   - escapeHtml(text) - keep (AccountController also has its own, but AppController needs it for other rendering)

7. In PlanController.renderPlanUI(), update the accounts list rendering call:
   - When PlanController calls renderAccountsList(), it should call: app.accountController.renderAccountsList()
   - OR: Pass accountController instance to PlanController so it can call directly
   - Simplest approach: In PlanController.renderPlanUI(), after rendering tabs, call window.app.accountController.renderAccountsList() if it exists

Wait, let's reconsider the architecture. PlanController.renderPlanUI() needs to render all the tabs, including accounts list. Better approach:

- PlanController should accept accountController, expenseController, incomeController in constructor
- Update PlanController constructor: constructor(currentPlan, StorageManager, accountController, expenseController, incomeController)
- Store these as instance properties
- In PlanController.renderPlanUI(), call this.accountController.renderAccountsList()

Then in AppController constructor:

- Create accountController first
- Create expenseController
- Create incomeController
- Create planController with all three as parameters

But this is getting complex. Simpler approach for now:

- Keep PlanController.renderPlanUI() calling window.app.accountController.renderAccountsList() (via global reference)
- This is acceptable since we're maintaining window.app anyway for onclick handlers
- Add comment: // TODO: Remove window.app dependency by passing controllers to PlanController

Actually, let's just implement the right way:

- Update PlanController constructor to accept optional accountController, expenseController, incomeController
- In AppController constructor: this.planController = new PlanController(this.currentPlan, StorageManager, this.accountController)
- In PlanController.renderPlanUI(): if (this.accountController) this.accountController.renderAccountsList();

This is cleaner and sets up the pattern for expense/income controllers too.
</action>
<verify>grep -c "this.accountController\." src/ui/AppController.js (should count ~6-8 delegations)</verify>
<done>AppController delegates all account management methods to AccountController, PlanController integrates with AccountController</done>
</task>

<task type="auto">
  <name>Task 3: Run linter and formatter, verify functionality</name>
  <files>src/ui/AppController.js, src/ui/AccountController.js</files>
  <action>1. Update PlanController constructor to accept accountController parameter (if not already done in Task 2):
   - constructor(currentPlan, StorageManager, accountController = null)
   - Store: this.accountController = accountController
   - In renderPlanUI(), replace this.renderAccountsList() with: if (this.accountController) this.accountController.renderAccountsList()

2. Run Prettier: npx prettier --write src/ui/AccountController.js src/ui/AppController.js src/ui/PlanController.js

3. Run ESLint: npx eslint src/ui/AccountController.js src/ui/AppController.js src/ui/PlanController.js

4. Fix any lint errors (follow Phase 1 conventions)

5. Manual verification:
   - Load a plan
   - Click Accounts tab
   - Accounts list renders
   - Click + Add Account button
   - Fill form, click Add
   - Account appears in list
   - Click Edit button
   - Modify values, click Save
   - Account updates
   - Click Delete button
   - Confirm deletion
   - Account removed from list

All account functionality should work identically to before refactoring.
</action>
<verify>npx eslint src/ui/AccountController.js src/ui/AppController.js src/ui/PlanController.js passes with no errors (pre-existing errors ignored)</verify>
<done>Code formatted, no new lint errors, all account management functionality works correctly</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] src/ui/AccountController.js created and exports AccountController class
- [ ] AppController delegates all account management methods to AccountController
- [ ] PlanController integrates with AccountController for rendering
- [ ] npx prettier --write passes for all modified files
- [ ] npx eslint passes with no new errors
- [ ] Manual test: Add account, edit account, delete account, list renders correctly
</verification>

<success_criteria>

- AccountController.js created with ~150 lines of account management logic
- AppController delegates all account CRUD methods to AccountController
- PlanController.renderPlanUI() integrates with AccountController
- All existing account functionality works identically
- ~150 lines extracted from AppController
  </success_criteria>

<output>
After completion, create `.planning/phases/03-ui-refactor/03-02-SUMMARY.md`:

# Phase 03-02: Extract Account Management Summary

**Extracted account management logic (list, add, edit, delete) to dedicated AccountController module**

## Accomplishments

- Created src/ui/AccountController.js with account CRUD methods
- Extracted ~150 lines from AppController.js
- PlanController integrates with AccountController for rendering
- All account operations work correctly

## Files Created/Modified

- `src/ui/AccountController.js` - New module with account management methods
- `src/ui/AppController.js` - Updated to delegate to AccountController
- `src/ui/PlanController.js` - Updated constructor to accept accountController

## Decisions Made

- PlanController accepts accountController in constructor for proper integration
- Modal helpers remain in AppController for shared use
- Global window.app maintained for onclick compatibility

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-03-PLAN.md (Extract Expense and Income Management)
</output>
