---
phase: 03-ui-refactor
plan: 03-03
type: execute
subsystem: ui-controllers
tags: [refactoring, expense-income-management, modularization, extraction]
requires:
  - 03-02-SUMMARY.md
provides:
  - ExpenseIncomeController module
  - Extracted expense and income CRUD logic
affects:
  - src/ui/AppController.js
  - src/ui/ExpenseIncomeController.js (new)
tech-stack:
  - Pure Vanilla JavaScript (ES2020+) ES6 Modules
  - No runtime dependencies
  - ESLint 9.x flat config
  - Prettier 3.x
key-files:
  - src/ui/ExpenseIncomeController.js (new)
  - src/ui/AppController.js (modified)
  - src/ui/PlanController.js (modified - to integrate ExpenseIncomeController)
key-decisions:
  - Combine expense and income management into one ExpenseIncomeController (similar patterns)
  - Keep AppController methods as delegators to maintain window.app compatibility
  - ExpenseIncomeController needs reference to currentPlan for CRUD operations
metrics:
  duration: ~10 min
  files_created: 1
  files_modified: 2
  lines_extracted: ~225
---

<objective>
Extract expense and income management logic from AppController to dedicated ExpenseIncomeController module.

Purpose: Reduce AppController.js complexity by isolating expense and income CRUD operations (list, add, delete) into focused module. Pattern from PlanController and AccountController.

Output: ExpenseIncomeController.js (~225 lines) with expense/income management methods, AppController and PlanController updated to delegate.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ui-refactor/03-01-SUMMARY.md
@.planning/phases/03-ui-refactor/03-02-SUMMARY.md
@src/ui/AppController.js

**Tech stack available:**

- Pure Vanilla JavaScript (ES2020+) ES6 Modules
- ESLint 9.x flat config
- Prettier 3.x

**Established patterns:**

- From 03-01: Extract to dedicated controller, delegate from AppController
- From 03-02: PlanController accepts child controllers in constructor for integration
- From Phase 2: Modular extraction pattern with ES6 import/export

**Constraining decisions:**

- Maintain backward compatibility with onclick="app.addExpense()" etc.
- Modal helpers (openModal, closeModal) remain in AppController
- Expense and Income models remain in src/core/models/

**Issues being addressed:** None (refactoring goal)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExpenseIncomeController module with expense/income CRUD methods</name>
  <files>src/ui/ExpenseIncomeController.js</files>
  <action>Create src/ui/ExpenseIncomeController.js class with:

1. Constructor taking (currentPlan, StorageManager)
2. Expense render and CRUD methods:
   - renderExpensesList() - renders expense cards to DOM (lines 282-319 in AppController)
   - showAddExpenseModal() - creates modal with expense form (name, amount, start year, inflation adjusted checkbox) (lines 838-871)
   - addExpense() - validates inputs, creates Expense instance, adds to currentPlan.expenses, saves, re-renders, removes modal (lines 873-889)
   - deleteExpense(expenseId) - confirms, removes from currentPlan.expenses, saves, re-renders (lines 891-896)

3. Income render and CRUD methods:
   - renderIncomesList() - renders income cards to DOM (lines 321-358 in AppController)
   - showAddIncomeModal() - creates modal with comprehensive income form (name, type, amount, start/end years, one-time checkbox, growth rate, smart rules) (lines 900-999)
   - addIncome() - validates inputs, creates Income instance with all fields, adds to currentPlan.incomes, saves, re-renders, removes modal (lines 1001-1044)
   - deleteIncome(incomeId) - confirms, removes from currentPlan.incomes, saves, re-renders (lines 1058-1063)
   - toggleIncomeStartRuleFields() - shows/hides age-based rule fields (lines 1046-1050)
   - toggleIncomeEndRuleFields() - shows/hides age-based rule fields (lines 1052-1056)

4. Helper method:
   - escapeHtml(text) - prevents XSS

Import dependencies:

- { Expense } from '../core/models/Expense.js'
- { Income } from '../core/models/Income.js'
- { StorageManager } from '../storage/StorageManager.js'

Use this.currentPlan reference for all CRUD operations. Follow existing AppController code structure for these methods.
</action>
<verify>src/ui/ExpenseIncomeController.js exists, exports ExpenseIncomeController class, has all required methods (check with: grep -E "^\s+(renderExpensesList|showAddExpenseModal|addExpense|deleteExpense|renderIncomesList|showAddIncomeModal|addIncome|deleteIncome|toggleIncomeStartRuleFields|toggleIncomeEndRuleFields)" src/ui/ExpenseIncomeController.js)</verify>
<done>ExpenseIncomeController class created with all expense and income management methods extracted from AppController</done>
</task>

<task type="auto">
  <name>Task 2: Update AppController and PlanController to delegate to ExpenseIncomeController</name>
  <files>src/ui/AppController.js, src/ui/PlanController.js</files>
  <action>Update both files:

**Step 1: Update src/ui/AppController.js:**

1. Add import: import { ExpenseIncomeController } from './ExpenseIncomeController.js'

2. In constructor, after this.accountController initialization:
   - Create: this.expenseIncomeController = new ExpenseIncomeController(this.currentPlan, StorageManager)

3. Remove these methods from AppController (now in ExpenseIncomeController):
   - renderExpensesList() - DELETE
   - showAddExpenseModal() - DELETE
   - addExpense() - DELETE
   - deleteExpense(expenseId) - DELETE
   - renderIncomesList() - DELETE
   - showAddIncomeModal() - DELETE
   - addIncome() - DELETE
   - deleteIncome(incomeId) - DELETE
   - toggleIncomeStartRuleFields() - DELETE
   - toggleIncomeEndRuleFields() - DELETE

4. Add delegator methods to AppController:
   - renderExpensesList() { return this.expenseIncomeController.renderExpensesList(); }
   - showAddExpenseModal() { return this.expenseIncomeController.showAddExpenseModal(); }
   - addExpense() { return this.expenseIncomeController.addExpense(); }
   - deleteExpense(expenseId) { return this.expenseIncomeController.deleteExpense(expenseId); }
   - renderIncomesList() { return this.expenseIncomeController.renderIncomesList(); }
   - showAddIncomeModal() { return this.expenseIncomeController.showAddIncomeModal(); }
   - addIncome() { return this.expenseIncomeController.addIncome(); }
   - deleteIncome(incomeId) { return this.expenseIncomeController.deleteIncome(incomeId); }
   - toggleIncomeStartRuleFields() { return this.expenseIncomeController.toggleIncomeStartRuleFields(); }
   - toggleIncomeEndRuleFields() { return this.expenseIncomeController.toggleIncomeEndRuleFields(); }

   NOTE: No currentPlan sync needed like AccountController since these don't return updated plan - they update this.currentPlan.expenses/incomes directly

5. Update PlanController constructor signature and calls:
   - In PlanController.js constructor:
     constructor(currentPlan, StorageManager, accountController, expenseIncomeController)
     Store: this.expenseIncomeController = expenseIncomeController

   - In PlanController.renderPlanUI(), find and update:
     this.renderExpensesList(); // DELETE
     this.renderIncomesList(); // DELETE

     Replace with:
     if (this.expenseIncomeController) {
     this.expenseIncomeController.renderExpensesList();
     this.expenseIncomeController.renderIncomesList();
     }

6. Update AppController constructor to pass expenseIncomeController to PlanController:
   - After creating this.expenseIncomeController:
     this.planController = new PlanController(this.currentPlan, StorageManager, this.accountController, this.expenseIncomeController);

**Step 2: Update src/ui/PlanController.js:**

1. Update constructor parameters:
   constructor(currentPlan, StorageManager, accountController, expenseIncomeController)

2. Store as instance properties:
   this.accountController = accountController;
   this.expenseIncomeController = expenseIncomeController;

3. In renderPlanUI(), replace render calls with delegations (as described in Step 1.5 above)
   </action>
   <verify>grep -c "this.expenseIncomeController\." src/ui/AppController.js (should count ~12 delegations)</verify>
   <done>AppController and PlanController delegate all expense/income management to ExpenseIncomeController</done>
   </task>

<task type="auto">
  <name>Task 3: Run linter and formatter, verify functionality</name>
  <files>src/ui/AppController.js, src/ui/ExpenseIncomeController.js, src/ui/PlanController.js</files>
  <action>1. Run Prettier: npx prettier --write src/ui/ExpenseIncomeController.js src/ui/AppController.js src/ui/PlanController.js

2. Run ESLint: npx eslint src/ui/ExpenseIncomeController.js src/ui/AppController.js src/ui/PlanController.js

3. Fix any lint errors (follow Phase 1 conventions)

4. Manual verification:
   - Load a plan
   - Click Expenses tab
   - Expenses list renders
   - Click + Add Expense button
   - Fill form, click Add
   - Expense appears in list
   - Click Delete button
   - Confirm deletion
   - Expense removed
   - Click Income tab
   - Income list renders
   - Click + Add Income button
   - Fill form (try smart rules), click Add
   - Income appears in list
   - Test toggle fields for smart rules
   - Click Delete button
   - Confirm deletion
   - Income removed

All expense and income functionality should work identically to before refactoring.
</action>
<verify>npx eslint src/ui/ExpenseIncomeController.js src/ui/AppController.js src/ui/PlanController.js passes with no errors (pre-existing errors ignored)</verify>
<done>Code formatted, no new lint errors, all expense/income management functionality works correctly</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] src/ui/ExpenseIncomeController.js created and exports ExpenseIncomeController class
- [ ] AppController delegates all expense/income methods to ExpenseIncomeController
- [ ] PlanController integrates with ExpenseIncomeController for rendering
- [ ] npx prettier --write passes for all modified files
- [ ] npx eslint passes with no new errors
- [ ] Manual test: Add expense, delete expense, add income, delete income, toggle fields work
</verification>

<success_criteria>

- ExpenseIncomeController.js created with ~225 lines of expense/income management logic
- AppController delegates all expense/income CRUD methods to ExpenseIncomeController
- PlanController.renderPlanUI() integrates with ExpenseIncomeController
- All existing expense and income functionality works identically
- ~225 lines extracted from AppController
  </success_criteria>

<output>
After completion, create `.planning/phases/03-ui-refactor/03-03-SUMMARY.md`:

# Phase 03-03: Extract Expense and Income Management Summary

**Extracted expense and income management logic (list, add, delete) to dedicated ExpenseIncomeController module**

## Accomplishments

- Created src/ui/ExpenseIncomeController.js with expense and income CRUD methods
- Extracted ~225 lines from AppController.js
- PlanController integrates with ExpenseIncomeController for rendering
- All expense and income operations work correctly

## Files Created/Modified

- `src/ui/ExpenseIncomeController.js` - New module with expense/income management methods
- `src/ui/AppController.js` - Updated to delegate to ExpenseIncomeController
- `src/ui/PlanController.js` - Updated constructor to accept expenseIncomeController

## Decisions Made

- Combined expense and income into one controller (similar patterns, shared UI)
- PlanController accepts expenseIncomeController in constructor for proper integration
- Modal helpers remain in AppController for shared use
- Global window.app maintained for onclick compatibility

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-04-PLAN.md (Refactor AppController as Coordinator)
</output>
