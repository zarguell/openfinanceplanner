---
phase: 03-ui-refactor
plan: 03-04
type: execute
subsystem: ui-controllers
tags: [refactoring, projection-controller, finalization, coordinator]
requires:
  - 03-03-SUMMARY.md
provides:
  - ProjectionController module
  - Refactored AppController as thin coordinator
affects:
  - src/ui/AppController.js
  - src/ui/ProjectionController.js (new)
  - index.html (optional - to update window.app references)
tech-stack:
  - Pure Vanilla JavaScript (ES2020+) ES6 Modules
  - No runtime dependencies
  - ESLint 9.x flat config
  - Prettier 3.x
key-files:
  - src/ui/ProjectionController.js (new)
  - src/ui/AppController.js (modified)
key-decisions:
  - Extract projection and Monte Carlo logic to ProjectionController
  - AppController becomes thin coordinator (initializes controllers, delegates)
  - Keep delegator methods for window.app compatibility (HTML updates deferred to future phase)
  - ChartRenderer stays as-is (already well-structured)
metrics:
  duration: ~8 min
  files_created: 1
  files_modified: 1-2
  lines_extracted: ~235
---

<objective>
Extract projection logic and refactor AppController as thin coordinator.

Purpose: Complete UI Controller refactor by extracting projection/Monte Carlo rendering logic to ProjectionController, making AppController a simple coordinator that initializes and delegates to specialized controllers.

Output: ProjectionController.js (~235 lines) with projection rendering, AppController reduced to ~150 lines of coordination code.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ui-refactor/03-01-SUMMARY.md
@.planning/phases/03-ui-refactor/03-02-SUMMARY.md
@.planning/phases/03-ui-refactor/03-03-SUMMARY.md
@src/ui/AppController.js
@src/ui/ChartRenderer.js

**Tech stack available:**

- Pure Vanilla JavaScript (ES2020+) ES6 Modules
- ESLint 9.x flat config
- Prettier 3.x
- Chart.js (CDN dependency)

**Established patterns:**

- From 03-01 to 03-03: Extract to dedicated controllers, delegate from AppController
- PlanController accepts child controllers for integration
- ChartRenderer.js (440 lines) already handles chart creation
- Modal helpers (openModal, closeModal, escapeHtml) remain in AppController

**What remains in AppController after previous plans:**

- Projection methods: runProjection(), runMonteCarlo(), renderProjectionResults() (~235 lines, 433-665)
- Constructor (initializes all controllers)
- init() (calls loadPlansList())
- Delegator methods for all controllers
- Modal helpers

**Constraining decisions:**

- Maintain backward compatibility with onclick="app.\*()" in index.html
- HTML updates (remove global app dependency) deferred to Phase 5 or later
- ChartRenderer stays as-is, called by ProjectionController

**Issues being addressed:** None (refactoring goal)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectionController module with projection rendering methods</name>
  <files>src/ui/ProjectionController.js</files>
  <action>Create src/ui/ProjectionController.js class with:

1. Constructor taking (currentPlan, chartRenderer)
2. Projection execution methods:
   - runProjection() - runs deterministic projection, runs Monte Carlo (1000 scenarios), renders results, switches to projection tab
     - Calls project(this.currentPlan, 40, 2025) from '../calculations/projection.js'
     - Calls runMonteCarloSimulation(this.currentPlan, 1000, 40, 2025) from '../calculations/monte-carlo.js'
     - Stores results in this.projectionResults, this.monteCarloResults
     - Calls this.renderProjectionResults()
     - Calls switchTab('projection')

   - runMonteCarlo() - runs Monte Carlo only (re-runs simulation, renders)
     - Same as runProjection but only Monte Carlo, skips deterministic projection

3. Rendering method:
   - renderProjectionResults() - renders projection UI (lines 461-665 in AppController):
     - Final balance, retirement balance cards
     - Monte Carlo analysis section (success probability, average final balance, percentiles, analysis text)
     - Balance projection chart (calls this.chartRenderer.createBalanceChart())
     - Monte Carlo fan chart (if monteCarloResults exists, calls this.chartRenderer.createMonteCarloFanChart())
     - Asset allocation chart (calls this.chartRenderer.createAllocationChart())
     - Income vs Expenses chart (calls this.chartRenderer.createCashFlowChart())
     - Tax breakdown summary cards (federal, state, FICA, RMD totals)
     - Year-by-year projection table (year, age, balance, expenses, SS income, taxes, status)

4. Helper method:
   - escapeHtml(text) - prevents XSS

Import dependencies:

- { project } from '../calculations/projection.js'
- { runMonteCarloSimulation, getSuccessProbabilityWithConfidence } from '../calculations/monte-carlo.js'
- { ChartRenderer } from './ChartRenderer.js'

Use this.currentPlan reference and this.chartRenderer for rendering. Follow existing AppController code structure for these methods (lines 433-665).
</action>
<verify>src/ui/ProjectionController.js exists, exports ProjectionController class, has methods (check with: grep -E "^\s+(runProjection|runMonteCarlo|renderProjectionResults)" src/ui/ProjectionController.js)</verify>
<done>ProjectionController class created with all projection rendering methods extracted from AppController</done>
</task>

<task type="auto">
  <name>Task 2: Update AppController to delegate to ProjectionController and refactor as coordinator</name>
  <files>src/ui/AppController.js</files>
  <action>Update src/ui/AppController.js:

**Step 1: Add import and create ProjectionController:**

1. Add import: import { ProjectionController } from './ProjectionController.js'

2. In constructor, after all controller initializations:
   - Create: this.projectionController = new ProjectionController(this.currentPlan, this.chartRenderer)

**Step 2: Remove projection methods from AppController:**

3. Delete these methods from AppController (now in ProjectionController):
   - runProjection() - DELETE this entire method (~15 lines)
   - runMonteCarlo() - DELETE this entire method (~10 lines)
   - renderProjectionResults() - DELETE this entire method (~210 lines)

**Step 3: Add projection delegators:**

4. Add delegator methods to AppController (for window.app compatibility):
   - runProjection() {
     const result = this.projectionController.runProjection();
     this.projectionResults = this.projectionController.projectionResults;
     this.monteCarloResults = this.projectionController.monteCarloResults;
     return result;
     }

   - runMonteCarlo() {
     const result = this.projectionController.runMonteCarlo();
     this.projectionResults = this.projectionController.projectionResults;
     this.monteCarloResults = this.projectionController.monteCarloResults;
     return result;
     }

   - renderProjectionResults() {
     return this.projectionController.renderProjectionResults();
     }

**Step 4: Update currentPlan sync in other delegators:**

5. Review all delegator methods (plan, account, expense, income) and ensure they update AppController's references:
   - planController delegators (from 03-01): Already update this.currentPlan after createNewPlan, loadPlan, deletePlan, savePlanSettings, saveSocialSecurity
   - accountController delegators (from 03-02): Already update this.currentPlan after saveEditAccount
   - expenseIncomeController delegators (from 03-03): No currentPlan sync needed (they update currentPlan.expenses/incomes directly)

   Verify these are correct. If not, add updates as needed.

**Step 5: Final cleanup - AppController is now thin coordinator:**

6. AppController should now have only:
   - Constructor (~30 lines) - initializes all controllers
   - init() (~2 lines) - calls this.loadPlansList()
   - Delegator methods for all controllers (~40 lines total: 4-5 per controller)
   - Modal helpers: openModal(), closeModal(), escapeHtml() (~20 lines)
   - Any remaining UI helpers (if any)

   Total should be ~100-150 lines (down from 1,443)

7. Ensure ChartRenderer instance is shared:
   - Constructor creates: this.chartRenderer = new ChartRenderer()
   - Pass this.chartRenderer to ProjectionController: new ProjectionController(this.currentPlan, this.chartRenderer)
   - Don't create a second ChartRenderer instance

**Step 6: Update ProjectionController constructor to sync currentPlan:**

8. In ProjectionController.runProjection(), after updating projection results:
   - Update AppController's currentPlan reference via callback or setter
   - Actually, currentPlan doesn't change during projection, so no sync needed
   - But projectionResults and monteCarloResults should be synced via delegation (as done in Step 3.4)

</action>
  <verify>wc -l src/ui/AppController.js (should be ~150 lines, down from 1,443)</verify>
  <done>AppController reduced to thin coordinator, delegates projection to ProjectionController</done>
</task>

<task type="auto">
  <name>Task 3: Run linter and formatter, verify functionality</name>
  <files>src/ui/AppController.js, src/ui/ProjectionController.js</files>
  <action>1. Run Prettier: npx prettier --write src/ui/ProjectionController.js src/ui/AppController.js

2. Run ESLint: npx eslint src/ui/ProjectionController.js src/ui/AppController.js

3. Fix any lint errors (follow Phase 1 conventions)

4. Manual verification (open index.html in browser):
   - Create new plan with account
   - Add income and expense
   - Click Run Projection button
   - Projection tab opens with results
   - Charts render correctly (balance, allocation, income vs expenses)
   - Monte Carlo section displays success probability
   - Year-by-year table shows data
   - Click Run Monte Carlo button
   - Results re-render correctly

5. Verify all previous functionality still works:
   - Plan list renders
   - Tab switching works
   - Add/edit/delete accounts works
   - Add/delete expenses and income works
   - Settings modal saves
   - Import/Export works

All functionality should work identically to before refactoring.
</action>
<verify>npx eslint src/ui/ProjectionController.js src/ui/AppController.js passes with no errors (pre-existing errors ignored)</verify>
<done>Code formatted, no new lint errors, all projection and UI functionality works correctly</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>AppController refactored to thin coordinator with 4 specialized controllers</what-built>
  <how-to-verify>
    1. Run: npm run lint (or npx eslint src/)
    2. Confirm: No new lint errors (only pre-existing issues from Phase 1)
    3. Check: wc -l src/ui/AppController.js shows ~150 lines (down from 1,443)
    4. Check: ls -la src/ui/ shows PlanController.js, AccountController.js, ExpenseIncomeController.js, ProjectionController.js
    5. Manual test in browser:
       - Create new plan
       - Add accounts, expenses, income
       - Run projection
       - Verify all charts render
       - Verify all CRUD operations work
       - Verify Settings modal works
    6. Confirm: No functionality broken compared to before refactoring
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] src/ui/ProjectionController.js created and exports ProjectionController class
- [ ] AppController delegates projection methods to ProjectionController
- [ ] AppController reduced to ~150 lines (thin coordinator)
- [ ] npx prettier --write passes for all files
- [ ] npx eslint passes with no new errors
- [ ] Manual test: All UI flows work correctly (plans, accounts, expenses, income, projection)
- [ ] Human verification approved
</verification>

<success_criteria>

- ProjectionController.js created with ~235 lines of projection rendering logic
- AppController reduced to ~150 lines (thin coordinator pattern)
- All UI controllers (Plan, Account, ExpenseIncome, Projection) properly extracted
- All existing functionality works identically
- ~1,200 lines extracted from AppController (from 1,443 to ~150)
- Code is formatted and passes lint (no new errors)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-ui-refactor/03-04-SUMMARY.md`:

# Phase 03-04: Refactor AppController as Coordinator Summary

**Extracted projection logic and refactored AppController to thin coordinator pattern**

## Accomplishments

- Created src/ui/ProjectionController.js with projection and Monte Carlo rendering
- Extracted ~235 lines from AppController.js
- AppController reduced from 1,443 lines to ~150 lines (90% reduction)
- 4 specialized controllers created (Plan, Account, ExpenseIncome, Projection)
- All UI functionality works correctly

## Files Created/Modified

- `src/ui/ProjectionController.js` - New module with projection rendering
- `src/ui/AppController.js` - Refactored to thin coordinator (~150 lines)

## Module Structure

```
src/ui/
├── AppController.js (~150 lines - coordinator)
│   ├── Constructor initializes all controllers
│   ├── Delegates to PlanController (plan CRUD)
│   ├── Delegates to AccountController (account CRUD)
│   ├── Delegates to ExpenseIncomeController (expense/income CRUD)
│   ├── Delegates to ProjectionController (projection rendering)
│   ├── Shared modal helpers (openModal, closeModal, escapeHtml)
│   └── init() method
├── PlanController.js (~300 lines)
├── AccountController.js (~150 lines)
├── ExpenseIncomeController.js (~225 lines)
├── ProjectionController.js (~235 lines)
└── ChartRenderer.js (440 lines - unchanged, already well-structured)
```

**Total reduction:** 1,443 lines → ~1,500 lines (4 controllers) + 150 lines (coordinator) = 90% code reduction in main file

## Decisions Made

- ProjectionController uses existing ChartRenderer for chart creation
- Delegator methods kept in AppController for window.app compatibility (HTML updates deferred)
- Modal helpers remain in AppController for shared access
- All controllers maintain currentPlan reference for CRUD operations

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

✅ **Phase 3 complete!** All UI logic extracted to focused controllers. AppController now a thin coordinator pattern matching architectural best practices. Ready for Phase 4 (Configuration Centralization).

## Metrics

- **Original AppController.js:** 1,443 lines
- **Refactored:**
  - AppController.js: ~150 lines (coordinator)
  - PlanController.js: ~300 lines (plan management)
  - AccountController.js: ~150 lines (account management)
  - ExpenseIncomeController.js: ~225 lines (expense/income management)
  - ProjectionController.js: ~235 lines (projection rendering)
  - ChartRenderer.js: 440 lines (unchanged, already well-structured)
- **Code organization:** 5 focused modules instead of 1 monolithic controller
- **Maintainability:** Each controller has single responsibility
  </output>
