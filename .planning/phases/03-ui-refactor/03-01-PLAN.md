---
phase: 03-ui-refactor
plan: 03-01
type: execute
subsystem: ui-controllers
tags: [refactoring, plan-management, modularization, extraction]
requires:
  - 02-04-SUMMARY.md
provides:
  - PlanController module
  - Extracted plan CRUD logic
affects:
  - src/ui/AppController.js
  - src/ui/PlanController.js (new)
tech-stack:
  - Pure Vanilla JavaScript (ES2020+) ES6 Modules
  - No runtime dependencies
  - ESLint 9.x flat config
  - Prettier 3.x
key-files:
  - src/ui/PlanController.js (new)
  - src/ui/AppController.js (modified)
key-decisions:
  - Extract plan management, settings, import/export, Social Security to PlanController
  - Keep AppController methods as delegators to maintain backward compatibility with window.app calls
  - PlanController will have currentPlan reference for CRUD operations
metrics:
  duration: ~10 min
  files_created: 1
  files_modified: 1
  lines_extracted: ~300
---

<objective>
Extract plan management logic from AppController to dedicated PlanController module.

Purpose: Reduce AppController.js complexity by isolating plan CRUD operations, settings, import/export, and Social Security management into focused module. Pattern established by Phase 2 tax refactor.

Output: PlanController.js (~300 lines) with plan management methods, AppController updated to delegate.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tax-refactor/02-04-SUMMARY.md
@src/ui/AppController.js

**Tech stack available:**

- Pure Vanilla JavaScript (ES2020+) ES6 Modules (from Phase 1)
- ESLint 9.x flat config (from Phase 1)
- Prettier 3.x (from Phase 1)
- Chart.js (CDN dependency)

**Established patterns (from Phase 2 tax refactor):**

- Extract focused modules for specific responsibilities
- Use ES6 import/export for clean separation
- Maintain backward compatibility via re-exports or delegation
- Keep domain objects intact (Plan, Account, Expense models)

**Constraining decisions:**

- Phase 1: ESLint 9.x flat config, Prettier for formatting
- Phase 2: Modular extraction pattern, maintain backward compatibility with existing imports
- ChartRenderer.js already exists (440 lines) - don't duplicate chart logic

**Issues being addressed:** None from ISSUES.md (refactoring goal)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlanController module with plan management methods</name>
  <files>src/ui/PlanController.js</files>
  <action>Create src/ui/PlanController.js class with:

1. Constructor taking (currentPlan, StorageManager)
2. Plan CRUD methods:
   - loadPlansList() - renders plan list to DOM
   - loadPlan(planId) - loads plan from StorageManager, reconstructs domain objects, triggers renderPlanUI
   - renderPlanUI() - renders tabbed interface (overview, assumptions, socialsecurity, income, accounts, expenses, projection)
   - populateAssumptionFields() - populates assumption input fields from currentPlan.assumptions
   - populateSocialSecurityFields() - populates SS fields from currentPlan.socialSecurity
   - createNewPlan() - validates inputs, creates new Plan with defaults, saves, loads it
   - deletePlan() - confirms, deletes, resets state
   - switchTab(tabName) - hides all tabs, shows selected tab
   - saveAssumptions() - reads assumption inputs, updates plan, saves

3. Plan settings methods:
   - showPlanSettingsModal() - renders settings modal with plan name, ages, tax rate, withdrawal strategy, Roth conversions, QCD, tax loss harvesting
   - savePlanSettings() - reads all settings inputs, updates plan, saves, re-renders

4. Social Security methods:
   - toggleSocialSecurity() - shows/hides SS fields
   - saveSocialSecurity() - reads SS inputs, calculates estimates (import social-security.js dynamically), updates plan, saves

5. Import/Export methods:
   - showImportModal() - opens import modal
   - importPlan() - processes text or file input, calls StorageManager.importPlan, saves, loads plan
   - exportCurrentPlan() - calls StorageManager.exportPlan, creates blob, triggers download

6. UI helpers:
   - escapeHtml(text) - prevents XSS

Import dependencies: { Plan, Account, Expense, Income } from '../core/models/', { StorageManager } from '../storage/StorageManager.js', { ChartRenderer } from './ChartRenderer.js'

Use this.currentPlan reference for all CRUD operations. Follow existing AppController code structure, just move methods to PlanController class.
</action>
<verify>src/ui/PlanController.js exists, exports PlanController class, has all required methods (check with: grep -E "^\s+(loadPlansList|loadPlan|renderPlanUI|showPlanSettingsModal|savePlanSettings|toggleSocialSecurity|saveSocialSecurity|showImportModal|importPlan|exportCurrentPlan|escapeHtml)" src/ui/PlanController.js)</verify>
<done>PlanController class created with all plan management methods extracted from AppController</done>
</task>

<task type="auto">
  <name>Task 2: Update AppController to delegate to PlanController</name>
  <files>src/ui/AppController.js</files>
  <action>Update src/ui/AppController.js:

1. Add import: import { PlanController } from './PlanController.js'

2. In constructor, after this.chartRenderer initialization:
   - Create: this.planController = new PlanController(this.currentPlan, StorageManager)

3. For each of these methods in AppController, change to delegate to this.planController:
   - loadPlansList() → return this.planController.loadPlansList()
   - loadPlan(planId) → return this.planController.loadPlan(planId)
   - renderPlanUI() → return this.planController.renderPlanUI()
   - populateAssumptionFields() → return this.planController.populateAssumptionFields()
   - populateSocialSecurityFields() → return this.planController.populateSocialSecurityFields()
   - switchTab(tabName) → return this.planController.switchTab(tabName)
   - saveAssumptions() → return this.planController.saveAssumptions()
   - showNewPlanModal() → return this.planController.showNewPlanModal()
   - createNewPlan() → return this.planController.createNewPlan()
   - deletePlan() → return this.planController.deletePlan()
   - showPlanSettingsModal() → return this.planController.showPlanSettingsModal()
   - savePlanSettings() → return this.planController.savePlanSettings()
   - toggleSocialSecurity() → return this.planController.toggleSocialSecurity()
   - saveSocialSecurity() → return this.planController.saveSocialSecurity()
   - showImportModal() → return this.planController.showImportModal()
   - importPlan() → return this.planController.importPlan()
   - exportCurrentPlan() → return this.planController.exportCurrentPlan()

4. Keep these methods in AppController (do NOT delete):
   - Constructor (now creates planController)
   - init() (calls this.loadPlansList())
   - runProjection() (stays - projection logic)
   - runMonteCarlo() (stays - projection logic)
   - renderProjectionResults() (stays - projection UI)
   - All account/expense/income methods (stay - extracted in later plans)
   - Modal helpers: openModal(), closeModal() (stay - used by all controllers)
   - escapeHtml() - keep for convenience (even though PlanController has its own)

5. When calling delegated methods that update this.currentPlan, update AppController's this.currentPlan reference:
   - In createNewPlan delegation: this.currentPlan = this.planController.currentPlan
   - In loadPlan delegation: this.currentPlan = this.planController.currentPlan
   - In deletePlan delegation: this.currentPlan = this.planController.currentPlan
   - In savePlanSettings delegation: this.currentPlan = this.planController.currentPlan
   - In saveSocialSecurity delegation: this.currentPlan = this.planController.currentPlan

This maintains window.app compatibility while delegating to PlanController.
</action>
<verify>grep -c "this.planController\." src/ui/AppController.js (should count ~18-20 delegations)</verify>
<done>AppController delegates all plan management methods to PlanController, maintains window.app compatibility</done>
</task>

<task type="auto">
  <name>Task 3: Run linter and formatter, verify functionality</name>
  <files>src/ui/AppController.js, src/ui/PlanController.js</files>
  <action>1. Run Prettier: npx prettier --write src/ui/PlanController.js src/ui/AppController.js

2. Run ESLint: npx eslint src/ui/PlanController.js src/ui/AppController.js

3. Fix any lint errors (should be minimal if following Phase 1 conventions):
   - Use single quotes, semicolons, 2-space indentation
   - No unused vars (use \_ prefix for intentionally unused)
   - No console errors or warnings in production code

4. Manual verification (open index.html in browser):
   - Create new plan (+ New Plan button)
   - Plan appears in sidebar
   - Load plan by clicking it
   - Tab switching works (Overview, Assumptions, Social Security, Income, Accounts, Expenses, Projection)
   - Settings modal opens and saves
   - Import/Export buttons work
   - Delete plan works
   - Run Projection still works

All existing functionality should work identically to before refactoring.
</action>
<verify>npx eslint src/ui/PlanController.js src/ui/AppController.js passes with no errors (pre-existing errors in AppController ignored)</verify>
<done>Code formatted, no new lint errors, all plan management functionality works correctly</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] src/ui/PlanController.js created and exports PlanController class
- [ ] AppController delegates all plan management methods to PlanController
- [ ] npx prettier --write src/ui/PlanController.js src/ui/AppController.js passes
- [ ] npx eslint src/ui/PlanController.js src/ui/AppController.js passes (no new errors)
- [ ] Manual test: Create new plan, load plan, switch tabs, save settings, import/export, delete plan
- [ ] Run Projection still works (delegation doesn't break projection)
</verification>

<success_criteria>

- PlanController.js created with ~300 lines of plan management logic
- AppController delegates all plan CRUD methods to PlanController
- All existing plan management functionality works identically
- Code is formatted and passes lint (no new errors)
- ~300 lines extracted from AppController
  </success_criteria>

<output>
After completion, create `.planning/phases/03-ui-refactor/03-01-SUMMARY.md`:

# Phase 03-01: Extract Plan Management Summary

**Extracted plan management logic (CRUD, settings, import/export, Social Security) to dedicated PlanController module**

## Accomplishments

- Created src/ui/PlanController.js with plan management methods
- Extracted ~300 lines from AppController.js
- AppController delegates all plan management to PlanController
- All plan CRUD operations work correctly

## Files Created/Modified

- `src/ui/PlanController.js` - New module with plan management methods
- `src/ui/AppController.js` - Updated to delegate to PlanController

## Decisions Made

- Keep AppController delegator methods for backward compatibility with window.app calls
- PlanController maintains currentPlan reference and syncs with AppController
- Modal helpers (openModal, closeModal, escapeHtml) kept in AppController for shared use

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-02-PLAN.md (Extract Account Management)
</output>
