---
phase: 10-critical-user-flow-e2e-tests
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/calculations/tax.test.js
  - tests/unit/calculations/rmd.test.js
autonomous: true

must_haves:
  truths:
    - "Unit tests validate all tax calculation functions (federal, state, FICA, capital gains, NIIT)"
    - "Unit tests validate all RMD calculation functions (calculateRMD, mustTakeRMD, getRMDDeadline)"
    - "Tests cover edge cases (zero income, negative values, invalid filing status, special account types)"
    - "Tests cover 2024 and 2025 tax year variations"
  artifacts:
    - path: "tests/unit/calculations/tax.test.js"
      provides: "Comprehensive unit tests for tax calculations"
      min_lines: 200
    - path: "tests/unit/calculations/rmd.test.js"
      provides: "Comprehensive unit tests for RMD calculations"
      min_lines: 150
  key_links:
    - from: "tests/unit/calculations/tax.test.js"
      to: "src/calculations/tax.js"
      via: "import of all tax calculation functions"
      pattern: "import.*from.*tax"
    - from: "tests/unit/calculations/rmd.test.js"
      to: "src/calculations/rmd.js"
      via: "import of all RMD calculation functions"
      pattern: "import.*from.*rmd"
    - from: "tests/unit/calculations/tax.test.js"
      to: "src/calculations/tax/federal.js"
      via: "import of federal tax functions"
      pattern: "import.*federal"
    - from: "tests/unit/calculations/tax.test.js"
      to: "src/calculations/tax/states.js"
      via: "import of state tax functions"
      pattern: "import.*states"
---

<objective>
Expand unit tests for tax and RMD calculation functions to achieve comprehensive coverage of all critical calculation paths as required by COV-04. Add tests for untested functions, edge cases, and tax year variations (2024 vs 2025).

Purpose: Complete COV-04 requirement that "all critical calculation paths have tests (tax, RMD, projections)." Currently only projections are fully tested (10-03, 10-04). Tax and RMD calculations have basic tests but missing coverage for state tax, calculateTotalTax, getRMDDeadline, edge cases, and year variations.

Output: Expanded tax.test.js with 15-20 additional tests (total 25+ tests) and expanded rmd.test.js with 8-10 additional tests (total 18+ tests). Combined coverage increases tax calculations from ~30% to 70%+ and RMD from ~40% to 80%+.
</objective>

<execution_context>
@/Users/zach/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zach/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-critical-user-flow-e2e-tests/10-RESEARCH.md
@src/calculations/tax.js
@src/calculations/rmd.js
@src/calculations/tax/federal.js
@src/calculations/tax/states.js
@tests/unit/calculations/tax.test.js
@tests/unit/calculations/rmd.test.js
</context>

<tasks>

<task type="auto">
  <name>Add tests for calculateTotalTax with state variations</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>
Add describe block for calculateTotalTax function with tests:

1. 'should calculate total tax with federal + state for CA':
   - Import calculateTotalTax from tax.js
   - Call calculateTotalTax('CA', 5000000, 'single', 2025)
   - Verify returns object with federalTax, stateTax, totalTax
   - Verify totalTax === federalTax + stateTax
   - Verify stateTax > 0 for California

2. 'should calculate total tax with no state (null)':
   - Call calculateTotalTax(null, 5000000, 'single', 2025)
   - Verify stateTax === 0
   - Verify totalTax === federalTax

3. 'should calculate total tax for DC with different brackets':
   - Call calculateTotalTax('DC', 10000000, 'married_joint', 2025)
   - Verify DC tax calculated (DC has flat tax rate)

4. 'should calculate total tax for NY with progressive brackets':
   - Call calculateTotalTax('NY', 50000000, 'single', 2025)
   - Verify NY tax uses progressive brackets

5. 'should return 0 total tax for zero income':
   - Call calculateTotalTax('CA', 0, 'single', 2025)
   - Verify all tax values are 0

Reference: src/calculations/tax.js calculateTotalTax function combines federal + state
  </action>
  <verify>Tests validate calculateTotalTax with state variations and edge cases</verify>
  <done>calculateTotalTax tests cover multi-state and null state scenarios</done>
</task>

<task type="auto">
  <name>Add tests for Social Security wage base variations (2024 vs 2025)</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>
Add tests for calculateSocialSecurityTax with year variations:

1. 'should calculate SS tax with 2024 wage base ($168,600)':
   - Call calculateSocialSecurityTax(16860000, 2024)
   - Verify exact tax: 16860000 * 0.062 = 1045320
   - Verify tax stops at wage base (no additional tax beyond)

2. 'should calculate SS tax with 2025 wage base ($176,100)':
   - Call calculateSocialSecurityTax(17610000, 2025)
   - Verify exact tax: 17610000 * 0.062 = 1091820

3. 'should cap SS tax at wage base for high income':
   - Test with wages = 50000000 (exceeds wage base)
   - For 2025: verify tax === 17610000 * 0.062 (capped)
   - For 2024: verify tax === 16860000 * 0.062 (capped)

4. 'should calculate SS tax proportionally for wages under base':
   - Call calculateSocialSecurityTax(10000000, 2025)
   - Verify exact tax: 10000000 * 0.062 = 620000

Reference: src/calculations/tax.js calculateSocialSecurityTax uses different wage bases by year
  </action>
  <verify>Tests validate SS tax calculation with year-specific wage bases</verify>
  <done>SS tax tests cover 2024/2025 variations and capping at wage base</done>
</task>

<task type="auto">
  <name>Add tests for Medicare tax with additional tax threshold</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>
Add tests for calculateMedicareTax with high income:

1. 'should calculate base Medicare tax (1.45%)':
   - Call calculateMedicareTax(10000000, 'single', 2025)
   - Verify exact tax: 10000000 * 0.0145 = 145000

2. 'should add additional Medicare tax (0.9%) above $200k':
   - Call calculateMedicareTax(25000000, 'single', 2025)
   - Base: 25000000 * 0.0145 = 362500
   - Additional: (25000000 - 20000000) * 0.009 = 45000
   - Verify total === 362500 + 45000 = 407500

3. 'should calculate additional Medicare tax for wages exactly at threshold':
   - Call calculateMedicareTax(20000000, 'single', 2025)
   - Verify no additional tax (exactly at threshold)
   - Verify tax === 20000000 * 0.0145 = 290000

4. 'should calculate additional Medicare tax for married filing separately':
   - Threshold is same $200k for all filing statuses in 2024/2025
   - Test with 25000000 income
   - Verify additional tax applies

Reference: src/calculations/tax.js calculateMedicareTax with 0.9% additional rate above $200k
  </action>
  <verify>Tests validate Medicare tax with additional tax for high earners</verify>
  <done>Medicare tax tests cover base rate and additional tax threshold</done>
</task>

<task type="auto">
  <name>Add tests for calculateFicaTax combined function</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>
Add tests for calculateFicaTax function:

1. 'should calculate combined FICA tax correctly':
   - Call calculateFicaTax(10000000, 'single', 2025)
   - Verify ssTax === 620000 (6.2%)
   - Verify medicareTax === 145000 (1.45%)
   - Verify totalFicaTax === 765000 (7.65%)

2. 'should return breakdown with all tax components':
   - Verify return object has: ssTax, medicareTax, totalFicaTax
   - Verify totalFicaTax === ssTax + medicareTax

3. 'should handle zero wages':
   - Call calculateFicaTax(0, 'single', 2025)
   - Verify all components return 0

4. 'should cap SS tax while Medicare continues uncapped':
   - Call calculateFicaTax(50000000, 'single', 2025)
   - Verify ssTax capped at 1091820 (2025 wage base)
   - Verify medicareTax includes additional tax
   - Verify totalFicaTax = capped ss + full medicare

Reference: src/calculations/tax.js calculateFicaTax combines SS and Medicare
  </action>
  <verify>Tests validate FICA tax breakdown with correct components</verify>
  <done>FICA tax tests verify combined calculation and component breakdown</done>
</task>

<task type="auto">
  <name>Add tests for state tax calculations (CA, DC, NY)</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>
Add tests for calculateStateTax and related functions:

1. 'should calculate California state tax with progressive brackets':
   - Import calculateStateTax from tax.js
   - Call calculateStateTax('CA', 5000000, 'single', 2025)
   - Verify tax > 0 (California has income tax)

2. 'should calculate DC tax with flat rate':
   - Call calculateStateTax('DC', 10000000, 'single', 2025)
   - DC uses flat rate, verify calculation

3. 'should calculate NY tax with progressive brackets':
   - Call calculateStateTax('NY', 50000000, 'single', 2025)
   - Verify tax calculated correctly

4. 'should return 0 tax for null state':
   - Call calculateStateTax(null, 5000000, 'single', 2025)
   - Verify returns 0

5. 'should return 0 tax for zero income':
   - Call calculateStateTax('CA', 0, 'single', 2025)
   - Verify returns 0

6. 'should get state standard deduction':
   - Import getStateStandardDeduction from tax.js
   - Call getStateStandardDeduction('CA', 2025, 'single')
   - Verify returns deduction value

7. 'should get state tax brackets':
   - Import getStateTaxBrackets from tax.js
   - Call getStateTaxBrackets('CA', 2025, 'single')
   - Verify returns array of brackets

Reference: src/calculations/tax/states.js for state tax functions
  </action>
  <verify>Tests validate state tax calculations for multiple states</verify>
  <done>State tax tests cover CA, DC, NY with progressive and flat rate structures</done>
</task>

<task type="auto">
  <name>Add tests for long-term capital gains with all filing statuses</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>
Add tests for calculateLongTermCapitalGainsTax edge cases:

1. 'should calculate LTCG for head of household':
   - Not currently tested, existing tests only cover single and married_joint
   - Call calculateLongTermCapitalGainsTax(10000000, 'head_of_household', 2025)
   - Verify 0% bracket up to $73,810

2. 'should calculate LTCG for married filing separately':
   - Call calculateLongTermCapitalGainsTax(10000000, 'married_separate', 2025)
   - Verify brackets match single filer brackets

3. 'should calculate LTCG crossing all three brackets (0%, 15%, 20%)':
   - Use gain that exceeds 15% bracket threshold
   - Verify tax calculated for all three rate tiers

4. 'should return 0 LTCG for gain entirely in 0% bracket':
   - Call calculateLongTermCapitalGainsTax(4000000, 'single', 2025)
   - 2025 0% bracket goes to $49,205, so $40,000 gain should be 0 tax

5. 'should calculate LTCG for 2024 vs 2025 bracket differences':
   - Test same income with year: 2024 vs 2025
   - Verify different thresholds (2024: $48,925, 2025: $49,205 for 0% bracket)

Reference: src/calculations/tax.js LTCG_BRACKETS_2024 and LTCG_BRACKETS_2025
  </action>
  <verify>Tests validate LTCG for all filing statuses and bracket transitions</verify>
  <done>LTCG tests cover head_of_household, married_separate, and year variations</done>
</task>

<task type="auto">
  <name>Add tests for calculateCapitalGainsTax combined function</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>
Add tests for calculateCapitalGainsTax function:

1. 'should combine long-term and short-term gains correctly':
   - Call calculateCapitalGainsTax(5000000, 2000000, 15000000, 'single', 2025)
   - Verify ordinaryTax === longTermTax + shortTermTax
   - Verify niit calculated on total capital gains (7000000)

2. 'should calculate NIIT only when MAGI exceeds threshold':
   - Below threshold: MAGI 15000000, verify niit === 0
   - Above threshold: MAGI 25000000, verify niit > 0

3. 'should limit NIIT by investment income':
   - Test where MAGI - threshold > investmentIncome
   - Verify niit calculated on investmentIncome (not excess MAGI)

4. 'should handle zero gains':
   - Call calculateCapitalGainsTax(0, 0, 15000000, 'single', 2025)
   - Verify all components return 0

5. 'should handle only long-term gains':
   - Call calculateCapitalGainsTax(5000000, 0, 25000000, 'single', 2025)
   - Verify shortTermTax === 0, niit > 0

Reference: src/calculations/tax.js calculateCapitalGainsTax combines LT/ST + NIIT
  </action>
  <verify>Tests validate combined capital gains tax calculation</verify>
  <done>Capital gains tests verify NIIT calculation and combined LT/ST handling</done>
</task>

<task type="auto">
  <name>Add tests for RMD deadline function</name>
  <files>tests/unit/calculations/rmd.test.js</files>
  <action>
Add tests for getRMDDeadline function (currently untested):

1. Import getRMDDeadline from rmd.js

2. 'should return null if not required to take RMD':
   - Call getRMDDeadline(70, null)
   - Verify returns null (age below RMD start age)

3. 'should return April 1 deadline for first RMD year':
   - Call getRMDDeadline(73, 1952)
   - Verify returns "April 1 of the year after turning 73"

4. 'should return December 31 deadline for subsequent years':
   - Call getRMDDeadline(74, 1952)
   - Verify returns "December 31 of current year"

5. 'should handle 1951 birth year special case (age 72 RMD)':
   - Call getRMDDeadline(72, 1951)
   - Verify April 1 deadline for first year

6. 'should return deadline for ages beyond start age':
   - Call getRMDDeadline(80, null)
   - Verify returns "December 31 of current year"

Reference: src/calculations/rmd.js getRMDDeadline function
  </action>
  <verify>Tests validate RMD deadline logic for first year and subsequent years</verify>
  <done>RMD deadline tests cover first year special case and ongoing years</done>
</task>

<task type="auto">
  <name>Add tests for calculateRMD base function</name>
  <files>tests/unit/calculations/rmd.test.js</files>
  <action>
Add tests for calculateRMD base function (currently untested):

1. Import calculateRMD from rmd.js

2. 'should calculate RMD using life expectancy factor':
   - Call calculateRMD(5000000, 75)
   - Factor for age 75 is 24.6
   - Verify result === Math.round(5000000 / 24.6)

3. 'should return 0 for age below 72':
   - Call calculateRMD(5000000, 70)
   - Verify returns 0 (no factor available)

4. 'should return 0 for invalid age (negative, zero)':
   - Call calculateRMD(5000000, 0)
   - Call calculateRMD(5000000, -5)
   - Verify both return 0

5. 'should return 0 for zero balance':
   - Call calculateRMD(0, 75)
   - Verify returns 0

6. 'should handle very large balances':
   - Call calculateRMD(100000000, 80)
   - Verify reasonable calculation

Reference: src/calculations/rmd.js calculateRMD uses life expectancy factor from config
  </action>
  <verify>Tests validate RMD calculation using life expectancy factor</verify>
  <done>RMD tests cover base calculation and edge cases</done>
</task>

<task type="auto">
  <name>Add tests for mustTakeRMD edge cases</name>
  <files>tests/unit/calculations/rmd.test.js</files>
  <action>
Add additional tests for mustTakeRMD function:

1. 'should return false for age 71':
   - Currently tests age 70 and 73, add 71
   - Call mustTakeRMD(71)
   - Verify returns false

2. 'should return true for age 72 (non-1951 birth year)':
   - Call mustTakeRMD(72, 1952)
   - For non-1951 birth years, RMD starts at 73
   - Verify returns false (72 < 73)

3. 'should return true for age 73+ regardless of birth year':
   - Test ages 73, 74, 75 with various birth years
   - Verify all return true

4. 'should handle current year calculation for birth year':
   - mustTakeRMD checks if current year >= birthYear + rmdStartAge
   - Test edge case around the year boundary

5. 'should handle null birthYear (use current rules)':
   - Existing test covers this, verify it stays passing

Reference: src/calculations/rmd.js mustTakeRMD with birth year logic
  </action>
  <verify>Tests validate mustTakeRMD edge cases around age thresholds</verify>
  <done>mustTakeRMD tests cover all age boundary conditions</done>
</task>

<task type="auto">
  <name>Add edge case tests for calculateRMDForAccount</name>
  <files>tests/unit/calculations/rmd.test.js</files>
  <action>
Add edge case tests for calculateRMDForAccount:

1. 'should handle account with missing balance':
   - Call calculateRMDForAccount({ type: '401k' }, 75)
   - Verify returns 0 (balance defaults to 0)

2. 'should handle account with zero balance':
   - Call calculateRMDForAccount({ type: 'IRA', balance: 0 }, 75)
   - Verify returns 0

3. 'should handle additional account types (403b, SEP)':
   - Test '403b', 'SEP' types if recognized by system
   - Verify RMD calculated (not Roth/HSA/Taxable which return 0)

4. 'should return 0 for unknown account types':
   - Call calculateRMDForAccount({ type: 'Unknown', balance: 1000000 }, 75)
   - Verify handles gracefully (returns 0 or calculated based on logic)

5. 'should not calculate RMD for age 72 when RMD not required':
   - Call calculateRMDForAccount({ type: 'IRA', balance: 1000000 }, 72)
   - Verify returns 0 (mustTakeRMD(72) returns false for standard case)

Reference: src/calculations/rmd.js calculateRMDForAccount checks mustTakeRMD and account type
  </action>
  <verify>Tests validate RMD account edge cases (missing balance, unknown types)</verify>
  <done>calculateRMDForAccount tests cover all edge cases</done>
</task>

</tasks>

<verification>
After implementation, verify:

1. Run unit tests: npm test tests/unit/calculations/tax.test.js tests/unit/calculations/rmd.test.js
2. All new tests pass (target: 40-45 total tests across both files)
3. Coverage report shows improvement:
   - Run: npm run test:coverage
   - Verify tax.js coverage increases from ~30% to 70%+
   - Verify rmd.js coverage increases from ~40% to 80%+
4. All tax calculation paths tested (federal, state, FICA, capital gains, NIIT)
5. All RMD calculation paths tested (calculateRMD, mustTakeRMD, getRMDDeadline, calculateRMDForAccount)
6. COV-04 requirement met: "all critical calculation paths have tests (tax, RMD, projections)"
</verification>

<success_criteria>
1. tax.test.js expanded from 11 tests to 25-30 tests
2. rmd.test.js expanded from 8 tests to 16-18 tests
3. Tax coverage increases to 70%+ (currently ~30%)
4. RMD coverage increases to 80%+ (currently ~40%)
5. All exported functions in tax.js and rmd.js have tests
6. All tests pass with npm test
7. COV-04 requirement complete
</success_criteria>

<output>
After completion, create `.planning/phases/10-critical-user-flow-e2e-tests/10-06-SUMMARY.md` with:
- Tests added (count by function)
- Coverage achieved for tax and RMD modules
- Edge cases covered
- Verification results
</output>
