---
phase: 02-tax-refactor
type: execute
---

<objective>
Extract state tax calculation functions and data from the 2,300-line tax.js into a focused state tax module.

Purpose: Split monolithic tax.js into modular components by domain, improving maintainability while preserving all functionality and test coverage.

Output: New file src/calculations/tax/states.js with 50+ state tax bracket data and state tax calculation functions, updated imports in dependent files, all tests passing.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-quality-tooling/01-01-SUMMARY.md
@.planning/phases/02-tax-refactor/02-01-PLAN.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/ARCHITECTURE.md
@src/calculations/tax.js
@src/calculations/projection.js

**Tech stack available from Phase 1:**
- ESLint 9.x flat config (enforces code quality)
- Prettier 3.x (ensures consistent formatting)
- Vitest 4.x (test discovery, custom test runner for now - phase 5 migration)

**Established patterns from Phase 1:**
- 2-space indentation, single quotes, semicolons required
- XML structure for tasks
- @context references for file loading

**Constraining decisions from Phase 1:**
- Defer fixing all 343 ESLint issues to Phase 2-4 (fix during refactoring)
- Keep existing custom test runner until Phase 5 migration

**Issues being addressed from CONCERNS.md:**
- Monolithic file: src/calculations/tax.js (2,300 lines) → Split into focused modules
- Fragile area: Tax bracket updates require manual file editing → Extracted to centralized location (plan 02-03)

**Context on current tax.js state tax structure:**
- Contains 50+ state tax bracket data (DC, CA, NY, AL, AZ, AR, CO, CT, DE, GA, HI, ID, IL, IN, IA, KS, KY, LA, ME, MD, MA, MI, MN, MS, MO, MT, NE, NJ, NM, NC, ND, OH, OK, OR, PA, RI, SC, SD, TN, TX, UT, VT, VA, WA, WV, WI, WY)
- Most states have 2025 tax brackets (some have 2024 and 2025)
- Contains state tax calculation functions (calculateStateTax, getStateTaxBrackets, getStateStandardDeduction)
- Used by: src/calculations/projection.js (imports calculateStateTax, getStateTaxBrackets, getStateStandardDeduction)
- State tax data starts at line 109 (DC) and continues through end of file

**Design decision from 02-01-PLAN.md:**
- Using single states.js file (not regional split or individual state files) to maintain simplicity and avoid import fatigue
- If states.js grows too large (>500 lines), can split in later phase
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract state tax bracket constants to states.js</name>
  <files>src/calculations/tax/states.js</files>
  <action>Create new file src/calculations/tax/states.js. Extract all state tax data structures from tax.js starting at line 109:
- DC_TAX_BRACKETS_2024, DC_TAX_BRACKETS_2025, DC_STANDARD_DEDUCTIONS_2024, DC_STANDARD_DEDUCTIONS_2025
- CA_TAX_BRACKETS_2024, CA_TAX_BRACKETS_2025, CA_STANDARD_DEDUCTIONS_2024, CA_STANDARD_DEDUCTIONS_2025
- NY_TAX_BRACKETS_2024, NY_TAX_BRACKETS_2025, NY_STANDARD_DEDUCTIONS_2024, NY_STANDARD_DEDUCTIONS_2025
- All other state tax brackets and deductions for AL, AZ, AR, CO, CT, DE, GA, HI, ID, IL, IN, IA, KS, KY, LA, ME, MD, MA, MI, MN, MS, MO, MT, NE, NJ, NM, NC, ND, OH, OK, OR, PA, RI, SC, SD, TN, TX, UT, VT, VA, WA, WV, WI, WY

Add JSDoc comment: 'State tax brackets and deductions for all 50 states + DC. All values in cents.'

DO NOT: Copy federal tax data (TAX_BRACKETS_2024, TAX_BRACKETS_2025, STANDARD_DEDUCTIONS) - already extracted in 02-01 to federal.js.
DO NOT: Copy calculateFederalTax function - already extracted in 02-01 to federal.js.
</action>
  <verify>File src/calculations/tax/states.js exists with 100+ state tax bracket/deduction objects and JSDoc comment</verify>
  <done>states.js created with all 50+ state tax brackets, standard deductions, JSDoc comment present</done>
</task>

<task type="auto">
  <name>Task 2: Extract state tax calculation functions to states.js</name>
  <files>src/calculations/tax/states.js, src/calculations/tax.js</files>
  <action>Extract state tax calculation functions from tax.js to states.js:
- calculateStateTax function
- getStateTaxBrackets function
- getStateStandardDeduction function
- Any helper functions used ONLY by state tax functions (analyze dependencies first)

In states.js, add at end: export { calculateStateTax, getStateTaxBrackets, getStateStandardDeduction };

In tax.js, keep original state tax function implementations but change to: import { calculateStateTax, getStateTaxBrackets, getStateStandardDeduction } from './tax/states.js';

DO NOT: Extract federal tax functions (calculateFederalTax) - already handled in 02-01.
DO NOT: Remove exports from tax.js - re-export as import to maintain backward compatibility.
</action>
  <verify>states.js exports calculateStateTax, getStateTaxBrackets, getStateStandardDeduction. tax.js imports these functions from states.js. Both files pass npm run lint without new errors</verify>
  <done>states.js exports state tax functions. tax.js imports and re-exports. No lint errors from changes</done>
</task>

<task type="auto">
  <name>Task 3: Update imports in dependent files and run tests</name>
  <files>src/calculations/projection.js</files>
  <action>Find files that import from tax.js (grep -r "from.*tax.js" src/). For each file:
- If importing state tax functions only (calculateStateTax, getStateTaxBrackets, getStateStandardDeduction): Update import to use './tax/states.js'
- If importing both federal and state functions: No change (tax.js re-exports both sets of functions)

After updating imports, run npm run format to apply Prettier formatting to all modified files.

Then run tests to verify: node tests/unit/calculations/tax.test.js (runs state tax tests)

DO NOT: Break existing imports for federal tax functions (tax.js re-exports compatibility handles this).
DO NOT: Skip test verification - must confirm state tax calculations still work correctly after extraction.
</action>
  <verify>All state tax imports updated correctly. npm run format passes. node tests/unit/calculations/tax.test.js passes</verify>
  <done>Imports updated, formatting applied, state tax tests pass</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] src/calculations/tax/states.js exists with 50+ state tax bracket/deduction objects + state tax calculation functions
- [ ] states.js exports state tax functions via named exports
- [ ] tax.js imports state tax functions from states.js and re-exports
- [ ] Dependent files updated to import state tax functions from correct location
- [ ] `node tests/unit/calculations/tax.test.js` passes (state tax tests)
- [ ] `npm run lint` shows only pre-existing errors, no new errors from this plan
- [ ] `npm run format` passes with no changes (already formatted)
</verification>

<success_criteria>
- State tax calculations and data extracted to src/calculations/tax/states.js
- tax.js imports state tax functions from states.js for backward compatibility
- All dependent files updated to use correct imports
- State tax tests pass
- No new lint errors introduced
- Code formatted with Prettier
</success_criteria>

<output>
After completion, create `.planning/phases/02-tax-refactor/02-02-SUMMARY.md`:

# Phase 02-02: Extract State Tax Calculations Summary

**Extracted state tax calculation functions (calculateStateTax, getStateTaxBrackets, getStateStandardDeduction) and 50+ state tax bracket data to dedicated states.js module**

## Accomplishments
- Created src/calculations/tax/states.js with tax brackets and standard deductions for all 50 states + DC (2024 and 2025)
- Extracted calculateStateTax, getStateTaxBrackets, getStateStandardDeduction functions to states.js
- Updated tax.js to import state tax functions from states.js and re-export for backward compatibility
- Updated dependent files to import state tax functions from correct location
- All state tax tests pass

## Files Created/Modified
- src/calculations/tax/states.js (new) - 50+ state tax brackets, standard deductions, state tax calculation functions
- src/calculations/tax.js (modified) - Imports state tax functions, re-exports
- src/calculations/projection.js (modified, if applicable) - Updated imports

## Decisions Made
- Used single states.js file (not regional split or individual state files) to maintain simplicity and avoid import fatigue
- Follows same pattern as 02-01-PLAN.md (federal.js) for consistency

## Issues Encountered
None - extraction successful, tests passing

## Next Step
Ready for 02-03-PLAN.md (Extract tax bracket data to JSON config files)
</output>
