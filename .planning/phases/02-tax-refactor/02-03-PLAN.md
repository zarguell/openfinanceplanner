---
phase: 02-tax-refactor
type: execute
---

<objective>
Extract tax bracket and deduction data from JavaScript objects to JSON config files for easier maintenance and updates.

Purpose: Move hardcoded tax data to centralized configuration files, making bracket updates simpler and reducing maintenance overhead.

Output: New config files for federal and state tax brackets (JSON format), loader module for reading config, updated imports in tax modules, all tests passing.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-quality-tooling/01-01-SUMMARY.md
@.planning/phases/02-tax-refactor/02-01-PLAN.md
@.planning/phases/02-tax-refactor/02-02-PLAN.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/ARCHITECTURE.md
@src/calculations/tax.js
@src/calculations/tax/federal.js
@src/calculations/tax/states.js

**Tech stack available from Phase 1:**

- ESLint 9.x flat config (enforces code quality)
- Prettier 3.x (ensures consistent formatting)
- Vitest 4.x (test discovery, custom test runner for now - phase 5 migration)

**Established patterns from Phase 1:**

- 2-space indentation, single quotes, semicolons required
- XML structure for tasks
- @context references for file loading

**Constraining decisions from Phase 1:**

- Defer fixing all 343 ESLint issues to Phase 2-4 (fix during refactoring)
- Keep existing custom test runner until Phase 5 migration

**Issues being addressed from CONCERNS.md:**

- Fragile area: Tax bracket updates require manual file editing → Extracted to centralized JSON config files
- 1,018+ hardcoded magic numbers → Moving tax bracket data to config reduces magic number count significantly

**Context on current tax data structure:**
After 02-01 and 02-02, we have:

- src/calculations/tax/federal.js - Contains TAX_BRACKETS_2024, TAX_BRACKETS_2025, STANDARD_DEDUCTIONS
- src/calculations/tax/states.js - Contains 50+ state tax bracket/deduction objects for 2024 and 2025
- Each year and filing status has bracket arrays with rate/min/max values
- Data is currently hardcoded as JavaScript const objects

**Target JSON structure:**
Config directory: src/calculations/tax/config/

- federal-2024.json
- federal-2025.json
- states-2024.json (all states for 2024)
- states-2025.json (all states for 2025)

JSON format for federal:

```json
{
  "brackets": {
    "single": [...],
    "married_joint": [...],
    "married_separate": [...],
    "head_of_household": [...]
  },
  "standardDeduction": {
    "single": 1460000,
    "married_joint": 2920000,
    "married_separate": 1460000,
    "head_of_household": 2190000
  }
}
```

JSON format for states:

```json
{
  "DC": {
    "brackets": {
      "single": [...],
      "married_joint": [...],
      "married_separate": [...],
      "head_of_household": [...]
    },
    "standardDeduction": {
      "single": 1500000,
      "married_joint": 3000000,
      "married_separate": 1500000,
      "head_of_household": 2250000
    }
  },
  "CA": { ... },
  "NY": { ... }
  // ... all 50 states
}
```

**Design decision:**

- Using centralized config/ directory with separate JSON files by year (not by state) to reduce file count
- Federal and states kept separate for clarity
- JSON format uses camelCase keys (brackets, standardDeduction) to match JavaScript conventions
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create JSON config files for federal tax brackets</name>
  <files>src/calculations/tax/config/federal-2024.json, src/calculations/tax/config/federal-2025.json</files>
  <action>Create directory src/calculations/tax/config/ if it doesn't exist.

Extract federal tax data from src/calculations/tax/federal.js to JSON:

- Create federal-2024.json with TAX_BRACKETS_2024 and STANDARD_DEDUCTIONS[2024]
- Create federal-2025.json with TAX_BRACKETS_2025 and STANDARD_DEDUCTIONS[2025]

Use the structure defined in context (brackets + standardDeduction object).

DO NOT: Create state tax config files yet (Task 2).
DO NOT: Modify federal.js yet (Task 3 will update to read from JSON).
</action>
<verify>Files federal-2024.json and federal-2025.json exist with correct bracket/standardDeduction structure</verify>
<done>federal-2024.json and federal-2025.json created with federal tax bracket and deduction data</done>
</task>

<task type="auto">
  <name>Task 2: Create JSON config files for state tax brackets</name>
  <files>src/calculations/tax/config/states-2024.json, src/calculations/tax/config/states-2025.json</files>
  <action>Extract state tax data from src/calculations/tax/states.js to JSON:
- Create states-2024.json with all state tax brackets and standard deductions for 2024 (DC, CA, NY only have 2024 data)
- Create states-2025.json with all state tax brackets and standard deductions for 2025 (all 50 states + DC)

Use the structure defined in context (object keyed by state code, each with brackets + standardDeduction).

Note: Only DC, CA, NY have 2024 data. All other states have 2025 data only.

DO NOT: Create federal config files (already done in Task 1).
DO NOT: Modify states.js yet (Task 3 will update to read from JSON).
</action>
<verify>Files states-2024.json and states-2025.json exist with all state bracket/standardDeduction data</verify>
<done>states-2024.json and states-2025.json created with 50+ state tax bracket and deduction data</done>
</task>

<task type="auto">
  <name>Task 3: Create loader module and update tax modules to use JSON config</name>
  <files>src/calculations/tax/config/loader.js, src/calculations/tax/federal.js, src/calculations/tax/states.js</files>
  <action>Create new file src/calculations/tax/config/loader.js with functions:
- loadFederalBrackets(year) - Returns federal bracket data for given year (reads from JSON)
- loadStateBrackets(stateCode, year) - Returns state bracket data for given state and year (reads from JSON)
- loadFederalStandardDeduction(year, filingStatus) - Returns federal standard deduction for given year and filing status
- loadStateStandardDeduction(stateCode, year, filingStatus) - Returns state standard deduction for given state, year, and filing status

Update src/calculations/tax/federal.js:

- Remove hardcoded TAX_BRACKETS_2024, TAX_BRACKETS_2025, STANDARD_DEDUCTIONS const objects
- Import loader functions from ./config/loader.js
- Keep calculateFederalTax function unchanged (it will now receive data from loader)
- Update exports to export calculateFederalTax, loadFederalBrackets, loadFederalStandardDeduction

Update src/calculations/tax/states.js:

- Remove hardcoded state tax bracket/deduction const objects
- Import loader functions from ./config/loader.js
- Keep calculateStateTax, getStateTaxBrackets, getStateStandardDeduction functions unchanged (they will now receive data from loader)
- Update exports to export calculateStateTax, getStateTaxBrackets, getStateStandardDeduction, loadStateBrackets, loadStateStandardDeduction

DO NOT: Modify tax.js (it re-exports from federal.js and states.js).
DO NOT: Modify projection.js (imports from tax.js unchanged).
</action>
<verify>loader.js exists with 4 load functions. federal.js and states.js updated to use loader, removed hardcoded data. All files pass npm run lint without new errors</verify>
<done>loader.js created with 4 functions. federal.js and states.js updated to use JSON config. No lint errors</done>
</task>

<task type="auto">
  <name>Task 4: Run tests and verify JSON config migration</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>Run npm run format to apply Prettier formatting to all modified files.

Run tests to verify: node tests/unit/calculations/tax.test.js

- Federal tax calculations should work correctly with JSON config data
- State tax calculations should work correctly with JSON config data
- All bracket and deduction lookups should return correct values

Test edge cases:

- Requesting data for year 2024 vs 2025
- Requesting data for all 4 filing statuses (single, married_joint, married_separate, head_of_household)
- Requesting data for all 50 states + DC
- States that don't have 2024 data should fall back to 2025 or return appropriate defaults

DO NOT: Skip test verification - must confirm all tax calculations work correctly after JSON migration.
DO NOT: Break existing functionality - ensure all tests pass before declaring plan complete.
</action>
<verify>npm run format passes. node tests/unit/calculations/tax.test.js passes with all federal and state tax tests</verify>
<done>Formatting applied, all tax tests pass with JSON config data</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] src/calculations/tax/config/ directory exists with 4 JSON files (federal-2024.json, federal-2025.json, states-2024.json, states-2025.json)
- [ ] src/calculations/tax/config/loader.js exists with 4 load functions (loadFederalBrackets, loadStateBrackets, loadFederalStandardDeduction, loadStateStandardDeduction)
- [ ] federal.js updated to use loader.js, removed hardcoded TAX_BRACKETS and STANDARD_DEDUCTIONS const objects
- [ ] states.js updated to use loader.js, removed hardcoded state tax bracket/deduction const objects
- [ ] tax.js unchanged (re-exports from federal.js and states.js)
- [ ] `node tests/unit/calculations/tax.test.js` passes (all federal and state tax tests)
- [ ] `npm run lint` shows only pre-existing errors, no new errors from this plan
- [ ] `npm run format` passes with no changes (already formatted)
</verification>

<success_criteria>

- Tax bracket and deduction data extracted to JSON config files (4 files)
- Loader module created to read JSON config
- federal.js and states.js updated to use loader, removed hardcoded data
- All tax tests pass with JSON config data
- No new lint errors introduced
- Code formatted with Prettier
  </success_criteria>

<output>
After completion, create `.planning/phases/02-tax-refactor/02-03-SUMMARY.md`:

# Phase 02-03: Extract Tax Bracket Data to JSON Config Summary

**Extracted all federal and state tax bracket/deduction data from JavaScript const objects to JSON config files with loader module**

## Accomplishments

- Created src/calculations/tax/config/ directory with 4 JSON files:
  - federal-2024.json
  - federal-2025.json
  - states-2024.json (DC, CA, NY only)
  - states-2025.json (all 50 states + DC)
- Created src/calculations/tax/config/loader.js with 4 load functions for reading config
- Updated src/calculations/tax/federal.js to use loader, removed hardcoded TAX_BRACKETS and STANDARD_DEDUCTIONS
- Updated src/calculations/tax/states.js to use loader, removed hardcoded state tax bracket/deduction const objects
- All tax tests pass with JSON config data

## Files Created/Modified

- src/calculations/tax/config/federal-2024.json (new) - Federal tax brackets and standard deduction for 2024
- src/calculations/tax/config/federal-2025.json (new) - Federal tax brackets and standard deduction for 2025
- src/calculations/tax/config/states-2024.json (new) - State tax brackets and standard deductions for 2024 (DC, CA, NY)
- src/calculations/tax/config/states-2025.json (new) - State tax brackets and standard deductions for 2025 (all 50 states + DC)
- src/calculations/tax/config/loader.js (new) - 4 load functions for reading JSON config
- src/calculations/tax/federal.js (modified) - Removed hardcoded data, uses loader.js
- src/calculations/tax/states.js (modified) - Removed hardcoded data, uses loader.js

## Decisions Made

- Used centralized config/ directory with separate JSON files by year (federal-YYYY.json, states-YYYY.json)
- Federal and states kept separate for clarity
- JSON format uses camelCase keys (brackets, standardDeduction) to match JavaScript conventions
- Loader module provides unified interface for reading config data

## Issues Encountered

None - migration successful, tests passing

## Next Step

Ready for 02-04-PLAN.md (Final validation and test verification)
</output>
