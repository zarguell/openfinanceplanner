---
phase: 02-tax-refactor
type: execute
---

<objective>
Extract federal tax calculation functions from the 2,300-line tax.js into a focused federal tax module.

Purpose: Split monolithic tax.js into modular components by domain, improving maintainability while preserving all functionality and test coverage.

Output: New file src/calculations/tax/federal.js with federal tax calculation functions, updated imports in dependent files, all tests passing.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-quality-tooling/01-01-SUMMARY.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/ARCHITECTURE.md
@src/calculations/tax.js
@src/calculations/projection.js

**Tech stack available from Phase 1:**
- ESLint 9.x flat config (enforces code quality)
- Prettier 3.x (ensures consistent formatting)
- Vitest 4.x (test discovery, custom test runner for now - phase 5 migration)

**Established patterns from Phase 1:**
- 2-space indentation, single quotes, semicolons required
- XML structure for tasks
- @context references for file loading

**Constraining decisions from Phase 1:**
- Defer fixing all 343 ESLint issues to Phase 2-4 (fix during refactoring)
- Keep existing custom test runner until Phase 5 migration

**Issues being addressed from CONCERNS.md:**
- Monolithic file: src/calculations/tax.js (2,300 lines) → Split into focused modules
- Fragile area: Tax brute bracket updates require manual file editing → Extracted to centralized location (plan 02-03)

**Context on current tax.js structure:**
- Contains federal tax brackets (TAX_BRACKETS_2024, TAX_BRACKETS_2025)
- Contains standard deductions (STANDARD_DEDUCTIONS)
- Contains federal tax calculation functions (calculateFederalTax)
- Contains 50+ state tax calculations (to be extracted in 02-02)
- Used by: src/calculations/projection.js (imports federal tax functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract federal tax constants to federal.js</name>
  <files>src/calculations/tax/federal.js</files>
  <action>Create new file src/calculations/tax/federal.js. Extract federal tax data structures from tax.js:
- TAX_BRACKETS_2024 object (lines 12-49)
- TAX_BRACKETS_2025 object (lines 51-88)
- STANDARD_DEDUCTIONS object (lines 94-107)

Add JSDoc comment: 'Federal tax brackets and deductions for 2024-2025. All values in cents.'

DO NOT: Copy state tax data or state-specific functions (extracted in 02-02).
</action>
  <verify>File src/calculations/tax/federal.js exists with 3 const objects and JSDoc comment</verify>
  <done>federal.js created with TAX_BRACKETS_2024, TAX_BRACKETS_2025, STANDARD_DEDUCTIONS, JSDoc comment present</done>
</task>

<task type="auto">
  <name>Task 2: Extract federal tax calculation functions to federal.js</name>
  <files>src/calculations/tax/federal.js, src/calculations/tax.js</files>
  <action>Extract federal tax calculation functions from tax.js to federal.js:
- calculateFederalTax function
- Any helper functions used ONLY by calculateFederalTax (analyze dependencies first)

In federal.js, add at end: export { calculateFederalTax, TAX_BRACKETS_2024, TAX_BRACKETS_2025, STANDARD_DEDUCTIONS };

In tax.js, keep original calculateFederalTax implementation but change to: import { calculateFederalTax } from './tax/federal.js';

DO NOT: Extract state tax functions (calculateStateTax, getStateTaxBrackets, etc.) - saved for 02-02.
DO NOT: Remove exports from tax.js - re-export as import to maintain backward compatibility.
</action>
  <verify>federal.js exports calculateFederalTax and constants. tax.js imports calculateFederalTax from federal.js. Both files pass npm run lint without new errors</verify>
  <done>federal.js exports federal functions/constants. tax.js imports and re-exports. No lint errors from changes</done>
</task>

<task type="auto">
  <name>Task 3: Update imports in dependent files and run tests</name>
  <files>src/calculations/projection.js</files>
  <action>Find files that import from tax.js (grep -r "from.*tax.js" src/). For each file:
- If importing联邦 tax functions only (calculateFederalTax): Update import to use './tax/federal.js'
- If importing both federal and state functions: No change (tax.js re-exports federal functions)

After updating imports, run npm run format to apply Prettier formatting to all modified files.

Then run tests to verify: node tests/unit/calculations/tax.test.js (runs federal tax tests)

DO NOT: Break existing imports for state tax functions (tax.js re-exports compatibility handles this).
DO NOT: Skip test verification - must confirm federal tax calculations still work correctly after extraction.
</action>
  <verify>All federal tax imports updated correctly. npm run format passes. node tests/unit/calculations/tax.test.js passes</verify>
  <done>Imports updated, formatting applied, federal tax tests pass</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] src/calculations/tax/federal.js exists with 3 const objects + calculateFederalTax function
- [ ] federal.js exports federal functions and constants via named exports
- [ ] tax.js imports calculateFederalTax from federal.js and re-exports
- [ ] Dependent files updated to import from federal.js where appropriate
- [ ] `node tests/unit/calculations/tax.test.js` passes (federal tax tests)
- [ ] `npm run lint` shows only pre-existing errors, no new errors from this plan
- [ ] `npm run format` passes with no changes (already formatted)
</verification>

<success_criteria>
- Federal tax calculations extracted to src/calculations/tax/federal.js
- tax.js imports federal functions from federal.js for backward compatibility
- All dependent files updated to use correct imports
- Federal tax tests pass
- No new lint errors introduced
- Code formatted with Prettier
</success_criteria>

<output>
After completion, create `.planning/phases/02-tax-refactor/02-01-SUMMARY.md`:

# Phase 02-01: Extract Federal Tax Calculations Summary

**Extracted federal tax calculation functions (calculateFederalTax) and constants to dedicated federal.js module**

## Accomplishments
- Created src/calculations/tax/federal.js with TAX_BRACKETS_2024, TAX_BRACKETS_2025, STANDARD_DEDUCTIONS
- Extracted calculateFederalTax function to federal.js
- Updated tax.js to import from federal.js and re-export for backward compatibility
- Updated dependent files to import federal functions from correct location
- All federal tax tests pass

## Files Created/Modified
- src/calculations/tax/federal.js (new) - Federal tax brackets, deductions, calculation function
- src/calculations/tax.js (modified) - Imports federal functions, re-exports
- src/calculations/projection.js (modified, if applicable) - Updated imports

## Decisions Made
None - followed established Phase 1 patterns and roadmap specification

## Issues Encountered
None - extraction successful, tests passing

## Next Step
Ready for 02-02-PLAN.md (Extract state tax calculations)
</output>