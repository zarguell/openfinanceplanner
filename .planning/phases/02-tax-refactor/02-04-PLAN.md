---
phase: 02-tax-refactor
type: execute
---

<objective>
Final validation and comprehensive testing of the tax module refactoring to ensure all functionality works correctly after splitting monolithic tax.js into federal.js, states.js, and JSON config files.

Purpose: Verify that all refactoring work from plans 02-01, 02-02, and 02-03 is complete and working correctly. Run comprehensive tests, audit imports, and ensure backward compatibility.

Output: Clean module structure with all tests passing, all imports verified, no regressions introduced, full documentation of refactoring outcomes.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-quality-tooling/01-01-SUMMARY.md
@.planning/phases/02-tax-refactor/02-01-PLAN.md
@.planning/phases/02-tax-refactor/02-02-PLAN.md
@.planning/phases/02-tax-refactor/02-03-PLAN.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/ARCHITECTURE.md
@src/calculations/tax.js
@src/calculations/tax/federal.js
@src/calculations/tax/states.js
@src/calculations/tax/config/

**Tech stack available from Phase 1:**
- ESLint 9.x flat config (enforces code quality)
- Prettier 3.x (ensures consistent formatting)
- Vitest 4.x (test discovery, custom test runner for now - phase 5 migration)

**Established patterns from Phase 1:**
- 2-space indentation, single quotes, semicolons required
- XML structure for tasks
- @context references for file loading

**Constraining decisions from Phase 1:**
- Defer fixing all 343 ESLint issues to Phase 2-4 (fix during refactoring)
- Keep existing custom test runner until Phase 5 migration

**Issues being addressed from CONCERNS.md:**
- Monolithic file: src/calculations/tax.js (2,300 lines) → Split into focused modules (federal.js, states.js, config/)
- Fragile area: Tax bracket updates require manual file editing → Extracted to JSON config files

**Refactoring work completed in previous plans:**
- 02-01: Extracted federal tax calculations to federal.js (TAX_BRACKETS, STANDARD_DEDUCTIONS, calculateFederalTax)
- 02-02: Extracted state tax calculations to states.js (50+ state tax brackets/deductions, calculateStateTax, getStateTaxBrackets, getStateStandardDeduction)
- 02-03: Extracted all tax bracket/deduction data to JSON config files (federal-2024.json, federal-2025.json, states-2024.json, states-2025.json) with loader.js module

**Expected module structure after 02-03:**
```
src/calculations/
└── tax/
    ├── tax.js (re-exports only)
    ├── federal.js (federal tax calculations)
    ├── states.js (state tax calculations)
    └── config/
        ├── federal-2024.json
        ├── federal-2025.json
        ├── states-2024.json
        ├── states-2025.json
        └── loader.js (reads JSON config)
```

**Backward compatibility:**
- tax.js should re-export all functions from federal.js and states.js
- Existing imports from './tax.js' should continue to work without modification
- projection.js imports from tax.js (calculateFederalTax, calculateStateTax, getStateTaxBrackets, getStateStandardDeduction)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit all imports across codebase</name>
  <files>src/calculations/tax.js, src/calculations/projection.js</files>
  <action>Audit all files that import from tax.js to ensure correct import paths:
- Run: grep -r "from.*tax\.js" src/ to find all imports
- For each file, verify:
  - If importing federal tax functions (calculateFederalTax): Should import from './tax/federal.js' OR remain with './tax.js' (backward compatibility)
  - If importing state tax functions (calculateStateTax, getStateTaxBrackets, getStateStandardDeduction): Should import from './tax/states.js' OR remain with './tax.js' (backward compatibility)
  - If importing both federal and state: Should remain with './tax.js' (re-exports both sets of functions)
  - If importing loader functions: Should import from './tax/config/loader.js'

Verify tax.js re-exports:
- calculateFederalTax (from federal.js)
- calculateStateTax (from states.js)
- getStateTaxBrackets (from states.js)
- getStateStandardDeduction (from states.js)
- loadFederalBrackets (from config/loader.js)
- loadStateBrackets (from config/loader.js)
- loadFederalStandardDeduction (from config/loader.js)
- loadStateStandardDeduction (from config/loader.js)

DO NOT: Change imports that are already correct.
DO NOT: Break backward compatibility - tax.js must re-export all functions.
</action>
  <verify>All imports verified correct. tax.js re-exports all functions from federal.js, states.js, and config/loader.js</verify>
  <done>Import audit complete, all imports correct, backward compatibility maintained</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify no regressions</name>
  <files>tests/unit/calculations/tax.test.js</files>
  <action>Run comprehensive test suite to verify no regressions from refactoring:
1. Run: npm run lint (check for lint errors)
   - Verify only pre-existing errors, no new errors from refactoring
2. Run: npm run format (apply Prettier formatting)
3. Run: node tests/unit/calculations/tax.test.js (federal and state tax tests)
   - Verify all federal tax tests pass (2024 and 2025 brackets)
   - Verify all state tax tests pass (all 50 states + DC for 2025, DC/CA/NY for 2024)
   - Verify standard deduction calculations correct
   - Verify edge cases handled (missing years, invalid states, invalid filing statuses)
4. Run: node tests/unit/calculations/projection.test.js (integration tests)
   - Verify projection calculations still work with refactored tax modules
   - Verify tax calculations integrate correctly with projection engine

If any tests fail:
1. Identify root cause (import issue, data mismatch, function signature change)
2. Fix issue in appropriate file (federal.js, states.js, loader.js, or tax.js)
3. Re-run tests to verify fix
4. Document issue and resolution in summary

DO NOT: Proceed to next task until all tests pass.
DO NOT: Ignore test failures - all tests must pass before declaring plan complete.
</action>
  <verify>npm run lint shows only pre-existing errors. npm run format passes. node tests/unit/calculations/tax.test.js passes. node tests/unit/calculations/projection.test.js passes</verify>
  <done>Full test suite passes, no regressions introduced</done>
</task>

<task type="auto">
  <name>Task 3: Final file structure verification and documentation</name>
  <files>src/calculations/tax/, .planning/phases/02-tax-refactor/</files>
  <action>Verify final module structure matches expected architecture:
1. List files in src/calculations/tax/ and confirm:
   - tax.js exists (re-exports only)
   - federal.js exists (federal tax calculations, uses loader)
   - states.js exists (state tax calculations, uses loader)
   - config/ directory exists
   - config/federal-2024.json exists
   - config/federal-2025.json exists
   - config/states-2024.json exists
   - config/states-2025.json exists
   - config/loader.js exists (4 load functions)

2. Verify file sizes:
   - tax.js should be small (<100 lines, mostly re-exports)
   - federal.js should be focused (<150 lines, calculateFederalTax + imports)
   - states.js should be focused (<200 lines, state tax functions + imports)
   - JSON files contain all tax bracket/deduction data
   - loader.js contains 4 load functions

3. Count lines in each file:
   - Run: wc -l src/calculations/tax/*.js src/calculations/tax/config/*.js
   - Compare to original 2,300-line tax.js to confirm reduction in file size

4. Update planning documentation:
   - Create 02-04-SUMMARY.md with final metrics (files created, lines reduced, tests passed)
   - Update ROADMAP.md to mark Phase 2 tasks complete
   - Update STATE.md to reflect current position (ready for Phase 3)

DO NOT: Skip file structure verification - must confirm expected architecture achieved.
DO NOT: Skip documentation update - STATE.md and ROADMAP.md must reflect completion.
</action>
  <verify>All expected files exist with correct sizes. File structure matches architecture. Documentation updated</verify>
  <done>File structure verified, metrics collected, documentation updated</done>
</task>

</tasks>

<verification>
Before declaring this plan (and Phase 2) complete:
- [ ] All imports audited and verified correct across codebase
- [ ] tax.js re-exports all functions from federal.js, states.js, and config/loader.js
- [ ] `npm run lint` shows only pre-existing errors, no new errors
- [ ] `npm run format` passes with no changes
- [ ] `node tests/unit/calculations/tax.test.js` passes (all federal and state tax tests)
- [ ] `node tests/unit/calculations/projection.test.js` passes (integration tests)
- [ ] File structure verified: tax.js, federal.js, states.js, config/ with 4 JSON files, loader.js
- [ ] File size metrics collected showing reduction from 2,300-line monolith
- [ ] 02-04-SUMMARY.md created with final metrics and outcomes
- [ ] ROADMAP.md updated to mark Phase 2 complete
- [ ] STATE.md updated to reflect current position (ready for Phase 3)
</verification>

<success_criteria>
- Tax module successfully refactored from 2,300-line monolith to focused modules (federal.js, states.js, config/)
- All tax bracket/deduction data extracted to JSON config files for easier maintenance
- All federal and state tax calculations working correctly (tests pass)
- All imports verified and backward compatibility maintained
- No regressions introduced in projection calculations
- Documentation updated (SUMMARY.md, ROADMAP.md, STATE.md)
- Phase 2 complete and ready for Phase 3
</success_criteria>

<output>
After completion, create `.planning/phases/02-tax-refactor/02-04-SUMMARY.md`:

# Phase 02-04: Final Validation and Test Verification Summary

**Completed final validation and comprehensive testing of tax module refactoring. All functionality verified working correctly.**

## Accomplishments
- Audited all imports across codebase and verified correct paths
- Confirmed backward compatibility maintained (tax.js re-exports all functions)
- Ran full test suite: all federal and state tax tests pass
- Ran integration tests: projection calculations working correctly
- Verified final module structure matches expected architecture
- Collected metrics showing successful refactoring outcomes

## Files Verified
- src/calculations/tax.js (re-exports only, <100 lines)
- src/calculations/tax/federal.js (federal tax calculations, <150 lines)
- src/calculations/tax/states.js (state tax calculations, <200 lines)
- src/calculations/tax/config/federal-2024.json
- src/calculations/tax/config/federal-2025.json
- src/calculations/tax/config/states-2024.json
- src/calculations/tax/config/states-2025.json
- src/calculations/tax/config/loader.js (4 load functions)

## Metrics
- Original tax.js: 2,300 lines (monolithic)
- Refactored structure:
  - tax.js: ~50 lines (re-exports)
  - federal.js: ~100 lines (federal calculations)
  - states.js: ~150 lines (state calculations)
  - loader.js: ~80 lines (config loading)
  - JSON configs: ~2,000 lines (tax data)
- Total reduction in main source files: ~2,000 lines → ~380 lines (81% reduction)
- Tax data now in separate JSON files for easier maintenance and updates

## Test Results
- npm run lint: Pass (only pre-existing errors)
- npm run format: Pass
- node tests/unit/calculations/tax.test.js: Pass (all federal and state tax tests)
- node tests/unit/calculations/projection.test.js: Pass (integration tests)

## Decisions Made
- Maintained backward compatibility via re-exports in tax.js
- JSON config files organized by year (federal-YYYY.json, states-YYYY.json)
- Loader module provides unified interface for reading config
- Federal and state tax modules kept separate for clarity

## Issues Encountered
None - all tests pass, no regressions introduced

## Next Step
Phase 2 complete. Ready for Phase 3 (next phase in ROADMAP.md)

## Documentation Updated
- .planning/ROADMAP.md (Phase 2 marked complete)
- .planning/STATE.md (updated current position)
- All 02-XX-SUMMARY.md files created for each plan
</output>
