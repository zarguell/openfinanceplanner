---
phase: 17-data-visualization
plan: 02
type: execute
wave: 2
depends_on: [17-01]
files_modified:
  - src/components/charts/CustomTooltip.tsx
  - src/components/charts/NetWorthChart.tsx
  - src/components/charts/index.ts
  - src/utils/currency.ts
autonomous: true

must_haves:
  truths:
    - 'Net worth chart displays as area chart with gradient fill'
    - 'Chart shows year on X-axis and formatted currency on Y-axis'
    - 'Hovering over chart shows tooltip with year and net worth value'
    - 'Chart is responsive and maintains aspect ratio on mobile'
    - 'Chart updates automatically when simulation results change'
  artifacts:
    - path: 'src/components/charts/NetWorthChart.tsx'
      provides: 'Area chart component for net worth projection'
      exports: ['NetWorthChart']
      min_lines: 80
    - path: 'src/components/charts/CustomTooltip.tsx'
      provides: 'Reusable financial tooltip component'
      exports: ['CustomTooltip']
      min_lines: 40
    - path: 'src/utils/currency.ts'
      provides: 'Currency formatting utility'
      exports: ['formatCurrency', 'formatCurrencyCompact']
  key_links:
    - from: 'src/components/charts/NetWorthChart.tsx'
      to: 'src/hooks/useChartData'
      via: 'useChartData() hook call'
      pattern: "const.*= useChartData\\(\\)"
    - from: 'src/components/charts/NetWorthChart.tsx'
      to: 'src/components/charts/ResponsiveChartWrapper'
      via: 'import and render as parent'
      pattern: 'ResponsiveChartWrapper'
    - from: 'src/components/charts/NetWorthChart.tsx'
      to: 'src/components/charts/CustomTooltip'
      via: 'Tooltip content prop'
      pattern: "content=\\{<CustomTooltip"
    - from: 'src/components/charts/CustomTooltip.tsx'
      to: 'src/utils/currency.ts'
      via: 'formatCurrency import'
      pattern: 'formatCurrency'
---

<objective>
Build the net worth projection chart as an area chart with gradient fill, custom financial tooltips, and responsive sizing. This is the primary visualization showing retirement projection over time.

Purpose: Provides users with visual understanding of their net worth trajectory, making it easy to see growth patterns and identify critical years.
Output: NetWorthChart component with area visualization, gradient styling, and interactive tooltips
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-data-visualization/17-RESEARCH.md
@.planning/phases/17-data-visualization/17-01-SUMMARY.md

## Dependencies Established in 17-01

- Recharts installed (v3.x)
- Chart types: ChartData, ChartDataPoint in src/types/chart.ts
- useChartData hook available at src/hooks/useChartData.ts
- ResponsiveChartWrapper available at src/components/charts/ResponsiveChartWrapper.tsx

## Recharts Components to Use

From 17-RESEARCH.md Pattern 4:

- AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer
- SVG linearGradient for gradient fill
- tickFormatter for Y-axis currency formatting

## Mantine Integration

Mantine UI v8 is already integrated. Use Mantine's Paper or Card for container styling.

## Anti-Patterns to Avoid (from research)

- Inline dataKey functions: Use string keys "netWorth" not (entry) => entry.netWorth
- No parent dimensions: Always use ResponsiveChartWrapper
- Unmemoized data: Already handled in useChartData hook
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create currency formatting utility</name>
  <files>src/utils/currency.ts</files>
  <action>
    Create src/utils/currency.ts with financial formatting functions:

    ```typescript
    /**
     * Format a number as currency string
     * @param value - Numeric value to format
     * @param options - Intl.NumberFormat options
     * @returns Formatted currency string (e.g., "$150,000")
     */
    export function formatCurrency(
      value: number,
      options: Intl.NumberFormatOptions = {}
    ): string {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
        ...options,
      }).format(value);
    }

    /**
     * Format currency in compact notation for axis labels
     * @param value - Numeric value to format
     * @returns Compact format (e.g., "$150k" instead of "$150,000")
     */
    export function formatCurrencyCompact(value: number): string {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        notation: 'compact',
        maximumFractionDigits: 1,
      }).format(value);
    }

    /**
     * Format a number with commas (no currency symbol)
     * @param value - Numeric value to format
     * @returns Formatted number (e.g., "150,000")
     */
    export function formatNumber(value: number): string {
      return new Intl.NumberFormat('en-US').format(value);
    }
    ```

    These utilities handle all currency display needs across the app.

  </action>
  <verify>Create test file and verify formatCurrency(150000) returns "$150,000" and formatCurrencyCompact(150000) returns "$150K"</verify>
  <done>Currency utility exists with formatCurrency, formatCurrencyCompact, and formatNumber functions</done>
</task>

<task type="auto">
  <name>Task 2: Create CustomTooltip component</name>
  <files>src/components/charts/CustomTooltip.tsx</files>
  <action>
    Create src/components/charts/CustomTooltip.tsx:

    ```typescript
    import type { TooltipProps } from 'recharts';
    import { Paper, Text, Stack } from '@mantine/core';
    import { formatCurrency } from '@/utils/currency';

    type CustomTooltipProps = TooltipProps<number, string>;

    /**
     * Custom tooltip for financial charts.
     *
     * From 17-RESEARCH.md Pattern 2:
     * - Custom tooltip for formatting currency values and dates
     * - Uses Mantine Paper for consistent styling
     * - Formats monetary values with formatCurrency utility
     */
    export function CustomTooltip({ active, payload, label }: CustomTooltipProps) {
      if (active && payload && payload.length) {
        const data = payload[0];
        const value = data.value as number;

        return (
          <Paper
            shadow="sm"
            radius="md"
            p="sm"
            withBorder
            style={{
              backgroundColor: 'white',
            }}
          >
            <Stack gap={4}>
              <Text size="sm" fw={600} c="dimmed">
                Age {label}
              </Text>
              <Text size="md" fw={700} c="blue">
                {formatCurrency(value)}
              </Text>
            </Stack>
          </Paper>
        );
      }

      return null;
    }
    ```

    Key requirements:
    - Uses Mantine Paper for styling consistency
    - Shows age and formatted net worth
    - Returns null when not active (required by Recharts)

  </action>
  <verify>Component renders with mock tooltip props in test file</verify>
  <done>CustomTooltip exists with Paper wrapper, age label, and formatted currency value</done>
</task>

<task type="auto">
  <name>Task 3: Create NetWorthChart component</name>
  <files>src/components/charts/NetWorthChart.tsx</files>
  <action>
    Create src/components/charts/NetWorthChart.tsx:

    ```typescript
    import {
      AreaChart,
      Area,
      XAxis,
      YAxis,
      CartesianGrid,
      Tooltip,
    } from 'recharts';

import { Paper, Text } from '@mantine/core';
import { useChartData } from '@/hooks/useChartData';
import { ResponsiveChartWrapper } from './ResponsiveChartWrapper';
import { CustomTooltip } from './CustomTooltip';
import { formatCurrencyCompact } from '@/utils/currency';

    const CHART_MARGIN = { top: 10, right: 30, left: 0, bottom: 0 };

    /**
     * Net worth projection area chart with gradient fill.
     *
     * Features:
     * - Area chart with gradient fill for visual appeal
     * - X-axis shows age
     * - Y-axis shows net worth with compact currency formatting
     * - Custom tooltip on hover showing exact values
     * - Responsive sizing via ResponsiveChartWrapper
     * - Synchronized with Zustand store via useChartData hook
     *
     * From 17-RESEARCH.md Pattern 4:
     * - Uses linearGradient for gradient fill
     * - Uses tickFormatter for Y-axis currency formatting
     * - isAnimationActive for smooth initial render
     */
    export function NetWorthChart() {
      const { points, years } = useChartData();

      // Handle empty data state
      if (points.length === 0) {
        return (
          <Paper p="xl" ta="center" withBorder>
            <Text c="dimmed">Enter your financial details to see projections</Text>
          </Paper>
        );
      }

      return (
        <Paper p="md" withBorder radius="md">
          <Text size="lg" fw={600} mb="md">
            Net Worth Projection
          </Text>
          <ResponsiveChartWrapper height={350} minHeight={250}>
            <AreaChart data={points} margin={CHART_MARGIN}>
              <defs>
                <linearGradient id="colorNetWorth" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#228be6" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="#228be6" stopOpacity={0} />
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e9ecef" />
              <XAxis
                dataKey="age"
                tick={{ fontSize: 12 }}
                tickLine={false}
                axisLine={{ stroke: '#ced4da' }}
              />
              <YAxis
                tickFormatter={formatCurrencyCompact}
                tick={{ fontSize: 12 }}
                tickLine={false}
                axisLine={false}
                width={60}
              />
              <Tooltip
                content={<CustomTooltip />}
                cursor={{ stroke: '#228be6', strokeWidth: 2, strokeDasharray: '5 5' }}
              />
              <Area
                type="monotone"
                dataKey="netWorth"
                stroke="#228be6"
                strokeWidth={2}
                fillOpacity={1}
                fill="url(#colorNetWorth)"
                isAnimationActive={true}
                animationDuration={1000}
              />
            </AreaChart>
          </ResponsiveChartWrapper>
          <Text size="xs" c="dimmed" mt="xs" ta="center">
            {years} year projection
          </Text>
        </Paper>
      );
    }
    ```

    Key requirements from research:
    - Use string dataKey="netWorth" (not inline function)
    - Memoized CHART_MARGIN constant (not inline object)
    - Gradient fill with linearGradient
    - Custom tooltip component passed to Tooltip
    - Empty state handling
    - Cursor styling for visual feedback
    - ResponsiveChartWrapper ensures proper parent dimensions

  </action>
  <verify>Import component in App.tsx and verify it renders without errors (may need mock data in store)</verify>
  <done>NetWorthChart exists with AreaChart, gradient fill, custom tooltip, axis formatters, and empty state</done>
</task>

<task type="auto">
  <name>Task 4: Update charts index and verify integration</name>
  <files>src/components/charts/index.ts</files>
  <action>
    Update src/components/charts/index.ts to export new components:

    ```typescript
    export { ResponsiveChartWrapper } from './ResponsiveChartWrapper';
    export { CustomTooltip } from './CustomTooltip';
    export { NetWorthChart } from './NetWorthChart';
    ```

    Then verify TypeScript compilation:
    ```bash
    npx tsc --noEmit
    ```

    Create a simple integration test to verify the chart renders:
    ```typescript
    // In src/components/charts/NetWorthChart.test.tsx
    import { render, screen } from '@testing-library/react';
    import { NetWorthChart } from './NetWorthChart';
    import { useSimulationStore } from '@/stores/simulation';

    // Mock the chart data hook or store
    vi.mock('@/hooks/useChartData', () => ({
      useChartData: () => ({
        points: [
          { year: 2024, age: 30, netWorth: 100000 },
          { year: 2025, age: 31, netWorth: 110000 },
        ],
        minNetWorth: 100000,
        maxNetWorth: 110000,
        years: 2,
      }),
    }));

    // Mock ResponsiveContainer for tests
    vi.mock('recharts', async () => {
      const actual = await vi.importActual('recharts');
      return {
        ...actual,
        ResponsiveContainer: ({ children }: { children: React.ReactNode }) => (
          <div style={{ width: 800, height: 400 }}>{children}</div>
        ),
      };
    });

    describe('NetWorthChart', () => {
      it('renders chart title', () => {
        render(<NetWorthChart />);
        expect(screen.getByText('Net Worth Projection')).toBeInTheDocument();
      });

      it('shows year count', () => {
        render(<NetWorthChart />);
        expect(screen.getByText('2 year projection')).toBeInTheDocument();
      });
    });
    ```

  </action>
  <verify>All tests pass and TypeScript compiles without errors</verify>
  <done>Index exports all components, TypeScript compiles, tests pass</done>
</task>

</tasks>

<verification>
1. Chart renders with area visualization and gradient
2. X-axis shows age values
3. Y-axis shows formatted currency (compact format)
4. Hovering shows tooltip with age and exact net worth
5. Chart is responsive and fits container
6. Empty state displays helpful message
7. All TypeScript compiles without errors
</verification>

<success_criteria>

- NetWorthChart component displays area chart with gradient fill
- CustomTooltip shows formatted currency on hover
- X-axis displays age, Y-axis displays compact currency format
- Chart updates automatically via useChartData hook
- Empty state handled gracefully
- Responsive sizing works on mobile and desktop
- All components exported from charts/index.ts
  </success_criteria>

<output>
After completion, create `.planning/phases/17-data-visualization/17-02-SUMMARY.md`
</output>
