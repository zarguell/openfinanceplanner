---
phase: 09-e2e-test-foundation
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - tests/e2e/pages/fixtures.js
  - tests/e2e/builders/PlanBuilder.js
  - tests/e2e/builders/AccountBuilder.js
  - tests/e2e/helpers/storage.js
autonomous: true

must_haves:
  truths:
    - "Developer can import custom test fixtures that auto-initialize page objects"
    - "PlanBuilder provides fluent API (withName, withAges, withAccount) for test data"
    - "AccountBuilder provides fluent API (withName, withType, withBalance) for test data"
    - "StorageHelper provides methods to clear, read, and write localStorage"
    - "Tests using fixtures have automatic setup and teardown"
  artifacts:
    - path: "tests/e2e/pages/fixtures.js"
      provides: "Custom Playwright fixtures extending base test object"
      exports: ["test", "expect"]
    - path: "tests/e2e/builders/PlanBuilder.js"
      provides: "Fluent builder for Plan test data"
      exports: ["PlanBuilder", "aPlan"]
    - path: "tests/e2e/builders/AccountBuilder.js"
      provides: "Fluent builder for Account test data"
      exports: ["AccountBuilder", "anAccount"]
    - path: "tests/e2e/helpers/storage.js"
      provides: "localStorage helper for test setup/teardown"
      exports: ["StorageHelper"]
  key_links:
    - from: "tests/e2e/pages/fixtures.js"
      to: "tests/e2e/pages/PlanPage.js"
      via: "import and instantiate in fixture"
      pattern: "new PlanPage"
    - from: "tests/e2e/pages/fixtures.js"
      to: "tests/e2e/helpers/storage.js"
      via: "StorageHelper for cleanup in teardown"
      pattern: "storageHelper.clear"
    - from: "tests/e2e/builders/PlanBuilder.js"
      to: "src/core/models/Plan.js"
      via: "use Plan model in build()"
      pattern: "new Plan"
---

<objective>
Create Playwright test fixtures and data builders to provide automatic setup/teardown and fluent test data creation APIs.

**Purpose:** Tests need consistent setup (navigation, data initialization) and teardown (localStorage cleanup) without repetitive code. Fixtures provide dependency injection for page objects, while builders eliminate repetition in test data creation.

**Output:** Custom fixtures extending Playwright's base test, fluent builders for Plan/Account objects, and StorageHelper for localStorage management.
</objective>

<execution_context>
@/Users/zach/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zach/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-test-foundation-(page-objects-&-fixtures)/09-RESEARCH.md
@.planning/phases/09-e2e-test-foundation-(page-objects-&-fixtures)/09-01-PLAN.md

# Domain models
@src/core/models/Plan.js
@src/core/models/Account.js
</context>

<tasks>

<task type="auto">
  <name>Create StorageHelper for localStorage management</name>
  <files>tests/e2e/helpers/storage.js</files>
  <action>
Create tests/e2e/helpers/storage.js with:

1. **StorageHelper class:**
```javascript
export class StorageHelper {
  constructor(page) {
    this.page = page;
  }

  async clear() {
    await this.page.evaluate(() => localStorage.clear());
  }

  async getPlans() {
    return await this.page.evaluate(() => {
      const plansList = localStorage.getItem('ofp_plans_list');
      return plansList ? JSON.parse(plansList) : [];
    });
  }

  async getPlan(planId) {
    return await this.page.evaluate((id) => {
      const planData = localStorage.getItem(`ofp_plan_${id}`);
      return planData ? JSON.parse(planData) : null;
    }, planId);
  }

  async savePlan(planData) {
    await this.page.evaluate((data) => {
      localStorage.setItem(`ofp_plan_${data.id}`, JSON.stringify(data));

      const plansList = JSON.parse(localStorage.getItem('ofp_plans_list') || '[]');
      const existingIndex = plansList.findIndex(p => p.id === data.id);
      if (existingIndex >= 0) {
        plansList[existingIndex] = { id: data.id, name: data.name, lastModified: data.lastModified };
      } else {
        plansList.push({ id: data.id, name: data.name, lastModified: data.lastModified });
      }
      localStorage.setItem('ofp_plans_list', JSON.stringify(plansList));
    }, planData);
  }

  async setPlan(planData) {
    // Helper to pre-populate localStorage with a plan (faster than UI creation)
    await this.savePlan(planData);
  }

  async getAccountCount(planId) {
    const plan = await this.getPlan(planId);
    return plan ? plan.accounts.length : 0;
  }
}
```

2. **Usage:** This helper will be used by fixtures for test setup and cleanup
</action>
  <verify>
File exists at tests/e2e/helpers/storage.js with StorageHelper class
</verify>
  <done>
StorageHelper class with clear, getPlans, getPlan, savePlan, setPlan, getAccountCount methods for localStorage management
</done>
</task>

<task type="auto">
  <name>Create PlanBuilder for fluent test data creation</name>
  <files>tests/e2e/builders/PlanBuilder.js</files>
  <action>
Create tests/e2e/builders/PlanBuilder.js with:

1. **Import domain model:**
```javascript
import { Plan } from '../../src/core/models/Plan.js';
import { Account } from '../../src/core/models/Account.js';
```

2. **PlanBuilder class:**
```javascript
export class PlanBuilder {
  constructor() {
    this.name = 'Test Plan';
    this.currentAge = 40;
    this.retirementAge = 67;
    this.accounts = [];
    this.expenses = [];
    this.incomes = [];
  }

  withName(name) {
    this.name = name;
    return this;
  }

  withAges(current, retirement) {
    this.currentAge = current;
    this.retirementAge = retirement;
    return this;
  }

  withAccount(name, type, balance, contribution = 0) {
    this.accounts.push({ name, type, balance, contribution });
    return this;
  }

  withExpense(name, amount, inflationLinked = false) {
    this.expenses.push({ name, amount, inflationLinked });
    return this;
  }

  withIncome(name, amount, startAge = 67) {
    this.incomes.push({ name, amount, startAge });
    return this;
  }

  build() {
    const plan = new Plan(this.name, this.currentAge, this.retirementAge);

    // Add accounts
    this.accounts.forEach(acc => {
      const account = new Account(acc.name, acc.type, acc.balance);
      account.annualContribution = acc.contribution;
      plan.addAccount(account);
    });

    // Add expenses if any
    this.expenses.forEach(exp => {
      plan.addExpense(exp.name, exp.amount, exp.inflationLinked);
    });

    // Add income if any
    this.incomes.forEach(inc => {
      plan.addSocialSecurity(inc.amount, inc.startAge);
    });

    return plan;
  }
}

// Convenience factory function
export const aPlan = () => new PlanBuilder();
```

3. **Example usage:**
```javascript
const plan = aPlan()
  .withName('Retirement 2050')
  .withAges(35, 65)
  .withAccount('401k', '401k', 100000, 10000)
  .build();
```
</action>
  <verify>
File exists at tests/e2e/builders/PlanBuilder.js with PlanBuilder class and aPlan factory
</verify>
  <done>
PlanBuilder class exported with withName, withAges, withAccount, withExpense, withIncome, build methods and aPlan factory function
</done>
</task>

<task type="auto">
  <name>Create AccountBuilder for fluent account test data</name>
  <files>tests/e2e/builders/AccountBuilder.js</files>
  <action>
Create tests/e2e/builders/AccountBuilder.js with:

1. **Import domain model:**
```javascript
import { Account } from '../../src/core/models/Account.js';
```

2. **AccountBuilder class:**
```javascript
export class AccountBuilder {
  constructor() {
    this.name = 'Test Account';
    this.type = '401k';
    this.balance = 100000;  // In cents (1000.00)
    this.annualContribution = 0;
  }

  withName(name) {
    this.name = name;
    return this;
  }

  withType(type) {
    // Valid types: '401k', 'IRA', 'Roth', 'HSA', 'Taxable'
    this.type = type;
    return this;
  }

  withBalance(balance) {
    // Balance in cents (e.g., 100000 = $1000.00)
    this.balance = balance;
    return this;
  }

  withDollarBalance(dollars) {
    // Convenience method for dollar amount
    this.balance = dollars * 100;
    return this;
  }

  withContribution(amount) {
    this.annualContribution = amount;
    return this;
  }

  build() {
    const account = new Account(this.name, this.type, this.balance);
    account.annualContribution = this.annualContribution;
    return account;
  }
}

// Convenience factory function
export const anAccount = () => new AccountBuilder();
```

3. **Example usage:**
```javascript
const account = anAccount()
  .withName('My 401k')
  .withType('401k')
  .withDollarBalance(100000)
  .withContribution(23500)
  .build();
```
</action>
  <verify>
File exists at tests/e2e/builders/AccountBuilder.js with AccountBuilder class and anAccount factory
</verify>
  <done>
AccountBuilder class exported with withName, withType, withBalance, withDollarBalance, withContribution, build methods and anAccount factory function
</done>
</task>

<task type="auto">
  <name>Create custom Playwright fixtures for page objects</name>
  <files>tests/e2e/pages/fixtures.js</files>
  <action>
Create tests/e2e/pages/fixtures.js with:

1. **Import base test and page objects:**
```javascript
import { test as base, expect } from '@playwright/test';
import { AppPage } from './AppPage.js';
import { PlanPage } from './PlanPage.js';
import { AccountPage } from './AccountPage.js';
import { ProjectionPage } from './ProjectionPage.js';
import { StorageHelper } from '../helpers/storage.js';
```

2. **Custom fixtures extending base test:**
```javascript
// Extended test object with custom fixtures
export const test = base.extend({
  // Storage helper fixture (no auto-setup, just helper)
  storageHelper: async ({ page }, use) => {
    await use(new StorageHelper(page));
  },

  // AppPage fixture - navigates to app
  appPage: async ({ page }, use) => {
    const appPage = new AppPage(page);
    await appPage.goto();
    await use(appPage);
    // Cleanup: clear localStorage after test
    await page.evaluate(() => localStorage.clear());
  },

  // PlanPage fixture - navigates to app, ready for plan operations
  planPage: async ({ page, storageHelper }, use) => {
    const planPage = new PlanPage(page);
    await page.goto('http://localhost:3030');
    await use(planPage);
    // Cleanup
    await storageHelper.clear();
  },

  // AccountPage fixture - expects a plan to already exist
  accountPage: async ({ page, storageHelper }, use) => {
    const accountPage = new AccountPage(page);
    await page.goto('http://localhost:3030');
    await use(accountPage);
    // Cleanup
    await storageHelper.clear();
  },

  // ProjectionPage fixture - expects plan with accounts to exist
  projectionPage: async ({ page, storageHelper }, use) => {
    const projectionPage = new ProjectionPage(page);
    await page.goto('http://localhost:3030');
    await use(projectionPage);
    // Cleanup
    await storageHelper.clear();
  },

  // authenticatedPage fixture - creates a test plan before each test
  authenticatedPage: async ({ page, storageHelper }, use) => {
    // Import builder for test data
    const { aPlan } = await import('../builders/PlanBuilder.js');

    // Create test plan via localStorage (faster than UI)
    const testPlan = aPlan()
      .withName('E2E Test Plan')
      .withAges(40, 67)
      .withAccount('Test 401k', '401k', 100000, 10000)
      .build();

    await storageHelper.setPlan(testPlan);

    // Navigate to app
    await page.goto('http://localhost:3030');

    // Provide page objects
    const appPage = new AppPage(page);
    const planPage = new PlanPage(page);
    const accountPage = new AccountPage(page);
    const projectionPage = new ProjectionPage(page);

    await use({ appPage, planPage, accountPage, projectionPage, testPlan });

    // Cleanup
    await storageHelper.clear();
  },
});

// Re-export expect from Playwright
export { expect } from '@playwright/test';
```

3. **Document usage** in comments:
```javascript
// Usage in test files:
// import { test, expect } from '../pages/fixtures.js';
//
// test('my test', async ({ authenticatedPage }) => {
//   const { appPage, planPage, accountPage, projectionPage, testPlan } = authenticatedPage;
//   // testPlan is already in localStorage, app is navigated
// });
```
</action>
  <verify>
File exists at tests/e2e/pages/fixtures.js with custom test fixtures
</verify>
  <done>
Fixtures file exports extended test object with appPage, planPage, accountPage, projectionPage, authenticatedPage, storageHelper fixtures
</done>
</task>

<task type="auto">
  <name>Create example test demonstrating fixtures and builders</name>
  <files>tests/e2e/examples/fixtures-demo.test.js</files>
  <action>
Create tests/e2e/examples/fixtures-demo.test.js to demonstrate usage:

```javascript
import { test, expect } from '../pages/fixtures.js';
import { aPlan } from '../builders/PlanBuilder.js';
import { anAccount } from '../builders/AccountBuilder.js';

test.describe('Fixtures Demo', () => {
  test('authenticatedPage fixture creates test plan automatically', async ({ authenticatedPage, storageHelper }) => {
    const { appPage, planPage, testPlan } = authenticatedPage;

    // Plan already exists in localStorage from fixture
    const plans = await storageHelper.getPlans();
    expect(plans.length).toBe(1);
    expect(plans[0].name).toBe('E2E Test Plan');

    // Can interact with the app using page objects
    expect(await planPage.isPlanVisible('E2E Test Plan')).toBe(true);
  });

  test('planPage fixture provides clean state', async ({ planPage, storageHelper }) => {
    // Use builder to create test data
    const testPlan = aPlan()
      .withName('Demo Plan')
      .withAges(35, 65)
      .withAccount('401k', '401k', 50000, 5000)
      .build();

    // Pre-populate localStorage
    await storageHelper.setPlan(testPlan);

    // Reload to see the plan
    await planPage.page.reload();
    expect(await planPage.isPlanVisible('Demo Plan')).toBe(true);
  });

  test('builders create valid test data', async () => {
    const plan = aPlan()
      .withName('Complex Test Plan')
      .withAges(30, 60)
      .withAccount('401k', '401k', 150000, 20000)
      .withAccount('Roth IRA', 'Roth', 50000, 7000)
      .build();

    expect(plan.name).toBe('Complex Test Plan');
    expect(plan.currentAge).toBe(30);
    expect(plan.retirementAge).toBe(60);
    expect(plan.accounts.length).toBe(2);
  });

  test('storageHelper manages localStorage', async ({ page, storageHelper }) => {
    const plan = aPlan().withName('Storage Test').withAges(40, 67).build();

    await storageHelper.setPlan(plan);
    const retrieved = await storageHelper.getPlan(plan.id);

    expect(retrieved.name).toBe('Storage Test');
    expect(retrieved.id).toBe(plan.id);

    await storageHelper.clear();
    const plans = await storageHelper.getPlans();
    expect(plans.length).toBe(0);
  });
});
```

This serves as documentation and verification that fixtures work correctly.
</action>
  <verify>
File exists at tests/e2e/examples/fixtures-demo.test.js with 4 example tests
</verify>
  <done>
Example test file demonstrates all fixtures and builders with 4 working tests
</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run fixtures demo: `npm run test:e2e -- fixtures-demo.test.js` - all 4 tests should pass
2. Verify all exports: `node -e "import('./tests/e2e/pages/fixtures.js'); import('./tests/e2e/builders/PlanBuilder.js'); import('./tests/e2e/builders/AccountBuilder.js'); import('./tests/e2e/helpers/storage.js');"`
3. Check directory structure: `ls -la tests/e2e/{pages,builders,helpers,examples}/` shows all files
4. Verify smoke test still passes: `npm run test:e2e -- smoke.test.js`
</verification>

<success_criteria>
1. Custom fixtures file extends Playwright base test with 6 fixtures (storageHelper, appPage, planPage, accountPage, projectionPage, authenticatedPage)
2. PlanBuilder provides fluent API with sensible defaults
3. AccountBuilder provides fluent API with sensible defaults
4. StorageHelper manages localStorage (clear, get, set operations)
5. All 4 demo tests pass, proving fixtures work correctly
6. E2E test directory structure exists: tests/e2e/{fixtures,pages,builders,helpers,examples}
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-test-foundation-(page-objects-&-fixtures)/09-02-SUMMARY.md`
</output>
