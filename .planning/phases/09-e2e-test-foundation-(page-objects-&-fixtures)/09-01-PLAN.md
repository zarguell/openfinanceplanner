---
phase: 09-e2e-test-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - src/ui/AccountController.js
  - src/ui/PlanController.js
  - src/ui/ProjectionController.js
  - tests/e2e/pages/AppPage.js
  - tests/e2e/pages/PlanPage.js
  - tests/e2e/pages/AccountPage.js
  - tests/e2e/pages/ProjectionPage.js
autonomous: true

must_haves:
  truths:
    - "Developer can import and instantiate PlanPage, AccountPage, ProjectionPage classes"
    - "Each page object has methods for all CRUD operations (create, read, update, delete)"
    - "Page objects use data-testid and ARIA role selectors, not CSS classes"
    - "Tests using page objects can navigate and interact with UI without duplication"
    - "All UI elements referenced by page objects have data-testid attributes"
  artifacts:
    - path: "tests/e2e/pages/PlanPage.js"
      provides: "Plan CRUD page object with create, select, delete methods"
      exports: ["PlanPage"]
    - path: "tests/e2e/pages/AccountPage.js"
      provides: "Account CRUD page object with add, edit, delete methods"
      exports: ["AccountPage"]
    - path: "tests/e2e/pages/ProjectionPage.js"
      provides: "Projection page object with run, verify results methods"
      exports: ["ProjectionPage"]
    - path: "tests/e2e/pages/AppPage.js"
      provides: "Base app page with navigation and plan switching"
      exports: ["AppPage"]
    - path: "index.html"
      provides: "HTML with data-testid attributes for plan-related elements"
      contains: "data-testid"
    - path: "src/ui/AccountController.js"
      provides: "Account rendering with data-testid attributes"
      contains: "data-testid"
    - path: "src/ui/PlanController.js"
      provides: "Plan UI with data-testid attributes for tabs"
      contains: "data-testid"
    - path: "src/ui/ProjectionController.js"
      provides: "Projection results with data-testid attributes"
      contains: "data-testid"
  key_links:
    - from: "tests/e2e/pages/PlanPage.js"
      to: "index.html"
      via: "data-testid='new-plan-button' and plan modal selectors"
      pattern: "getByTestId.*plan"
    - from: "tests/e2e/pages/AccountPage.js"
      to: "AccountController"
      via: "data-testid attributes on account elements"
      pattern: "getByTestId.*account"
    - from: "tests/e2e/pages/ProjectionPage.js"
      to: "ProjectionController"
      via: "data-testid attributes on projection results"
      pattern: "getByTestId.*projection|getByTestId.*monte-carlo"
---

<objective>
Create Page Object Model classes for Plan, Account, and Projection pages to encapsulate UI interactions and enable maintainable E2E tests.

**Purpose:** E2E tests need reusable page abstractions to avoid duplication and make tests resilient to UI changes. Page objects encapsulate selectors and actions, so when UI changes, only the page object needs updates.

**Output:** Four page object classes (AppPage, PlanPage, AccountPage, ProjectionPage) with comprehensive methods for all CRUD operations, using resilient data-testid selectors. First, data-testid attributes are added to UI elements, then page objects are created using those selectors.
</objective>

<execution_context>
@/Users/zach/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zach/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-test-foundation-(page-objects-&-fixtures)/09-RESEARCH.md
@.planning/phases/08-e2e-testing-infrastructure/08-01-SUMMARY.md

# Existing page object
@tests/e2e/pages/AppPage.js
</context>

<tasks>

<task type="auto">
  <name>Add data-testid attributes to UI elements for reliable selectors</name>
  <files>index.html, src/ui/AccountController.js, src/ui/PlanController.js, src/ui/ProjectionController.js</files>
  <action>
Add data-testid attributes to ALL UI elements that page objects will reference. This MUST be done first so page objects can use these selectors.

1. **index.html - Plan modal elements:**
   - Add `data-testid="plan-name-input"` to `#newPlanName` input (line ~87)
   - Add `data-testid="plan-age-input"` to `#newPlanAge` input (line ~96)
   - Add `data-testid="plan-retirement-age-input"` to `#newPlanRetirementAge` input (line ~107)
   - Add `data-testid="create-plan-button"` to Create button in modal (line ~116)
   - Add `data-testid="settings-button"` to Settings button in header (line ~52)
   - Add `data-testid="delete-plan-button"` to Delete button (line ~57)

2. **src/ui/AccountController.js - Account form elements:**
   - In `showAddAccountModal()`:
     - Add `data-testid="account-name-input"` to `#accountName` input
     - Add `data-testid="account-type-select"` to `#accountType` select
     - Add `data-testid="account-balance-input"` to `#accountBalance` input
     - Add `data-testid="account-contribution-input"` to `#accountContribution` input
     - Add `data-testid="add-account-button"` to Add button
   - In `renderAccountsList()`:
     - Add `data-testid="account-card"` attribute to each card element
     - Add `data-testid="account-card-${account.id}"` for specific card identification
   - In `editAccount()`:
     - Add `data-testid="edit-account-name-input"` to `#editAccountName`
     - Add `data-testid="edit-account-balance-input"` to `#editAccountBalance`
     - Add `data-testid="edit-account-contribution-input"` to `#editAccountContribution`
     - Add `data-testid="save-account-button"` to Save button

3. **src/ui/PlanController.js - Tab navigation:**
   - In `renderPlanUI()` (line 81-89):
     - Add `data-testid="tab-overview"` to Overview tab
     - Add `data-testid="tab-accounts"` to Accounts tab
     - Add `data-testid="tab-expenses"` to Expenses tab
     - Add `data-testid="tab-projection"` to Projection tab
     - (Add to all tabs: overview, assumptions, socialsecurity, income, accounts, expenses, projection)

4. **src/ui/ProjectionController.js - Projection elements:**
   - In `renderProjectionResults()`:
     - Add `data-testid="final-balance-result"` to the final balance result-value div (line ~104)
     - Add `data-testid="retirement-balance-result"` to retirement balance result-value (line ~109)
     - Add `data-testid="monte-carlo-card"` to Monte Carlo analysis card (line ~61)
     - Add `data-testid="success-probability-badge"` to success probability badge (line ~68)
     - Add `data-testid="balance-chart-canvas"` to `#balanceChart` canvas (line ~121)
     - Add `data-testid="year-by-year-table"` to the year-by-year table (line ~191)

DO NOT change existing functionality, only add attributes.
</action>
  <verify>
grep -r "data-testid" index.html src/ui/AccountController.js src/ui/PlanController.js src/ui/ProjectionController.js | wc -l shows 20+ new attributes
</verify>
  <done>
All interactive elements have data-testid attributes: plan inputs, account forms/cards, tabs, projection results, charts
</done>
</task>

<task type="auto">
  <name>Enhance AppPage base class with navigation and shared methods</name>
  <files>tests/e2e/pages/AppPage.js</files>
  <action>
Refactor AppPage.js to serve as base class with:

1. **Constructor enhancement:** Store page reference, add shared locators using ONLY data-testid or ARIA roles
   ```javascript
   constructor(page) {
     this.page = page;
     this.planList = page.getByTestId('plan-item');
     this.tabs = page.getByTestId(/tab-/);  // Uses data-testid, NOT .tab class
     this.newPlanButton = page.getByTestId('new-plan-button');
     this.settingsButton = page.getByTestId('settings-button');
     this.deleteButton = page.getByTestId('delete-plan-button');
   }
   ```

2. **Navigation methods:**
   - `goto()` - navigate to localhost:3030
   - `switchTab(tabName)` - click tab by data-testid (e.g., `getByTestId('tab-accounts')`)
   - `selectPlan(planName)` - click plan item by text filtering on plan-item testid

3. **Shared utilities:**
   - `waitForModal(modalId)` - wait for modal to appear using locator
   - `closeModal(modalId)` - click cancel or remove modal
   - `clearLocalStorage()` - clear storage between tests

4. **Keep existing methods** but refactor to use new shared utilities:
   - `createPlan()` - use data-testid selectors for inputs
   - `isPlanInList()` - use filter() on getByTestId('plan-item')
   - `getPlanCount()` - use count() on plan-item testid

DO NOT use CSS class selectors like `.tab`, `.card`, `.btn` - only data-testid and ARIA roles.
DO NOT change existing smoke.test.js - it must continue working after changes.
</action>
  <verify>
npm run test:e2e -- smoke.test.js passes
</verify>
  <done>
AppPage has navigation methods (goto, switchTab, selectPlan), shared utilities (waitForModal, closeModal, clearLocalStorage), uses only data-testid/ARIA selectors
</done>
</task>

<task type="auto">
  <name>Create PlanPage class with plan CRUD operations</name>
  <files>tests/e2e/pages/PlanPage.js</files>
  <action>
Create tests/e2e/pages/PlanPage.js using ONLY data-testid and ARIA role selectors:

1. **Constructor:**
```javascript
constructor(page) {
  this.page = page;
  this.newPlanButton = page.getByTestId('new-plan-button');
  this.planNameInput = page.getByTestId('plan-name-input');  // Uses data-testid added in Task 1
  this.planAgeInput = page.getByTestId('plan-age-input');
  this.retirementAgeInput = page.getByTestId('plan-retirement-age-input');
  this.createButton = page.getByTestId('create-plan-button');
  this.planItems = page.getByTestId('plan-item');
  this.settingsButton = page.getByTestId('settings-button');
  this.deleteButton = page.getByTestId('delete-plan-button');
}
```

2. **CRUD methods:**
   - `createPlan(name, currentAge, retirementAge)` - click new plan, fill form using data-testid inputs, click create using data-testid button, wait for modal close
   - `selectPlan(name)` - filter plan items by text on plan-item testid and click
   - `deletePlan(name)` - select plan, click delete-button testid, confirm dialog
   - `isPlanVisible(name)` - return boolean if plan exists in list
   - `getPlanCount()` - return count of plan-item elements
   - `openPlanSettings()` - click settings-button testid
   - `renamePlan(newName)` - in settings modal, change name, save

3. **Use resilient waiting:**
   - Replace `waitForTimeout(1000)` with `page.waitForSelector('[data-testid="plan-item"]')`
   - Use `waitFor()` with state for modal visibility

4. **Export class** for use in tests and fixtures

DO NOT use CSS class selectors. All inputs now have data-testid from Task 1.
</action>
  <verify>
File exists at tests/e2e/pages/PlanPage.js with all methods defined using data-testid selectors
</verify>
  <done>
PlanPage class exported with createPlan, selectPlan, deletePlan, isPlanVisible, getPlanCount, openPlanSettings, renamePlan methods using only data-testid selectors
</done>
</task>

<task type="auto">
  <name>Create AccountPage class with account CRUD operations</name>
  <files>tests/e2e/pages/AccountPage.js</files>
  <action>
Create tests/e2e/pages/AccountPage.js using ONLY data-testid and ARIA role selectors:

1. **Constructor with account-related locators:**
```javascript
constructor(page) {
  this.page = page;
  this.addAccountButton = page.getByRole('button', { name: /Add Account/i });
  this.accountNameInput = page.getByTestId('account-name-input');  // Uses data-testid added in Task 1
  this.accountTypeSelect = page.getByTestId('account-type-select');
  this.accountBalanceInput = page.getByTestId('account-balance-input');
  this.accountContributionInput = page.getByTestId('account-contribution-input');
  this.addButton = page.getByTestId('add-account-button');
  this.accountCards = page.getByTestId('account-card');  // Uses data-testid, NOT .card
  this.editAccountNameInput = page.getByTestId('edit-account-name-input');
  this.editAccountBalanceInput = page.getByTestId('edit-account-balance-input');
  this.editAccountContributionInput = page.getByTestId('edit-account-contribution-input');
  this.saveAccountButton = page.getByTestId('save-account-button');
}
```

2. **CRUD methods:**
   - `addAccount(name, type, balance, contribution = 0)` - click add, fill form via data-testid inputs, submit via data-testid button, wait
   - `getAccountCount()` - count account-card testid elements in accounts list
   - `isAccountVisible(name)` - check if account card exists by name
   - `editAccount(name, newName, newBalance, newContribution)` - click edit on account, update fields via data-testid inputs, save via data-testid button
   - `deleteAccount(name)` - click delete on account (by name), accept dialog

3. **Note:** Account operations require a plan to be selected first. Document this in class comments.

4. **Handle edit via data-testid:** Edit modal now uses data-testid inputs per Task 1.

5. **Export class** for use in tests

DO NOT use `.card` CSS class - use `getByTestId('account-card')` instead.
</action>
  <verify>
File exists at tests/e2e/pages/AccountPage.js with all methods defined
</verify>
  <done>
AccountPage class exported with addAccount, getAccountCount, isAccountVisible, editAccount, deleteAccount methods using only data-testid selectors
</done>
</task>

<task type="auto">
  <name>Create ProjectionPage class with projection and Monte Carlo operations</name>
  <files>tests/e2e/pages/ProjectionPage.js</files>
  <action>
Create tests/e2e/pages/ProjectionPage.js using ONLY data-testid and ARIA role selectors:

1. **Constructor with projection-related locators:**
```javascript
constructor(page) {
  this.page = page;
  this.runProjectionButton = page.getByRole('button', { name: 'Run Projection' });
  this.finalBalanceLocator = page.getByTestId('final-balance-result');  // Uses data-testid, NOT .result-value
  this.retirementBalanceLocator = page.getByTestId('retirement-balance-result');
  this.monteCarloCard = page.getByTestId('monte-carlo-card');  // Uses data-testid, NOT .card filter
  this.successProbabilityBadge = page.getByTestId('success-probability-badge');  // Uses data-testid, NOT .badge
  this.balanceChart = page.getByTestId('balance-chart-canvas');  // Uses data-testid, NOT #balanceChart
  this.yearByYearTable = page.getByTestId('year-by-year-table');  // Uses data-testid, NOT table selector
}
```

2. **Methods:**
   - `runProjection()` - click run button via ARIA role, wait for results
   - `getFinalBalance()` - parse and return final balance value from final-balance-result testid
   - `getRetirementBalance()` - parse and return retirement balance from retirement-balance-result testid
   - `getSuccessProbability()` - parse and return success probability percentage from success-probability-badge testid
   - `isMonteCarloVisible()` - check if monte-carlo-card testid is visible
   - `isChartVisible()` - check if balance-chart-canvas testid is rendered
   - `getYearCount()` - return number of rows in year-by-year-table testid
   - `hasTableCell(text)` - check if table contains specific text (e.g., "Retired")

3. **Note:** Projection requires a plan with accounts to be selected first.

4. **Handle Monte Carlo variance:** Don't assert exact values - provide methods that return values for assertion in tests

5. **Export class** for use in tests

DO NOT use CSS selectors like `.result-value`, `.badge`, `.card`. All now have data-testid from Task 1.
</action>
  <verify>
File exists at tests/e2e/pages/ProjectionPage.js with all methods defined
</verify>
  <done>
ProjectionPage class exported with runProjection, getFinalBalance, getRetirementBalance, getSuccessProbability, isMonteCarloVisible, isChartVisible, getYearCount, hasTableCell methods using only data-testid/ARIA selectors
</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run smoke test: `npm run test:e2e -- smoke.test.js` - should pass
2. Verify all page objects export correctly: `node -e "import('./tests/e2e/pages/PlanPage.js'); import('./tests/e2e/pages/AccountPage.js'); import('./tests/e2e/pages/ProjectionPage.js');"`
3. Check data-testid coverage: `grep -r "data-testid" index.html src/ui/*.js | wc -l` should show 20+ attributes
4. Verify no CSS class selectors in new page objects: `grep -r "page.locator('\\.\|\.card\|\.btn\|\.tab\|\.badge\|\.result-value" tests/e2e/pages/` should return nothing
</verification>

<success_criteria>
1. Data-testid attributes added to 20+ UI elements BEFORE page objects are created
2. Four page object classes exist (AppPage, PlanPage, AccountPage, ProjectionPage)
3. Each page object has methods covering all CRUD operations for its domain
4. All selectors use data-testid or ARIA roles, NO CSS classes (.tab, .card, .badge, .result-value)
5. smoke.test.js continues to pass with enhanced AppPage
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-test-foundation-(page-objects-&-fixtures)/09-01-SUMMARY.md`
</output>
