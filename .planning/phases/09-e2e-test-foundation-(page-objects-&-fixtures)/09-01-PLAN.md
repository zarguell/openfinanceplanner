---
phase: 09-e2e-test-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/pages/AppPage.js
  - tests/e2e/pages/PlanPage.js
  - tests/e2e/pages/AccountPage.js
  - tests/e2e/pages/ProjectionPage.js
  - index.html
  - src/ui/AccountController.js
  - src/ui/ProjectionController.js
  - src/ui/PlanController.js
autonomous: true

must_haves:
  truths:
    - "Developer can import and instantiate PlanPage, AccountPage, ProjectionPage classes"
    - "Each page object has methods for all CRUD operations (create, read, update, delete)"
    - "Page objects use data-testid and ARIA role selectors, not CSS classes"
    - "Tests using page objects can navigate and interact with UI without duplication"
  artifacts:
    - path: "tests/e2e/pages/PlanPage.js"
      provides: "Plan CRUD page object with create, select, delete methods"
      exports: ["PlanPage"]
    - path: "tests/e2e/pages/AccountPage.js"
      provides: "Account CRUD page object with add, edit, delete methods"
      exports: ["AccountPage"]
    - path: "tests/e2e/pages/ProjectionPage.js"
      provides: "Projection page object with run, verify results methods"
      exports: ["ProjectionPage"]
    - path: "tests/e2e/pages/AppPage.js"
      provides: "Base app page with navigation and plan switching"
      exports: ["AppPage"]
  key_links:
    - from: "tests/e2e/pages/PlanPage.js"
      to: "index.html"
      via: "data-testid='new-plan-button' and plan modal selectors"
      pattern: "getByTestId|getByRole"
    - from: "tests/e2e/pages/AccountPage.js"
      to: "AccountController"
      via: "data-testid attributes on account elements"
      pattern: "getByTestId.*account"
    - from: "tests/e2e/pages/ProjectionPage.js"
      to: "ProjectionController"
      via: "run projection button and result selectors"
      pattern: "getByRole.*button.*Run"
---

<objective>
Create Page Object Model classes for Plan, Account, and Projection pages to encapsulate UI interactions and enable maintainable E2E tests.

**Purpose:** E2E tests need reusable page abstractions to avoid duplication and make tests resilient to UI changes. Page objects encapsulate selectors and actions, so when UI changes, only the page object needs updates.

**Output:** Four page object classes (AppPage, PlanPage, AccountPage, ProjectionPage) with comprehensive methods for all CRUD operations, using resilient data-testid selectors.
</objective>

<execution_context>
@/Users/zach/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zach/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-test-foundation-(page-objects-&-fixtures)/09-RESEARCH.md
@.planning/phases/08-e2e-testing-infrastructure/08-01-SUMMARY.md

# Existing page object
@tests/e2e/pages/AppPage.js
</context>

<tasks>

<task type="auto">
  <name>Enhance AppPage base class with navigation and shared methods</name>
  <files>tests/e2e/pages/AppPage.js</files>
  <action>
Refactor AppPage.js to serve as base class with:

1. **Constructor enhancement:** Store page reference, add shared locators
   - `this.planList = page.getByTestId('plan-item')`
   - `this.tabs = page.locator('.tab')`
   - `this.newPlanButton = page.getByTestId('new-plan-button')`

2. **Navigation methods:**
   - `goto()` - navigate to localhost:3030
   - `switchTab(tabName)` - click tab by text filtering
   - `selectPlan(planName)` - click plan item by name filter

3. **Shared utilities:**
   - `waitForModal(modalId)` - wait for modal to appear using locator
   - `closeModal(modalId)` - click cancel or remove modal
   - `clearLocalStorage()` - clear storage between tests

4. **Keep existing methods** but refactor to use new shared utilities:
   - `createPlan()` - delegate to PlanPage or keep here with improvements
   - `isPlanInList()` - use filter() instead of loop
   - `getPlanCount()` - use count() directly

DO NOT change existing smoke.test.js - it must continue working after changes.
</action>
  <verify>
npm run test:e2e -- smoke.test.js passes
</verify>
  <done>
AppPage has navigation methods (goto, switchTab, selectPlan), shared utilities (waitForModal, closeModal, clearLocalStorage), and existing methods work correctly
</done>
</task>

<task type="auto">
  <name>Create PlanPage class with plan CRUD operations</name>
  <files>tests/e2e/pages/PlanPage.js</files>
  <action>
Create tests/e2e/pages/PlanPage.js with:

1. **Constructor:**
```javascript
constructor(page) {
  this.page = page;
  this.newPlanButton = page.getByTestId('new-plan-button');
  this.planNameInput = page.locator('#newPlanName');
  this.planAgeInput = page.locator('#newPlanAge');
  this.retirementAgeInput = page.locator('#newPlanRetirementAge');
  this.createButton = page.getByRole('button', { name: 'Create' });
  this.planItems = page.getByTestId('plan-item');
  this.settingsButton = page.getByRole('button', { name: 'Settings' });
  this.deleteButton = page.locator('#deleteBtn');
}
```

2. **CRUD methods:**
   - `createPlan(name, currentAge, retirementAge)` - click new plan, fill form, click create, wait for modal close
   - `selectPlan(name)` - filter plan items by text and click
   - `deletePlan(name)` - select plan, click delete, confirm dialog
   - `isPlanVisible(name)` - return boolean if plan exists in list
   - `getPlanCount()` - return count of plan items
   - `openPlanSettings()` - click settings button
   - `renamePlan(newName)` - in settings modal, change name, save

3. **Use resilient waiting:**
   - Replace `waitForTimeout(1000)` with `page.waitForSelector('[data-testid="plan-item"]')`
   - Use `waitFor()` with state for modal visibility

4. **Export class** for use in tests and fixtures
</action>
  <verify>
File exists at tests/e2e/pages/PlanPage.js with all methods defined
</verify>
  <done>
PlanPage class exported with createPlan, selectPlan, deletePlan, isPlanVisible, getPlanCount, openPlanSettings, renamePlan methods using data-testid selectors
</done>
</task>

<task type="auto">
  <name>Create AccountPage class with account CRUD operations</name>
  <files>tests/e2e/pages/AccountPage.js</files>
  <action>
Create tests/e2e/pages/AccountPage.js with:

1. **Constructor with account-related locators:**
```javascript
constructor(page) {
  this.page = page;
  this.addAccountButton = page.getByRole('button', { name: /Add Account/i });
  this.accountNameInput = page.locator('#accountName');
  this.accountTypeSelect = page.locator('#accountType');
  this.accountBalanceInput = page.locator('#accountBalance');
  this.accountContributionInput = page.locator('#accountContribution');
  this.addButton = page.getByRole('button', { name: 'Add' });
  this.accountCards = page.locator('.card'); // filtered by account name in methods
  this.editButton = page.getByRole('button', { name: 'Edit' });
  this.deleteButton = page.getByRole('button', { name: 'Delete' });
}
```

2. **CRUD methods:**
   - `addAccount(name, type, balance, contribution = 0)` - click add, fill form, submit, wait
   - `getAccountCount()` - count account cards in accounts list
   - `isAccountVisible(name)` - check if account card exists by name
   - `editAccount(name, newName, newBalance, newContribution)` - click edit on account, update fields, save
   - `deleteAccount(name)` - click delete on account, accept dialog

3. **Note:** Account operations require a plan to be selected first. Document this in class comments.

4. **Handle edit modal IDs:** Edit modal uses `editAccountName`, `editAccountBalance`, `editAccountContribution` IDs per AccountController.js

5. **Export class** for use in tests
</action>
  <verify>
File exists at tests/e2e/pages/AccountPage.js with all methods defined
</verify>
  <done>
AccountPage class exported with addAccount, getAccountCount, isAccountVisible, editAccount, deleteAccount methods
</done>
</task>

<task type="auto">
  <name>Create ProjectionPage class with projection and Monte Carlo operations</name>
  <files>tests/e2e/pages/ProjectionPage.js</files>
  <action>
Create tests/e2e/pages/ProjectionPage.js with:

1. **Constructor with projection-related locators:**
```javascript
constructor(page) {
  this.page = page;
  this.runProjectionButton = page.getByRole('button', { name: 'Run Projection' });
  this.finalBalanceLocator = page.locator('.result-value').filter({ hasText: /^\$[\d,]+$/ });
  this.monteCarloCard = page.locator('.card').filter({ hasText: 'Monte Carlo Analysis' });
  this.successProbabilityBadge = page.locator('.badge').filter({ hasText: /%\)$/ });
  this.balanceChart = page.locator('#balanceChart');
  this.yearByYearTable = page.locator('table');
}
```

2. **Methods:**
   - `runProjection()` - click run button, wait for results
   - `getFinalBalance()` - parse and return final balance value
   - `getSuccessProbability()` - parse and return success probability percentage
   - `isMonteCarloVisible()` - check if Monte Carlo card is visible
   - `isChartVisible()` - check if balance chart is rendered
   - `getYearCount()` - return number of rows in year-by-year table
   - `hasTableCell(text)` - check if table contains specific text (e.g., "Retired")

3. **Note:** Projection requires a plan with accounts to be selected first.

4. **Handle Monte Carlo variance:** Don't assert exact values - provide methods that return values for assertion in tests

5. **Export class** for use in tests
</action>
  <verify>
File exists at tests/e2e/pages/ProjectionPage.js with all methods defined
</verify>
  <done>
ProjectionPage class exported with runProjection, getFinalBalance, getSuccessProbability, isMonteCarloVisible, isChartVisible, getYearCount, hasTableCell methods
</done>
</task>

<task type="auto">
  <name>Add data-testid attributes to UI elements for reliable selectors</name>
  <files>index.html</files>
  <action>
Add data-testid attributes to UI elements that page objects need:

1. **Index.html - Plan modal:**
   - Add `data-testid="plan-name-input"` to `#newPlanName` input
   - Add `data-testid="plan-age-input"` to `#newPlanAge` input
   - Add `data-testid="plan-retirement-age-input"` to `#newPlanRetirementAge` input
   - Add `data-testid="create-plan-button"` to Create button in modal

2. **Index.html - Settings/Delete buttons:** (already have IDs, consider adding testid for clarity)
   - Add `data-testid="settings-button"` to Settings button in header
   - Add `data-testid="delete-plan-button"` to Delete button

3. **AccountController.js - Account form elements:**
   - Add `data-testid="account-name-input"` to `#accountName` input in showAddAccountModal()
   - Add `data-testid="account-type-select"` to `#accountType` select
   - Add `data-testid="account-balance-input"` to `#accountBalance` input
   - Add `data-testid="account-contribution-input"` to `#accountContribution` input
   - Add `data-testid="add-account-button"` to Add button
   - Add `data-testid="account-card"` attribute to account cards in renderAccountsList()

4. **PlanController.js - Tab navigation:**
   - Add `data-testid="tab-{name}"` to each tab button in renderPlanUI()

5. **ProjectionController.js - Projection elements:**
   - Add `data-testid="run-projection-button"` to Run Projection button (or handle via text in index.html)
   - Add `data-testid="final-balance"` to final balance result
   - Add `data-testid="monte-carlo-card"` to Monte Carlo analysis card

Update page objects to use these new data-testid selectors where appropriate.
</action>
  <verify>
grep -r "data-testid" index.html src/ui/AccountController.js src/ui/PlanController.js shows all new attributes
</verify>
  <done>
All interactive elements have data-testid attributes for reliable test selection
</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run smoke test: `npm run test:e2e -- smoke.test.js` - should pass
2. Verify all page objects export correctly: `node -e "import('./tests/e2e/pages/PlanPage.js'); import('./tests/e2e/pages/AccountPage.js'); import('./tests/e2e/pages/ProjectionPage.js');"`
3. Check data-testid coverage: `grep -r "data-testid" index.html src/ui/*.js | wc -l` should show 15+ attributes
4. Verify no CSS class selectors in new page objects: `grep -r "\.card\|\.btn\|\.tab" tests/e2e/pages/` should only find string literals, not locators
</verification>

<success_criteria>
1. Four page object classes exist (AppPage, PlanPage, AccountPage, ProjectionPage)
2. Each page object has methods covering all CRUD operations for its domain
3. All selectors use data-testid or ARIA roles, no CSS classes
4. smoke.test.js continues to pass with enhanced AppPage
5. New data-testid attributes added to 15+ UI elements
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-test-foundation-(page-objects-&-fixtures)/09-01-SUMMARY.md`
</output>
