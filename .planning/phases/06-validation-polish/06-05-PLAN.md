---
phase: 06-validation-polish
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [src/calculations/roth-conversions.js]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'ESLint reports zero no-case-declarations errors'
  artifacts:
    - path: 'src/calculations/roth-conversions.js'
      provides: 'Roth conversion calculations'
      contains: 'Case declarations wrapped in blocks'
  key_links:
    - from: 'src/calculations/roth-conversions.js'
      to: 'eslint.config.js'
      via: 'ESLint no-case-declarations rule'
      pattern: 'switch.*case'
---

<objective>
Fix no-case-declarations errors in roth-conversions.js by wrapping lexical declarations in case blocks.

Purpose: ESLint reports 5 errors for lexical declarations (const) in case blocks without braces. These declarations should be wrapped in blocks to prevent hoisting issues across case statements.
Output: roth-conversions.js with all case block declarations wrapped, zero no-case-declarations errors.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/06-validation-polish/06-VERIFICATION.md

# Gap being closed

ESLint reports 5 no-case-declarations errors in src/calculations/roth-conversions.js:

- Lines 221-222: const bracketTop, const taxableIncome in 'bracket-fill' case
- Lines 233-234: const annualAmount, const rmdRequired in 'fixed' case
- Line 245: const percentage in 'percentage' case

ESLint rule: no-case-declarations
Reason: Lexical declarations in case blocks without braces can lead to unexpected behavior due to hoisting and scoping issues.

Fix pattern: Wrap each case block that contains declarations in curly braces.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix no-case-declarations errors in roth-conversions.js</name>
  <files>src/calculations/roth-conversions.js</files>
  <action>
  Fix 5 no-case-declarations errors by wrapping case blocks with lexical declarations in braces:

1. Read src/calculations/roth-conversions.js
2. Find switch statement around line 219 (starting with switch (strategy))
3. For each case block with lexical declarations, add curly braces:

Case 'bracket-fill' (lines ~219-229):

```javascript
case 'bracket-fill': {
  // Example values for demonstration (actual implementation should use real tax data)
  const bracketTop = 89450 * 100;
  const taxableIncome = 100000 * 100;
  conversionAmount = calculateBracketFillConversion(
    taxableIncome,
    bracketTop,
    totalTraditionalBalance
  );
  reason = 'Fill up to top of tax bracket';
  break;
}
```

Case 'fixed' (lines ~231-242):

```javascript
case 'fixed': {
  // Example annual conversion amount for demonstration
  const annualAmount = 10000 * 100;
  const rmdRequired = age >= 73;
  conversionAmount = calculateFixedConversion(
    annualAmount,
    totalTraditionalBalance,
    age,
    rmdRequired
  );
  reason = 'Fixed annual conversion';
  break;
}
```

Case 'percentage' (lines ~244-248):

```javascript
case 'percentage': {
  const percentage = 0.1;
  conversionAmount = calculatePercentageConversion(percentage, totalTraditionalBalance);
  reason = '10% of traditional balance';
  break;
}
```

Note: Default case (lines 250-253) has no declarations, so no change needed.

4. Verify all 5 no-case-declarations errors are resolved.
   </action>
   <verify>npm run lint 2>&1 | grep "no-case-declarations"</verify>
   <done>ESLint reports zero no-case-declarations errors</done>
   </task>

<task type="auto">
  <name>Task 2: Verify roth-conversions functionality unchanged</name>
  <files>src/calculations/roth-conversions.js, tests/unit/calculations/roth-conversions.test.js</files>
  <action>
  Verify that wrapping case blocks in braces doesn't break functionality:

1. Run: npm test -- tests/unit/calculations/roth-conversions.test.js
2. Check that all tests pass
3. If tests fail, review the changes to ensure logic is identical (only braces added)
   </action>
   <verify>npm test -- tests/unit/calculations/roth-conversions.test.js</verify>
   <done>All roth-conversions tests pass</done>
   </task>

</tasks>

<verification>
1. ESLint reports zero no-case-declarations errors
2. All roth-conversions tests still pass
3. Code behavior unchanged (only braces added for scope)
</verification>

<success_criteria>

- src/calculations/roth-conversions.js updated with curly braces in 3 case blocks
- 5 no-case-declarations errors resolved
- All roth-conversions tests pass
- ESLint reports zero errors for no-case-declarations rule
  </success_criteria>

<output>
After completion, create `.planning/phases/06-validation-polish/06-05-SUMMARY.md`
</output>
